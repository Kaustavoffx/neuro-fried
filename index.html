<!-- 
    PROJECT: NEURO-FRIED
    AUTHOR: KAUSTAV CHOWDHURY
    DATE: DECEMBER 2025
    
    DEV NOTES:
    - The physics in the roulette are tuned for drama, don't mess with the drag coefficients.
    - Glassmorphism is heavy here, might need optimization for mobile later.
    - "Time is the only currency." - K.C.
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEURO-FRIED: FINAL SURVIVAL</title>
    <style>
        /* =========================================
           1. CORE CONFIGURATION
           ========================================= */
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@700&family=VT323&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap');

        :root {
            /* EXTREME BLOODY HORROR THEME */
            --bg-color: #050000;
            --bg-dark: #020000;
            --primary: #ff1a1a;
            --primary-light: #ff6666;
            --secondary: #ff4444;
            --dark-blue: #1a0000;
            --accent: #ffffff;
            --danger: #ff0000;
            --blood: #8b0000;
            --blood-dark: #4a0000;
            --blood-bright: #cc0000;
            --green: #00ff00;
            --text-main: #ffffff;
            --text-dim: #cccccc;
            --particle-col: #ff0000;
            --horror-glow: rgba(255, 0, 0, 0.25);
            --blood-glow: rgba(139, 0, 0, 0.4);

            /* BLOOD-STAINED GLASS - Less opaque for readability */
            --glass-bg: rgba(15, 0, 0, 0.9);
            --glass-border: 1px solid rgba(139, 0, 0, 0.5);
            --glass-blur: blur(30px);
            --glass-shadow: 0 30px 80px rgba(139, 0, 0, 0.4);

            /* FONTS */
            --f-title: 'Orbitron', sans-serif;
            --f-ui: 'Rajdhani', sans-serif;
            --f-mono: 'VT323', monospace;
        }

        /* CATEGORY THEMES */
        body.t-finance {
            --primary: #ffd700;
            --secondary: #50c878;
            --bg-color: #020502;
            --text-main: #fff;
            --particle-col: #fff;
        }

        body.t-code {
            --primary: #00ff00;
            --secondary: #008f11;
            --bg-color: #020502;
            --text-main: #fff;
            --particle-col: #0f0;
        }

        body.t-space {
            --primary: #9d00ff;
            --secondary: #e0b0ff;
            --bg-color: #05000a;
            --text-main: #fff;
            --particle-col: #fff;
        }

        body.t-social {
            --primary: #ff0055;
            --secondary: #ffcc00;
            --bg-color: #0f0202;
            --text-main: #fff;
            --particle-col: #fff;
        }

        body.t-gaming {
            --primary: #ff4400;
            --secondary: #ffee00;
            --bg-color: #0d0500;
            --text-main: #fff;
            --particle-col: #fff;
        }

        /* DUEL MODE THEMES (Day/Night) */
        body.time-day {
            --bg-color: #ffffff;
            --bg-dark: #f0f0f0;
            --primary: #000000;
            --primary-light: #333333;
            --secondary: #666666;
            --current-bg: #ffffff;
            --text-main: #000000;
            --text-dim: #555555;
            --particle-col: #000000;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: 1px solid rgba(0, 0, 0, 0.2);
            --glass-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        body.time-night {
            /* REVERT TO STANDARD HORROR */
            --bg-color: #050000;
            --primary: #ff1a1a;
            --text-main: #ffffff;
            --glass-bg: rgba(15, 0, 0, 0.9);
            transition: background-color 3s ease, color 3s ease;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--f-ui);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.8s ease, color 0.5s ease;
            animation: bgPulse 10s infinite alternate;
        }

        @keyframes bgPulse {
            0% {
                box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.8);
            }

            100% {
                box-shadow: inset 0 0 200px rgba(0, 0, 0, 1);
            }
        }

        /* =============================================
           EXTREME BLOODY HORROR EFFECTS
           ============================================= */

        /* BLOOD RED AMBIENT - Intense glow from all edges */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 50% 0%, rgba(139, 0, 0, 0.6) 0%, transparent 40%),
                radial-gradient(ellipse at 0% 50%, rgba(255, 0, 0, 0.3) 0%, transparent 30%),
                radial-gradient(ellipse at 100% 50%, rgba(255, 0, 0, 0.3) 0%, transparent 30%),
                radial-gradient(ellipse at 50% 100%, rgba(139, 0, 0, 0.5) 0%, transparent 40%),
                radial-gradient(circle at 30% 20%, rgba(200, 0, 0, 0.2) 0%, transparent 20%),
                radial-gradient(circle at 70% 80%, rgba(200, 0, 0, 0.2) 0%, transparent 20%);
            pointer-events: none;
            z-index: 9998;
            animation: bloodPulse 4s ease-in-out infinite alternate;
        }

        @keyframes bloodPulse {
            0% {
                opacity: 0.5;
                filter: brightness(0.9);
            }

            50% {
                opacity: 0.8;
                filter: brightness(1.1);
            }

            100% {
                opacity: 0.6;
                filter: brightness(1);
            }
        }

        /* BLOOD VEINS OVERLAY - Creepy pulsing veins */
        .blood-veins {
            position: fixed;
            inset: 0;
            background:
                linear-gradient(90deg, transparent 49%, rgba(139, 0, 0, 0.1) 50%, transparent 51%),
                linear-gradient(0deg, transparent 49%, rgba(139, 0, 0, 0.1) 50%, transparent 51%);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 9996;
            animation: veinPulse 2s ease-in-out infinite;
            opacity: 0.3;
        }

        @keyframes veinPulse {

            0%,
            100% {
                opacity: 0.2;
            }

            50% {
                opacity: 0.4;
            }
        }

        /* BLOOD DRIP EFFECT - Subtle for readability */
        .blood-drip {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 100vh;
            background:
                linear-gradient(180deg, rgba(139, 0, 0, 0.5) 0%, rgba(139, 0, 0, 0.2) 5%, transparent 12%),
                linear-gradient(180deg, rgba(200, 0, 0, 0.4) 0%, transparent 6%) 20% 0,
                linear-gradient(180deg, rgba(139, 0, 0, 0.3) 0%, transparent 8%) 40% 0,
                linear-gradient(180deg, rgba(180, 0, 0, 0.4) 0%, transparent 7%) 60% 0,
                linear-gradient(180deg, rgba(139, 0, 0, 0.3) 0%, transparent 5%) 80% 0;
            background-size: 100% 100%, 3px 100%, 2px 100%, 4px 100%, 2px 100%;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 9995;
            animation: bloodDripAnim 8s ease-in-out infinite;
            opacity: 0.35;
        }

        @keyframes bloodDripAnim {

            0%,
            100% {
                opacity: 0.3;
                transform: translateY(0);
            }

            30% {
                opacity: 0.6;
            }

            50% {
                opacity: 0.5;
                transform: translateY(5px);
            }

            70% {
                opacity: 0.4;
            }
        }

        /* Scanlines for horror CRT feel */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(0deg,
                    rgba(0, 0, 0, 0.1) 0px,
                    rgba(0, 0, 0, 0.1) 1px,
                    transparent 1px,
                    transparent 3px);
            pointer-events: none;
            z-index: 9997;
            opacity: 0.3;
        }

        /* Screen Shake Effect */
        @keyframes horrorShake {

            0%,
            100% {
                transform: translate(0);
            }

            10% {
                transform: translate(-2px, -1px);
            }

            20% {
                transform: translate(2px, 1px);
            }

            30% {
                transform: translate(-1px, 2px);
            }

            40% {
                transform: translate(1px, -1px);
            }

            50% {
                transform: translate(-2px, 1px);
            }

            60% {
                transform: translate(2px, -2px);
            }

            70% {
                transform: translate(-1px, -1px);
            }

            80% {
                transform: translate(1px, 2px);
            }

            90% {
                transform: translate(-2px, -2px);
            }
        }

        body.horror-shake {
            animation: horrorShake 0.4s ease-in-out;
        }

        /* Anxiety Pulse Effect */
        @keyframes anxietyPulse {

            0%,
            100% {
                box-shadow: inset 0 0 0 0 var(--horror-glow);
            }

            50% {
                box-shadow: inset 0 0 100px 30px var(--horror-glow);
            }
        }

        body.anxiety-mode {
            animation: anxietyPulse 2s ease-in-out infinite;
        }

        /* TYPEWRITER EFFECT STYLES */
        .typewriter-text {
            font-family: var(--f-mono);
            white-space: pre-wrap;
            overflow: hidden;
            border-right: 2px solid var(--primary);
            animation: blinkCursor 0.7s step-end infinite;
        }

        .typewriter-text.done {
            border-right: none;
            animation: none;
        }

        @keyframes blinkCursor {

            0%,
            100% {
                border-color: var(--primary);
            }

            50% {
                border-color: transparent;
            }
        }

        .story-container {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 0, 0, 0.4);
            border-radius: 12px;
            padding: 25px 30px;
            margin: 20px auto;
            max-width: 650px;
            min-height: 100px;
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .story-line {
            color: #ffffff;
            font-family: var(--f-mono);
            font-size: 1.1rem;
            margin-bottom: 12px;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }

        .story-line.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* FADE FROM DARKNESS OVERLAY - Starts hidden */
        .darkness-overlay {
            position: fixed;
            inset: 0;
            background: #000000;
            z-index: 99999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s ease;
        }

        .darkness-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .darkness-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* CLICK TO START SCREEN */
        .click-to-start {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .click-to-start .start-text {
            font-family: var(--f-title);
            font-size: 2rem;
            color: var(--primary);
            animation: pulsate 2s ease-in-out infinite;
            text-shadow: 0 0 30px var(--primary);
        }

        .click-to-start .start-subtext {
            font-family: var(--f-mono);
            font-size: 1rem;
            color: var(--text-dim);
            margin-top: 15px;
            animation: blink 1s ease-in-out infinite;
        }

        .click-to-start .headphones-warning {
            font-family: var(--f-ui);
            font-size: 1.5rem;
            /* Big focused font */
            color: var(--secondary);
            margin-top: 30px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: pulsate 3s ease-in-out infinite;
            text-shadow: 0 0 10px var(--secondary);
            border: 1px solid var(--secondary);
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.5);
        }

        @keyframes pulsate {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        /* Eerie Float Animation */
        @keyframes eerieFloat {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            25% {
                transform: translateY(-3px) rotate(0.3deg);
            }

            50% {
                transform: translateY(-6px) rotate(-0.3deg);
            }

            75% {
                transform: translateY(-3px) rotate(0.2deg);
            }
        }

        /* Glitch Screen Effect */
        @keyframes glitchScreen {
            0% {
                transform: skewX(0) translate(0);
                filter: hue-rotate(0deg);
            }

            20% {
                transform: skewX(-2deg) translate(-2px, 0);
                filter: hue-rotate(30deg);
            }

            40% {
                transform: skewX(2deg) translate(2px, 1px);
            }

            60% {
                transform: skewX(-1deg) translate(-1px, -1px);
                filter: hue-rotate(-20deg);
            }

            80% {
                transform: skewX(1deg) translate(1px, 0);
            }

            100% {
                transform: skewX(0) translate(0);
                filter: hue-rotate(0deg);
            }
        }

        body.glitch-active {
            animation: glitchScreen 0.3s ease-in-out;
        }

        /* Blood Drip from Top */
        @keyframes bloodDrip {
            0% {
                transform: scaleY(0);
                opacity: 0;
            }

            10% {
                opacity: 0.6;
            }

            100% {
                transform: scaleY(1);
                opacity: 0;
            }
        }

        /* LAYERS & VFX */
        #render-layer {
            position: fixed;
            inset: 0;
            z-index: 0;
        }

        .vignette {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            /* STRONGER VIGNETTE */
            background: radial-gradient(circle, transparent 30%, rgba(0, 0, 0, 0.9) 100%);
        }

        .scanlines {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 2;
            opacity: 0.15;
            background: linear-gradient(to bottom, rgba(128, 128, 128, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
        }

        .fx-overlay {
            position: fixed;
            inset: 0;
            z-index: 900;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .fx-rewind {
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255, 255, 255, 0.2) 3px);
            mix-blend-mode: overlay;
        }

        .fx-freeze {
            background: rgba(0, 243, 255, 0.1);
            box-shadow: inset 0 0 100px var(--secondary);
            backdrop-filter: grayscale(100%) blur(4px);
        }

        /* Timer Panel Freeze Effect */
        #timer-panel.frozen {
            position: relative;
            animation: timerFreezeGlow 1s infinite alternate;
        }

        #timer-panel.frozen::before {
            content: '❄️ FROZEN';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--f-title);
            font-size: 0.9rem;
            color: #00f3ff;
            text-shadow: 0 0 15px #00f3ff, 0 0 30px #00f3ff;
            letter-spacing: 3px;
            z-index: 10;
            animation: freezeTextPulse 0.5s infinite alternate;
        }

        #timer-panel.frozen::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 200, 255, 0.15);
            backdrop-filter: blur(2px);
            border-radius: 8px;
            box-shadow:
                inset 0 0 30px rgba(0, 243, 255, 0.4),
                0 0 20px rgba(0, 243, 255, 0.5),
                0 0 40px rgba(0, 200, 255, 0.3);
            z-index: 5;
        }

        #timer-panel.frozen .stat-val,
        #timer-panel.frozen .stat-label,
        #timer-panel.frozen .time-bar-container {
            opacity: 0.3;
        }

        @keyframes timerFreezeGlow {
            0% {
                box-shadow: 0 0 20px rgba(0, 243, 255, 0.5), inset 0 0 15px rgba(0, 200, 255, 0.2);
            }

            100% {
                box-shadow: 0 0 40px rgba(0, 243, 255, 0.8), inset 0 0 25px rgba(0, 200, 255, 0.4);
            }
        }

        @keyframes freezeTextPulse {
            0% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1);
            }

            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05);
            }
        }

        /* Rewind Effect Logic */
        body.is-rewinding .fx-rewind {
            opacity: 1 !important;
            animation: glitchEffect 0.2s infinite;
        }

        /* UI FRAMEWORK */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 9999;
            /* Above everything to ensure clicks work */
            backdrop-filter: blur(10px);
        }

        .brand {
            font-family: var(--f-title);
            font-size: 1.4rem;
            letter-spacing: 2px;
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary);
        }

        #theme-toggle {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        /* =============================================
           TOGGLE BUTTONS - SOUND & THEME
           Time-themed rewind/loop design
           ============================================= */
        .toggle-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            pointer-events: auto;
            /* Enable clicks */
            z-index: 10000;
        }

        .toggle-btn {
            position: relative;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 5, 0.9);
            border: 2px solid var(--primary);
            color: var(--primary);
            cursor: pointer;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.3);
            overflow: hidden;
            z-index: 1000;
            /* Ensure buttons are on top */
        }

        .toggle-btn::before {
            content: '';
            position: absolute;
            inset: 3px;
            border-radius: 50%;
            border: 1px dashed rgba(79, 70, 229, 0.4);
            animation: rotateRing 10s linear infinite;
            pointer-events: none;
            /* Don't block clicks */
        }

        @keyframes rotateRing {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .toggle-btn:hover {
            background: rgba(79, 70, 229, 0.2);
            box-shadow: 0 0 30px rgba(79, 70, 229, 0.5);
            transform: scale(1.1);
        }

        .toggle-btn:active {
            transform: scale(0.95);
        }

        /* Sound OFF state */
        .toggle-btn.sound-off {
            border-color: var(--danger);
            color: var(--danger);
            box-shadow: 0 0 15px rgba(255, 0, 60, 0.3);
        }

        .toggle-btn.sound-off::before {
            border-color: rgba(255, 0, 60, 0.4);
            animation-direction: reverse;
        }

        /* Theme button - rotating icon */
        .toggle-btn.theme-btn .icon {
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toggle-btn.theme-btn:hover .icon {
            transform: rotate(180deg);
        }

        /* =============================================
           DARK MONOCHROME THEME - Black/Ash/White only
           ============================================= */
        body.theme-dark {
            --primary: #a0a0a0 !important;
            --primary-light: #c0c0c0 !important;
            --secondary: #808080 !important;
            --dark-blue: #1a1a1a !important;
            --danger: #606060 !important;
            --green: #d0d0d0 !important;
        }

        /* Dark theme - toggle buttons */
        body.theme-dark .toggle-btn:not(.sound-off) {
            border-color: #a0a0a0 !important;
            color: #a0a0a0 !important;
            box-shadow: 0 0 15px rgba(160, 160, 160, 0.2) !important;
        }

        body.theme-dark .toggle-btn::before {
            border-color: rgba(160, 160, 160, 0.3) !important;
        }

        body.theme-dark .brand {
            color: #c0c0c0 !important;
            text-shadow: 0 0 10px rgba(200, 200, 200, 0.5) !important;
        }

        /* Dark theme - tech buttons */
        body.theme-dark .tech-btn {
            color: #a0a0a0 !important;
            border-color: #a0a0a0 !important;
            box-shadow: 0 0 20px rgba(160, 160, 160, 0.2), inset 0 0 20px rgba(160, 160, 160, 0.05) !important;
        }

        body.theme-dark .tech-btn:hover {
            background: #a0a0a0 !important;
            color: #000000 !important;
        }

        /* Dark theme - title glow */
        body.theme-dark .glitch-title {
            text-shadow: 0 0 30px rgba(200, 200, 200, 0.5) !important;
            color: #ffffff !important;
        }

        /* Dark theme - HUD panels */
        body.theme-dark .hud-panel {
            border-color: rgba(100, 100, 100, 0.3) !important;
            background: rgba(15, 15, 15, 0.95) !important;
        }

        /* Dark theme - glass elements */
        body.theme-dark .roulette-box,
        body.theme-dark .timeline-box,
        body.theme-dark .mission-log {
            border-color: rgba(100, 100, 100, 0.3) !important;
            background: rgba(15, 15, 15, 0.95) !important;
        }

        /* Dark theme - option buttons */
        body.theme-dark .opt-btn {
            border-color: #606060 !important;
            color: #c0c0c0 !important;
        }

        body.theme-dark .opt-btn:hover {
            border-color: #a0a0a0 !important;
            background: rgba(160, 160, 160, 0.1) !important;
        }

        /* Dark theme - game over screen */
        body.theme-dark #s-over {
            background: linear-gradient(180deg, #000000 0%, #0a0a0a 50%, #000000 100%) !important;
        }

        /* Dark theme - win modal */
        body.theme-dark .win-modal {
            background: linear-gradient(180deg, #000000 0%, #0a0a0a 50%, #000000 100%) !important;
        }

        /* Dark theme - share card wrapper */
        body.theme-dark .share-card-wrapper {
            background: linear-gradient(135deg, #404040, #606060, #404040) !important;
        }

        /* Dark theme - time bar */
        body.theme-dark .time-bar {
            background: linear-gradient(90deg, #505050, #a0a0a0) !important;
        }

        /* Dark theme - scanline effect toned down */
        body.theme-dark .vignette {
            background: radial-gradient(circle, transparent 30%, rgba(0, 0, 0, 0.95) 100%) !important;
        }

        /* HUD - REDESIGNED */
        .hud-panel {
            position: absolute;
            z-index: 50;
            padding: 15px 25px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: 8px;
            box-shadow: var(--glass-shadow);
            transition: 0.3s;
        }

        .hud-top-right {
            top: 90px;
            right: 40px;
            border-right: 4px solid var(--primary);
            text-align: right;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-main);
            margin-bottom: 5px;
            letter-spacing: 2px;
            font-weight: bold;
            opacity: 0.7;
        }

        .stat-val {
            font-family: var(--f-title);
            font-size: 2.2rem;
            color: var(--primary);
        }

        /* LIVES INDICATOR */
        .lives-container {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            margin-top: 5px;
        }

        .life-pip {
            width: 15px;
            height: 15px;
            background: var(--secondary);
            transform: skewX(-20deg);
            box-shadow: 0 0 10px var(--secondary);
        }

        .life-pip.lost {
            background: #333;
            box-shadow: none;
            border: 1px solid #555;
        }

        /* BIG FREEZE BUTTON (Left) */
        .freeze-container {
            position: absolute;
            bottom: 40px;
            left: 40px;
            z-index: 60;
        }

        .big-freeze-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(0, 243, 255, 0.1);
            border: 2px solid var(--secondary);
            color: var(--secondary);
            font-family: var(--f-title);
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: pulseFreeze 3s infinite;
        }

        .big-freeze-btn span {
            font-size: 0.8rem;
            font-family: var(--f-mono);
            margin-top: 5px;
            opacity: 0.7;
        }

        .big-freeze-btn:hover {
            transform: scale(1.1);
            background: var(--secondary);
            color: black;
            box-shadow: 0 0 60px var(--secondary);
        }

        .big-freeze-btn.used {
            filter: grayscale(1);
            opacity: 0.5;
            cursor: not-allowed;
            animation: none;
        }

        @keyframes pulseFreeze {
            0% {
                box-shadow: 0 0 0 rgba(0, 243, 255, 0);
            }

            50% {
                box-shadow: 0 0 40px rgba(0, 243, 255, 0.4);
            }

            100% {
                box-shadow: 0 0 0 rgba(0, 243, 255, 0);
            }
        }

        .btn-hud-rewind {
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
            animation: pulseRewind 3s infinite;
            margin-top: 20px;
        }

        .btn-hud-rewind:hover {
            background: var(--primary);
            color: black;
            box-shadow: 0 0 60px var(--primary);
            transform: scale(1.1);
        }

        @keyframes pulseRewind {
            0% {
                box-shadow: 0 0 0 rgba(0, 243, 255, 0);
            }

            50% {
                box-shadow: 0 0 40px rgba(0, 243, 255, 0.4);
            }

            100% {
                box-shadow: 0 0 0 rgba(0, 243, 255, 0);
            }
        }

        /* FAIL MODAL (The Main Event) */
        .fail-modal {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .fail-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .fail-title {
            font-family: var(--f-title);
            font-size: 4rem;
            color: var(--danger);
            text-shadow: 0 0 40px var(--danger);
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 4px;
        }

        .fail-sub {
            font-family: var(--f-mono);
            font-size: 1.2rem;
            color: white;
            margin-bottom: 50px;
            text-align: center;
            letter-spacing: 2px;
        }

        .fail-btn-row {
            display: flex;
            gap: 40px;
        }

        .fail-btn {
            padding: 30px 60px;
            font-family: var(--f-title);
            font-size: 1.5rem;
            border: 2px solid;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
            background: transparent;
            letter-spacing: 2px;
            border-radius: 8px;
        }

        .btn-rewind {
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 30px var(--primary);
        }

        .btn-rewind:hover {
            background: var(--primary);
            color: black;
            transform: scale(1.05);
        }

        .btn-exit {
            border-color: var(--danger);
            color: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }

        .btn-exit:hover {
            background: var(--danger);
            color: white;
            transform: scale(1.05);
        }

        /* SCREENS */
        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            padding-top: 60px;
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .hidden {
            display: none !important;
            opacity: 0 !important;
        }

        /* LANDING */
        .glitch-title {
            font-family: var(--f-title);
            font-size: 8vw;
            color: var(--text-main);
            margin: 0;
            text-transform: uppercase;
            text-shadow: 0 0 30px var(--primary);
            animation: float 4s ease-in-out infinite, titleGlitch 8s infinite;
            position: relative;
        }

        /* Chromatic aberration layers */
        .glitch-title::before,
        .glitch-title::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.5;
        }

        .glitch-title::before {
            color: #ff4d6d;
            animation: glitchLeft 3s infinite;
            clip-path: polygon(0 0, 100% 0, 100% 35%, 0 35%);
            transform: translateX(-2px);
            text-shadow: 0 0 8px rgba(255, 77, 109, 0.4);
        }

        .glitch-title::after {
            color: #60a5fa;
            animation: glitchRight 2.5s infinite;
            clip-path: polygon(0 65%, 100% 65%, 100% 100%, 0 100%);
            transform: translateX(2px);
            text-shadow: 0 0 8px rgba(96, 165, 250, 0.4);
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes titleGlitch {

            0%,
            90%,
            100% {
                opacity: 1;
                filter: none;
            }

            91% {
                opacity: 0.8;
                filter: blur(1px);
                transform: translateY(-10px) skewX(2deg);
            }

            92% {
                opacity: 1;
                filter: none;
                transform: translateY(-10px) skewX(0);
            }

            93% {
                opacity: 0.9;
                transform: translateY(-10px) skewX(-1deg);
            }

            94% {
                opacity: 1;
                transform: translateY(-10px);
            }
        }

        @keyframes glitchLeft {

            0%,
            94%,
            100% {
                transform: translateX(-2px);
                opacity: 0;
            }

            95% {
                transform: translateX(-5px);
                opacity: 0.7;
            }

            96% {
                transform: translateX(-2px);
                opacity: 0.4;
            }

            97% {
                transform: translateX(-8px);
                opacity: 0.6;
            }

            98% {
                transform: translateX(-2px);
                opacity: 0;
            }
        }

        @keyframes glitchRight {

            0%,
            92%,
            100% {
                transform: translateX(2px);
                opacity: 0;
            }

            93% {
                transform: translateX(6px);
                opacity: 0.6;
            }

            94% {
                transform: translateX(2px);
                opacity: 0.3;
            }

            95% {
                transform: translateX(10px);
                opacity: 0.5;
            }

            96% {
                transform: translateX(2px);
                opacity: 0;
            }
        }

        .mission-log {
            font-family: var(--f-mono);
            color: var(--text-main);
            opacity: 0.8;
            background: var(--glass-bg);
            border: var(--glass-border);
            padding: 25px 40px;
            border-radius: 12px;
            margin-bottom: 40px;
            text-align: left;
            max-width: 600px;
            border-left: 3px solid var(--primary);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
        }

        .tech-btn {
            position: relative;
            z-index: 10000;
            background: rgba(20, 0, 0, 0.8);
            color: var(--primary);
            border: 2px solid #000000;
            padding: 22px 55px;
            font-family: var(--f-title);
            font-size: 1.3rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s ease;
            letter-spacing: 3px;
            border-radius: 4px;
            pointer-events: auto;
            overflow: hidden;
            animation: btnPulse 2s infinite;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.4), inset 0 0 20px rgba(139, 0, 0, 0.2);
        }

        /* BLACK SCANNING LINE effect */
        .tech-btn::before {
            content: '';
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.6), transparent);
            animation: btnScan 2s linear infinite;
        }

        .tech-btn::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: repeating-linear-gradient(0deg,
                    transparent 0px,
                    transparent 3px,
                    rgba(0, 0, 0, 0.1) 3px,
                    rgba(0, 0, 0, 0.1) 5px);
            border: 1px solid rgba(139, 0, 0, 0.3);
            border-radius: 2px;
            pointer-events: none;
        }

        @keyframes btnPulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(139, 0, 0, 0.4), inset 0 0 20px rgba(139, 0, 0, 0.2);
            }

            50% {
                box-shadow: 0 0 40px rgba(200, 0, 0, 0.6), inset 0 0 30px rgba(139, 0, 0, 0.3);
            }
        }

        @keyframes btnScan {
            0% {
                top: -100%;
            }

            100% {
                top: 100%;
            }
        }

        .tech-btn:hover {
            background: var(--primary);
            color: var(--bg-color);
            box-shadow: 0 0 60px var(--primary), 0 0 100px rgba(79, 70, 229, 0.5);
            transform: scale(1.05);
            text-shadow: 0 0 10px var(--bg-color);
        }

        .tech-btn:hover::before {
            animation: none;
            opacity: 0;
        }

        /* Danger variant buttons (REROLL, etc) - red effects */
        .tech-btn[style*="danger"] {
            box-shadow: 0 0 20px rgba(255, 0, 60, 0.3), inset 0 0 20px rgba(255, 0, 60, 0.1);
            animation: btnPulseDanger 2s infinite;
        }

        .tech-btn[style*="danger"]::before {
            background: linear-gradient(transparent, rgba(255, 0, 60, 0.4), transparent);
        }

        .tech-btn[style*="danger"]::after {
            border: 1px solid rgba(255, 0, 60, 0.3);
        }

        @keyframes btnPulseDanger {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(255, 0, 60, 0.3), inset 0 0 20px rgba(255, 0, 60, 0.1);
            }

            50% {
                box-shadow: 0 0 40px rgba(255, 0, 60, 0.6), inset 0 0 30px rgba(255, 0, 60, 0.2);
            }
        }

        .tech-btn[style*="danger"]:hover {
            background: var(--danger);
            box-shadow: 0 0 60px var(--danger), 0 0 100px rgba(255, 0, 60, 0.5);
        }

        /* MADE WITH LOVE ANIMATION */
        .made-with-love {
            position: absolute;
            bottom: 30px;
            font-family: var(--f-mono);
            font-size: 2.9rem;
            color: #666;
            width: 100%;
            text-align: center;
            pointer-events: none;
            animation: heartbeat 2s infinite ease-in-out;
            letter-spacing: 1px;
        }

        @keyframes heartbeat {

            0%,
            100% {
                opacity: 0.6;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
                color: var(--danger);
                text-shadow: 0 0 10px var(--danger);
            }
        }

        /* GAMEPLAY */
        /* CRT POWER OFF */
        .power-off-anim {
            animation: powerOff 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }

        @keyframes powerOff {
            0% {
                transform: scale(1);
                filter: brightness(1) blur(0);
            }

            40% {
                transform: scale(1, 0.002);
                filter: brightness(30) blur(5px);
            }

            100% {
                transform: scale(0, 0);
                filter: brightness(0);
                opacity: 0;
            }
        }

        .game-grid {
            width: 90%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .opt-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }

        .opt-btn {
            flex: 1 1 45%;
            /* Grow to fill, base 45% */
            min-width: 300px;
        }

        /* PROTOCOL INTERACTION */
        .protocol-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
            perspective: 1000px;
            cursor: pointer;
        }

        .protocol-trigger {
            font-family: var(--f-mono);
            color: var(--secondary);
            letter-spacing: 3px;
            padding: 10px 20px;
            border: 1px solid transparent;
            transition: 0.3s;
            position: relative;
            z-index: 20;
            text-shadow: 0 0 10px var(--secondary);
            animation: pulse-trigger 2s infinite;
        }

        @keyframes pulse-trigger {
            0% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
                text-shadow: 0 0 20px var(--secondary);
            }

            100% {
                opacity: 0.7;
            }
        }

        .protocol-container:hover .protocol-trigger {
            color: var(--primary);
            border: 1px solid var(--primary);
            background: rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
            animation: none;
        }

        .mission-log {
            font-family: var(--f-mono);
            color: var(--text-main);
            background: var(--glass-bg);
            border: var(--glass-border);
            padding: 0 40px;
            /* Collapsed padding */
            border-radius: 12px;
            text-align: left;
            max-width: 600px;
            border-left: 3px solid var(--primary);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);

            /* Hidden State */
            max-height: 0;
            opacity: 0;
            transform: rotateX(-20deg) translateY(-20px);
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            overflow: hidden;
            pointer-events: none;
        }

        .protocol-container:hover .mission-log {
            /* Expanded State */
            max-height: 500px;
            opacity: 1;
            transform: rotateX(0deg) translateY(20px);
            padding: 25px 40px;
            pointer-events: all;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        /* Typing effect for lines? Maybe too complex for CSS only, keep it clean first */
        .protocol-line {
            opacity: 0;
            transform: translateX(-20px);
            transition: 0.3s;
        }

        .protocol-container:hover .protocol-line {
            opacity: 1;
            transform: translateX(0);
        }

        .protocol-container:hover .protocol-line:nth-child(1) {
            transition-delay: 0.1s;
        }

        .protocol-container:hover .protocol-line:nth-child(2) {
            transition-delay: 0.2s;
        }

        .protocol-container:hover .protocol-line:nth-child(3) {
            transition-delay: 0.3s;
        }

        .protocol-container:hover .protocol-line:nth-child(4) {
            transition-delay: 0.4s;
        }

        .protocol-container:hover .protocol-line:nth-child(5) {
            transition-delay: 0.5s;
        }

        /* OUTRO SEQUENCE */
        .outro-text {
            font-family: var(--f-title);
            font-size: 8vw;
            color: white;
            opacity: 0;
            transform: scale(0.8);
            position: absolute;
            width: 100%;
            text-align: center;
        }

        .anim-in {
            animation: outroIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .anim-out {
            animation: outroOut 0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
        }

        @keyframes outroIn {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes outroOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(1.5);
            }
        }

        /* HYPE INTRO */
        .hype-num {
            font-size: 15vw;
            font-family: var(--f-title);
            color: var(--primary);
            text-shadow: 0 0 50px var(--primary);
            animation: zoomFade 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards;
            opacity: 0;
            transform: scale(3);
        }

        .glitch-text {
            color: var(--accent);
            letter-spacing: 5px;
            text-align: center;
            margin-top: 20px;
            animation: glitchText 0.3s infinite;
        }

        @keyframes glitchText {
            0% {
                transform: translate(2px, 0);
            }

            50% {
                transform: translate(-2px, 0);
            }

            100% {
                transform: translate(2px, 0);
            }
        }

        /* ROULETTE (HORIZONTAL) */
        .roulette-window {
            height: 120px;
            /* Shorter height for horizontal strip */
            width: 100%;
            overflow: hidden;
            position: relative;
            /* Side fades instead of top/bottom */
            mask-image: linear-gradient(90deg, transparent, black 20%, black 80%, transparent);
            -webkit-mask-image: linear-gradient(90deg, transparent, black 20%, black 80%, transparent);
            margin-bottom: 30px;
            display: flex;
            /* Center track vertically */
            align-items: center;
        }

        .roulette-track {
            display: flex;
            flex-direction: row;
            align-items: center;
            /* Center alignment is handled by the initial scroll calculations */
            padding-left: 50%;
            will-change: transform;
        }

        .roulette-item {
            flex: 0 0 180px;
            /* Slightly narrower to allow gaps */
            margin: 0 10px;
            /* Spacing between cards */
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--f-title);
            font-size: 1.2rem;
            /* Adjusted for card size */
            color: var(--text-main);

            /* Card Look */
            background: rgba(0, 243, 255, 0.05);
            /* Subtle glass */
            border: 1px solid rgba(0, 243, 255, 0.2);
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);

            /* Default state (will be overridden by JS) */
            opacity: 0.3;
            transform: scale(0.7);
            filter: blur(2px);
            transition: border-color 0.2s, background-color 0.2s;
            /* Color transitions only, transform is manual */
            white-space: normal;
            /* Allow text wrap if needed */
            text-align: center;
            line-height: 1.1;
            padding: 10px;
        }

        .roulette-item.locked {
            border-color: var(--primary);
            background: rgba(0, 243, 255, 0.2);
            color: var(--primary);
            box-shadow: 0 0 30px var(--primary);
            z-index: 100 !important;
        }

        /* ANOMALIES & STREAKS */
        .anomaly-mirror .q-card,
        .anomaly-mirror .opt-btn {
            transform: scaleX(-1);
        }

        .anomaly-alert {
            position: fixed;
            top: 30%;
            width: 100%;
            text-align: center;
            font-family: var(--f-title);
            font-size: 2rem;
            color: var(--danger);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            z-index: 9999;
            animation: flashWarn 0.5s 2 forwards;
            pointer-events: none;
            border-top: 2px solid var(--danger);
            border-bottom: 2px solid var(--danger);
        }

        @keyframes flashWarn {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .pulse-text {
            animation: pulseTxt 0.5s infinite alternate;
            color: var(--green) !important;
            text-shadow: 0 0 10px var(--green);
        }

        @keyframes pulseTxt {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(1.1);
            }
        }

        @media (max-width: 900px) {
            .opt-grid {
                grid-template-columns: 1fr;
            }

            h1.glitch-title {
                font-size: 12vw;
            }

            .roulette-box {
                min-width: 90%;
                padding: 30px;
            }

            .fail-btn-row {
                flex-direction: column;
            }

            .freeze-container {
                bottom: 20px;
                left: 20px;
            }
        }

        /* RETRO COIN */
        .coin-cont {
            width: 40px;
            height: 40px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
            perspective: 1000px;
        }

        .retro-coin {
            width: 100%;
            height: 100%;
            background: #ffd700;
            border-radius: 50%;
            border: 4px solid #b8860b;
            box-shadow: inset 0 0 10px #fff7cc, 0 0 10px rgba(255, 215, 0, 0.7);
            position: relative;
            animation: spinCoin 3s linear infinite;
            transform-style: preserve-3d;
        }

        .retro-coin::after {
            content: '$';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--f-mono);
            font-weight: bold;
            color: #b8860b;
            font-size: 1.2rem;
            transform: translateZ(1px);
        }

        @keyframes spinCoin {
            0% {
                transform: rotateY(0deg);
            }

            100% {
                transform: rotateY(360deg);
            }
        }

        .score-sparkle {
            position: absolute;
            pointer-events: none;
            animation: sparkleFloat 1s forwards;
            color: #ffd700;
            font-family: var(--f-mono);
            font-weight: bold;
            font-size: 1.5rem;
            text-shadow: 0 0 5px #fff;
        }

        @keyframes sparkleFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-50px) scale(0);
            }
        }

        .timer-rail {
            width: 100%;
            height: 6px;
            background: rgba(128, 128, 128, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .timer-fill {
            width: 100%;
            height: 100%;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            transition: width 0.1s linear, background 0.3s;
        }

        .q-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            padding: 50px;
            text-align: center;
            border-radius: 16px;
            border: var(--glass-border);
            position: relative;
            box-shadow: var(--glass-shadow);
        }

        .era-tag {
            font-family: var(--f-title);
            color: var(--secondary);
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: block;
            letter-spacing: 4px;
            opacity: 0.8;
        }

        .q-text {
            font-size: 2rem;
            line-height: 1.4;
            color: var(--text-main);
            font-weight: bold;
        }

        .opt-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .opt-btn {
            background: rgba(255, 255, 255, 0.03);
            border: var(--glass-border);
            padding: 30px;
            font-family: var(--f-ui);
            font-size: 1.3rem;
            color: var(--text-main);
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
            border-radius: 8px;
        }

        .opt-btn:hover {
            background: rgba(0, 243, 255, 0.1);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-3px);
        }

        /* ROULETTE & TIMELINE */
        .roulette-box {
            background: var(--glass-bg);
            padding: 60px;
            border: var(--glass-border);
            text-align: center;
            border-radius: 16px;
            min-width: 500px;
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
        }

        #roulette-display {
            font-family: var(--f-title);
            font-size: 3.5rem;
            color: var(--primary);
            margin: 40px 0;
            text-shadow: 0 0 20px var(--primary);
            min-height: 80px;
        }

        .locked-topic {
            animation: flashLock 0.5s;
            color: var(--accent) !important;
            text-shadow: 0 0 40px var(--accent) !important;
            scale: 1.2;
            transition: 0.3s;
        }

        @keyframes flashLock {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
                filter: brightness(2);
            }

            100% {
                transform: scale(1);
            }
        }

        .timeline-box {
            background: var(--glass-bg);
            padding: 50px;
            border: var(--glass-border);
            text-align: center;
            max-width: 700px;
            border-radius: 16px;
            box-shadow: var(--glass-shadow);
            border-top: 3px solid var(--primary);
        }

        .btn-row {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 30px;
        }

        /* OVER (MATCHING IMAGE 2/4) */
        .share-card {
            margin-bottom: 30px;
            border: 4px solid var(--primary);
            width: 320px;
            height: 480px;
            position: relative;
            background: #000;
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.5);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 300px;
        }

        /* FX */
        body.is-rewinding {
            animation: vhs-glitch 0.2s infinite;
            filter: invert(1) hue-rotate(180deg);
        }

        body.is-rewinding .fx-rewind {
            opacity: 1;
        }

        @keyframes vhs-glitch {
            0% {
                transform: translate(2px, 0);
            }

            20% {
                transform: translate(-2px, 0);
            }

            40% {
                transform: translate(1px, 1px);
            }

            60% {
                transform: translate(-1px, -1px);
            }
        }

        body.is-frozen .fx-freeze {
            opacity: 1;
        }

        body.paradox-hit {
            animation: chromaticPulse 0.3s ease-out;
        }

        @keyframes chromaticPulse {
            0% {
                transform: scale(1);
                text-shadow: none;
                filter: brightness(1);
            }

            50% {
                transform: scale(1.02);
                text-shadow: 3px 0 var(--danger), -3px 0 var(--primary);
                filter: brightness(1.2);
            }

            100% {
                transform: scale(1);
                text-shadow: none;
                filter: brightness(1);
            }
        }

        @media (max-width: 900px) {
            .opt-grid {
                grid-template-columns: 1fr;
            }

            h1.glitch-title {
                font-size: 15vw;
                /* Larger on mobile for impact */
            }

            .roulette-box {
                min-width: 90%;
                padding: 30px;
            }

            .fail-btn-row {
                flex-direction: column;
                gap: 20px;
            }

            .freeze-container {
                bottom: 20px;
                left: 20px;
            }

            /* Responsive HUD */
            .hud-top-right {
                top: auto;
                bottom: 20px;
                /* Move score to bottom on mobile */
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
            }

            .big-freeze-btn {
                width: 80px;
                height: 80px;
                font-size: 0.9rem;
            }

            /* Touch Targets */
            .tech-btn,
            .opt-btn {
                min-height: 60px;
                /* Thumbs are fat */
            }

            .outro-text {
                font-size: 12vw;
            }
        }

        @media (max-width: 450px) {
            .mission-log {
                font-size: 0.8rem;
                padding: 15px;
            }

            .hud-panel {
                transform: scale(0.9);
                transform-origin: bottom right;
            }
        }

        /* =========================================
           MOBILE BLOCKER
           ========================================= */
        .mobile-blocker {
            position: fixed;
            inset: 0;
            z-index: 99999;
            background: linear-gradient(180deg, #000005 0%, #0a0a1a 50%, #000005 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
        }

        .mobile-blocker.active {
            display: flex;
        }

        .mobile-blocker h1 {
            font-family: var(--f-title);
            font-size: 1.8rem;
            color: var(--danger);
            margin-bottom: 20px;
            text-shadow: 0 0 20px var(--danger);
        }

        .mobile-blocker p {
            font-family: var(--f-mono);
            color: var(--text-dim);
            max-width: 350px;
            line-height: 1.6;
        }

        .mobile-blocker .desktop-icon {
            font-size: 5rem;
            margin-top: 30px;
            animation: float 3s ease-in-out infinite;
        }

        /* =========================================
           LUCK RANDOMIZER SCREEN
           ========================================= */
        .luck-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .luck-slots {
            display: flex;
            gap: 20px;
        }

        .luck-slot {
            width: 100px;
            height: 130px;
            background: var(--glass-bg);
            border: 2px solid var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--f-title);
            font-size: 2.5rem;
            color: var(--primary);
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.3), inset 0 0 30px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .luck-slot.spinning {
            animation: slotGlow 0.15s infinite alternate;
        }

        .luck-slot.selected {
            border-color: var(--green);
            color: var(--green);
            box-shadow: 0 0 40px rgba(57, 255, 20, 0.5), inset 0 0 20px rgba(57, 255, 20, 0.1);
            transform: scale(1.1);
        }

        @keyframes slotGlow {
            0% {
                box-shadow: 0 0 20px rgba(79, 70, 229, 0.3);
            }

            100% {
                box-shadow: 0 0 40px rgba(79, 70, 229, 0.6);
            }
        }

        .luck-result {
            font-family: var(--f-title);
            font-size: 1.8rem;
            color: var(--primary);
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .luck-result .mode-desc {
            font-family: var(--f-mono);
            font-size: 1rem;
            color: var(--text-dim);
        }

        .luck-box {
            background: var(--glass-bg);
            padding: 50px;
            border: var(--glass-border);
            text-align: center;
            border-radius: 16px;
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
        }

        /* =========================================
           MODE B: TIME LOOP / DREAM MODE
           ========================================= */
        body.mode-dream {
            animation: dreamPulse 3s infinite alternate;
        }

        body.mode-dream .game-grid {
            filter: hue-rotate(15deg) saturate(1.1);
        }

        body.mode-dream .q-card {
            animation: dreamGlitchSubtle 5s infinite;
        }

        @keyframes dreamPulse {
            0% {
                filter: brightness(1) saturate(1);
            }

            100% {
                filter: brightness(1.05) saturate(1.15);
            }
        }

        @keyframes dreamGlitchSubtle {

            0%,
            95%,
            100% {
                transform: translate(0);
            }

            96% {
                transform: translate(-2px, 1px);
            }

            97% {
                transform: translate(2px, -1px);
            }

            98% {
                transform: translate(-1px, -1px);
            }

            99% {
                transform: translate(1px, 1px);
            }
        }

        .dream-overlay {
            position: fixed;
            inset: 0;
            z-index: 5000;
            background: rgba(0, 0, 0, 0.97);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .dream-overlay.active {
            display: flex;
        }

        .dream-text {
            font-family: var(--f-title);
            font-size: 3.5rem;
            color: var(--primary);
            animation: dreamTextGlow 1.5s infinite alternate;
            text-align: center;
        }

        .dream-subtext {
            font-family: var(--f-mono);
            color: var(--text-dim);
            margin-top: 20px;
            font-size: 1.2rem;
        }

        @keyframes dreamTextGlow {
            0% {
                text-shadow: 0 0 20px var(--primary);
                opacity: 0.7;
            }

            100% {
                text-shadow: 0 0 60px var(--primary), 0 0 100px var(--primary);
                opacity: 1;
            }
        }

        /* =========================================
           MODE C: TIMELINE DUEL (SPLIT SCREEN)
           ========================================= */
        .duel-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            width: 100%;
            max-width: 1400px;
            padding: 20px;
            margin-top: 60px;
            border-radius: 16px;
            /* Ensure Grid is used for side-by-side */
            align-items: stretch;

            /* 'High' Feel - Floating intensity */
            animation: highFloat 6s ease-in-out infinite;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes highFloat {

            0%,
            100% {
                transform: translateY(0);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }

            50% {
                transform: translateY(-10px);
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
                border-color: rgba(255, 255, 255, 0.3);
            }
        }

        .duel-side {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 25px;
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }

        .duel-side.player {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.2);
        }

        .duel-side.ai {
            background: rgba(0, 0, 0, 0.95);
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.2);
            opacity: 0.9;
        }

        .duel-side.ai .opt-btn {
            pointer-events: none;
        }

        .duel-label {
            font-family: var(--f-title);
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }

        .duel-side.player .duel-label {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .duel-side.ai .duel-label {
            color: var(--secondary);
            border-bottom: 2px solid var(--secondary);
        }

        .duel-side .opt-grid {
            grid-template-columns: 1fr;
        }

        .duel-side .opt-btn {
            padding: 20px;
            font-size: 1.1rem;
        }

        /* Day/Night Theme Transitions */
        body.time-day {
            --bg-color: #0a0a15;
            animation: dayAmbient 4s infinite alternate;
        }

        body.time-day::before {
            content: '☀️ DAY';
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--f-title);
            font-size: 1rem;
            color: #ffd700;
            text-shadow: 0 0 20px #ffd700;
            z-index: 100;
            letter-spacing: 3px;
        }

        body.time-night::before {
            content: '🌙 NIGHT';
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--f-title);
            font-size: 1rem;
            color: var(--secondary);
            text-shadow: 0 0 20px var(--secondary);
            z-index: 100;
            letter-spacing: 3px;
            animation: nightPulseText 1s infinite alternate;
        }

        @keyframes dayAmbient {
            0% {
                filter: brightness(1.05);
            }

            100% {
                filter: brightness(1);
            }
        }

        body.time-night {
            --bg-color: #000002;
            animation: nightAmbient 2s infinite alternate;
        }

        @keyframes nightAmbient {
            0% {
                filter: brightness(0.85);
            }

            100% {
                filter: brightness(0.95);
            }
        }

        @keyframes nightPulseText {
            0% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        /* Creepy Restart Overlay */
        .creepy-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .creepy-overlay.active {
            display: flex;
        }

        .creepy-text {
            font-family: var(--f-title);
            font-size: 2.5rem;
            color: var(--danger);
            text-shadow: 0 0 30px var(--danger), 0 0 60px rgba(255, 0, 60, 0.5);
            animation: creepyFlicker 0.1s infinite;
            max-width: 80%;
            line-height: 1.4;
        }

        .creepy-subtext {
            font-family: var(--f-mono);
            color: var(--text-dim);
            margin-top: 30px;
            font-size: 1.2rem;
            animation: creepyPulse 2s infinite;
        }

        @keyframes creepyFlicker {

            0%,
            90%,
            100% {
                opacity: 1;
            }

            91% {
                opacity: 0.4;
            }

            92% {
                opacity: 0.9;
            }

            93% {
                opacity: 0.3;
            }
        }

        @keyframes creepyPulse {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        /* Puzzle Modal */
        .puzzle-modal {
            position: fixed;
            inset: 0;
            z-index: 6000;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .puzzle-modal.active {
            display: flex;
        }

        .puzzle-box {
            background: var(--glass-bg);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 50px;
            text-align: center;
            max-width: 500px;
        }

        .puzzle-title {
            font-family: var(--f-title);
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .puzzle-question {
            font-family: var(--f-mono);
            font-size: 2rem;
            color: var(--text-main);
            margin: 30px 0;
        }

        .puzzle-input {
            width: 200px;
            padding: 15px;
            font-family: var(--f-mono);
            font-size: 1.5rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 8px;
            outline: none;
        }

        .puzzle-input:focus {
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.5);
        }

        .puzzle-submit {
            margin-top: 20px;
        }

        /* COUNTDOWN TIMER - Add to your CSS */
        .time-ring {
            position: absolute;
            top: 90px;
            left: 40px;
            width: 100px;
            height: 100px;
            z-index: 60;
        }

        .time-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .time-ring-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 8;
        }

        .time-ring-progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 251;
            /* 2 * PI * 40 */
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 0.1s linear, stroke 0.3s;
            filter: drop-shadow(0 0 10px var(--primary));
        }

        .time-ring-progress.danger {
            stroke: var(--danger);
            filter: drop-shadow(0 0 15px var(--danger));
            animation: pulseDanger 0.5s infinite;
        }

        @keyframes pulseDanger {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .time-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--f-title);
            font-size: 1.8rem;
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary);
        }

        .time-ring-text.danger {
            color: var(--danger);
            text-shadow: 0 0 15px var(--danger);
            animation: shakeTimer 0.1s infinite;
        }

        @keyframes shakeTimer {

            0%,
            100% {
                transform: translate(-50%, -50%) translateX(0);
            }

            50% {
                transform: translate(-50%, -50%) translateX(2px);
            }
        }

        /* =============================================
           WIN SCREEN - TIME SAVED / TIMELINE RESTORED
           Theme: Expanding time rings, clock hands, forward motion
           ============================================= */
        .win-modal {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background:
                /* INTENSE BLACK VIGNETTE BORDER */
                radial-gradient(ellipse at 50% 50%, transparent 30%, rgba(0, 0, 0, 0.7) 60%, rgba(0, 0, 0, 0.95) 80%, #000000 100%),
                /* Clock-like concentric time rings */
                repeating-radial-gradient(circle at 50% 50%,
                    transparent 0px,
                    transparent 60px,
                    rgba(57, 255, 20, 0.04) 62px,
                    transparent 64px,
                    transparent 120px,
                    rgba(0, 243, 255, 0.03) 122px,
                    transparent 124px),
                /* Clock hand radial lines - 12 directions */
                repeating-conic-gradient(from 0deg at 50% 50%,
                    transparent 0deg,
                    rgba(57, 255, 20, 0.02) 1deg,
                    transparent 2deg,
                    transparent 30deg),
                /* Central time glow - TIME RESTORED */
                radial-gradient(ellipse at 50% 50%, rgba(57, 255, 20, 0.15) 0%, transparent 40%),
                /* Deep time-space base */
                linear-gradient(180deg, #000502 0%, #000805 30%, #000503 70%, #000000 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.5s;
        }

        /* ROTATING TIME RINGS - Expanding outward (time gained!) */
        .win-modal::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            width: 200vmax;
            height: 200vmax;
            transform: translate(-50%, -50%);
            background:
                /* Multiple clock rings at different sizes */
                repeating-radial-gradient(circle at center,
                    transparent 0px,
                    transparent 100px,
                    rgba(57, 255, 20, 0.06) 102px,
                    transparent 106px,
                    transparent 200px,
                    rgba(0, 255, 136, 0.05) 202px,
                    transparent 206px,
                    transparent 300px,
                    rgba(0, 243, 255, 0.04) 302px,
                    transparent 306px);
            animation: timeExpandWin 8s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        /* CLOCK HANDS - Rotating radial lines */
        .win-modal::after {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            width: 200vmax;
            height: 200vmax;
            transform: translate(-50%, -50%);
            background:
                /* Hour hand */
                conic-gradient(from 0deg at 50% 50%,
                    transparent 0deg,
                    rgba(57, 255, 20, 0.15) 2deg,
                    transparent 4deg,
                    transparent 360deg),
                /* Minute hand */
                conic-gradient(from 90deg at 50% 50%,
                    transparent 0deg,
                    rgba(0, 243, 255, 0.1) 1deg,
                    transparent 3deg,
                    transparent 360deg);
            animation: clockHandsWin 20s linear infinite;
            pointer-events: none;
            z-index: 2;
        }

        /* Time rings expand outward - TIME GAINED */
        @keyframes timeExpandWin {
            0% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) scale(1.2) rotate(30deg);
            }
        }

        /* Clock hands rotate forward - TIME FLOWS */
        @keyframes clockHandsWin {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .win-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .win-title {
            font-family: var(--f-title);
            font-size: 5rem;
            color: var(--green);
            text-shadow:
                0 0 20px var(--green),
                0 0 40px var(--green),
                0 0 80px rgba(57, 255, 20, 0.5),
                0 2px 0 rgba(0, 255, 136, 0.8),
                0 -2px 0 rgba(0, 243, 255, 0.8);
            animation: winPulse 2s infinite, holoFlicker 0.1s infinite;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        @keyframes holoFlicker {

            0%,
            100% {
                opacity: 1;
            }

            92% {
                opacity: 1;
            }

            93% {
                opacity: 0.8;
            }

            94% {
                opacity: 1;
            }
        }

        .win-subtitle {
            font-family: var(--f-mono);
            font-size: 1.5rem;
            color: white;
            margin-bottom: 50px;
            opacity: 0.8;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 50px;
            position: relative;
            z-index: 10;
        }

        .stat-box {
            background: var(--glass-bg);
            border: var(--glass-border);
            padding: 25px 40px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-box .stat-label {
            margin-bottom: 10px;
        }

        .stat-box .stat-value {
            font-family: var(--f-title);
            font-size: 2.5rem;
            color: var(--primary);
        }

        @keyframes winPulse {

            0%,
            100% {
                text-shadow: 0 0 30px var(--green), 0 0 60px rgba(57, 255, 20, 0.3);
            }

            50% {
                text-shadow: 0 0 60px var(--green), 0 0 100px var(--green), 0 0 150px rgba(57, 255, 20, 0.5);
            }
        }

        /* =============================================
           GAME OVER SCREEN - TIME LOST / TIMELINE BROKEN
           Theme: Collapsing time rings, reverse clock, rewind motion
           Colors: INDIGO and BLACK only
           ============================================= */
        #s-over {
            background:
                /* INTENSE BLACK VIGNETTE BORDER */
                radial-gradient(ellipse at 50% 50%, transparent 30%, rgba(0, 0, 0, 0.7) 60%, rgba(0, 0, 0, 0.95) 80%, #000000 100%),
                /* Clock-like concentric time rings - COLLAPSING */
                repeating-radial-gradient(circle at 50% 50%,
                    transparent 0px,
                    transparent 60px,
                    rgba(79, 70, 229, 0.05) 62px,
                    transparent 64px,
                    transparent 120px,
                    rgba(30, 27, 75, 0.08) 122px,
                    transparent 124px),
                /* Clock hand radial lines - 12 directions (broken clock) */
                repeating-conic-gradient(from 0deg at 50% 50%,
                    transparent 0deg,
                    rgba(79, 70, 229, 0.03) 1deg,
                    transparent 2deg,
                    transparent 30deg),
                /* Central void - TIME CONSUMED */
                radial-gradient(ellipse at 50% 50%, rgba(79, 70, 229, 0.1) 0%, transparent 35%),
                /* Deep void base - PURE BLACK with subtle indigo */
                linear-gradient(180deg, #000002 0%, #03031a 30%, #05051a 50%, #03031a 70%, #000000 100%) !important;
            position: absolute;
            inset: 0;
        }

        /* COLLAPSING TIME RINGS - Shrinking inward (time lost!) */
        #s-over::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            width: 200vmax;
            height: 200vmax;
            transform: translate(-50%, -50%);
            background:
                /* Multiple clock rings collapsing - INDIGO */
                repeating-radial-gradient(circle at center,
                    transparent 0px,
                    transparent 100px,
                    rgba(79, 70, 229, 0.06) 102px,
                    transparent 106px,
                    transparent 200px,
                    rgba(129, 140, 248, 0.04) 202px,
                    transparent 206px,
                    transparent 300px,
                    rgba(30, 27, 75, 0.05) 302px,
                    transparent 306px);
            animation: timeCollapseLose 10s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        /* REWINDING CLOCK HANDS - Rotating backwards - INDIGO */
        #s-over::after {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            width: 200vmax;
            height: 200vmax;
            transform: translate(-50%, -50%);
            background:
                /* Hour hand - REWINDING - INDIGO */
                conic-gradient(from 0deg at 50% 50%,
                    transparent 0deg,
                    rgba(79, 70, 229, 0.15) 2deg,
                    transparent 4deg,
                    transparent 360deg),
                /* Minute hand - REWINDING FASTER - LIGHT INDIGO */
                conic-gradient(from 180deg at 50% 50%,
                    transparent 0deg,
                    rgba(129, 140, 248, 0.1) 1deg,
                    transparent 3deg,
                    transparent 360deg);
            animation: clockHandsLose 15s linear infinite reverse;
            pointer-events: none;
            z-index: 2;
        }

        /* Time rings collapse inward - TIME LOST */
        @keyframes timeCollapseLose {
            0% {
                transform: translate(-50%, -50%) scale(1.2) rotate(30deg);
            }

            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }
        }

        /* Clock hands rotate BACKWARDS - TIME REWINDS */
        @keyframes clockHandsLose {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        /* Content stays on top */
        #s-over .game-over-container {
            position: relative;
            z-index: 10;
        }

        /* DANGER STATE */
        .time-bar.danger {
            background: var(--danger) !important;
            animation: timerPulse 0.3s infinite;
        }

        /* Screen Shake / Distortion for Low Time */
        body.time-critical {
            animation: screenShake 0.1s infinite;
        }

        body.time-critical .vignette {
            background: radial-gradient(circle, transparent 20%, rgba(255, 0, 60, 0.4) 100%);
        }

        @keyframes screenShake {
            0% {
                transform: translate(1px, 1px);
            }

            25% {
                transform: translate(-1px, 0px);
            }

            50% {
                transform: translate(0px, -1px);
            }

            75% {
                transform: translate(-1px, 1px);
            }

            100% {
                transform: translate(1px, -1px);
            }
        }

        @keyframes timerPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        @keyframes powerPopup {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }

            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }

            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) translateY(-50px);
            }
        }

        /* Heartbeat edge pulse - syncs with audio */
        .heartbeat-vignette {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1050;
            border: 0 solid rgba(255, 0, 60, 0);
            box-shadow: inset 0 0 0 rgba(255, 0, 60, 0);
        }

        .heartbeat-vignette.pulse {
            animation: heartbeatVignettePulse var(--heartbeat-speed, 0.43s) ease-out forwards;
        }

        @keyframes heartbeatVignettePulse {
            0% {
                border-width: 0;
                box-shadow: inset 0 0 0 rgba(255, 0, 60, 0);
            }

            15% {
                border-width: 10px;
                border-color: rgba(255, 0, 60, 0.9);
                box-shadow: inset 0 0 120px rgba(255, 0, 60, 0.5);
            }

            30% {
                border-width: 5px;
                border-color: rgba(255, 0, 60, 0.6);
                box-shadow: inset 0 0 70px rgba(255, 0, 60, 0.3);
            }

            45% {
                border-width: 8px;
                border-color: rgba(255, 0, 60, 0.7);
                box-shadow: inset 0 0 90px rgba(255, 0, 60, 0.4);
            }

            100% {
                border-width: 0;
                box-shadow: inset 0 0 0 rgba(255, 0, 60, 0);
            }
        }

        /* Last Breath effect - that clutch moment */
        body.deaths-door {
            filter: grayscale(1) contrast(1.4) brightness(0.7);
            transition: filter 0.1s ease-out;
        }

        body.deaths-door * {
            animation-play-state: paused !important;
        }

        body.deaths-door .opt-btn {
            animation-play-state: running !important;
            transition: all 0.1s !important;
        }

        body.deaths-door .vignette {
            background: radial-gradient(circle, transparent 0%, rgba(0, 0, 0, 0.98) 70%) !important;
        }

        body.deaths-door::before {
            content: '⏳ LAST BREATH ⏳';
            position: fixed;
            top: 12%;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--f-title);
            font-size: 3.5rem;
            color: rgba(255, 0, 60, 1);
            text-shadow: 0 0 40px rgba(255, 0, 60, 0.9), 0 0 80px rgba(255, 0, 60, 0.6);
            z-index: 2500;
            animation: lastBreathText 0.5s ease-out forwards;
            letter-spacing: 8px;
            pointer-events: none;
        }

        @keyframes lastBreathText {
            0% {
                opacity: 0;
                transform: translateX(-50%) scale(2.5);
            }

            40% {
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }

            100% {
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }
        }

        /* CLUTCH SAVE Celebration */
        .clutch-save-overlay {
            position: fixed;
            inset: 0;
            z-index: 2600;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
        }

        .clutch-save-overlay.active {
            animation: clutchFlash 1.5s ease-out forwards;
        }

        .clutch-save-text {
            font-family: var(--f-title);
            font-size: 5rem;
            color: var(--green);
            text-shadow: 0 0 50px var(--green), 0 0 100px var(--green), 0 0 150px var(--green);
            letter-spacing: 8px;
            animation: clutchTextPop 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes clutchFlash {
            0% {
                opacity: 0;
                background: rgba(57, 255, 20, 0);
            }

            15% {
                opacity: 1;
                background: rgba(57, 255, 20, 0.4);
            }

            40% {
                background: rgba(57, 255, 20, 0.15);
            }

            100% {
                opacity: 0;
                background: rgba(57, 255, 20, 0);
            }
        }

        @keyframes clutchTextPop {
            0% {
                opacity: 0;
                transform: scale(0.2) rotate(-10deg);
            }

            50% {
                opacity: 1;
                transform: scale(1.3) rotate(3deg);
            }

            75% {
                transform: scale(0.9) rotate(-2deg);
            }

            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        /* Screen crack when you lose an anchor */
        .screen-crack-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1100;
            opacity: 0;
            background:
                radial-gradient(ellipse at 30% 40%, transparent 0%, transparent 20%, rgba(255, 0, 60, 0.1) 21%, transparent 22%),
                radial-gradient(ellipse at 70% 60%, transparent 0%, transparent 15%, rgba(255, 0, 60, 0.1) 16%, transparent 17%),
                linear-gradient(45deg, transparent 48%, rgba(255, 255, 255, 0.1) 49%, rgba(255, 255, 255, 0.1) 51%, transparent 52%),
                linear-gradient(-45deg, transparent 48%, rgba(255, 255, 255, 0.08) 49%, rgba(255, 255, 255, 0.08) 51%, transparent 52%),
                linear-gradient(30deg, transparent 45%, rgba(255, 255, 255, 0.05) 46%, transparent 54%);
            background-size: 100% 100%, 100% 100%, 200% 200%, 200% 200%, 300% 300%;
            transition: opacity 0.3s;
        }

        .screen-crack-overlay.cracked {
            opacity: 1;
            animation: crackAppear 0.5s ease-out forwards;
        }

        @keyframes crackAppear {
            0% {
                opacity: 0;
                transform: scale(0.95);
            }

            50% {
                opacity: 1;
                transform: scale(1.02);
            }

            100% {
                opacity: 0.7;
                transform: scale(1);
            }
        }

        /* Floating archive cards - looks sick on hover */
        .roulette-item {
            animation: floatDrift 4s ease-in-out infinite;
            animation-delay: calc(var(--float-delay, 0) * 0.3s);
        }

        .roulette-item:nth-child(odd) {
            animation-duration: 4.5s;
            animation-direction: alternate-reverse;
        }

        .roulette-item:hover {
            animation: none !important;
            transform: scale(1.5) !important;
            opacity: 1 !important;
            filter: blur(0) brightness(1.3) !important;
            border-color: var(--primary) !important;
            background: rgba(0, 243, 255, 0.3) !important;
            box-shadow: 0 0 50px var(--primary), 0 0 100px rgba(0, 243, 255, 0.5) !important;
            z-index: 200 !important;
            transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
        }

        @keyframes floatDrift {

            0%,
            100% {
                transform: translateY(0) scale(var(--item-scale, 0.7));
            }

            50% {
                transform: translateY(-8px) scale(var(--item-scale, 0.7));
            }
        }

        /* The dramatic stamp that slams on at the end */
        .kia-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(3) rotate(-15deg);
            font-family: var(--f-title);
            font-size: 3rem;
            color: rgba(255, 0, 60, 0.9);
            text-shadow: 0 0 10px rgba(255, 0, 60, 0.5);
            border: 4px solid rgba(255, 0, 60, 0.9);
            padding: 10px 25px;
            letter-spacing: 10px;
            opacity: 0;
            pointer-events: none;
            z-index: 100;
        }

        .kia-stamp.stamped {
            animation: stampSlam 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes stampSlam {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(4) rotate(-25deg);
            }

            60% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.9) rotate(-12deg);
            }

            80% {
                transform: translate(-50%, -50%) scale(1.05) rotate(-14deg);
            }

            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) rotate(-15deg);
            }
        }

        /* =========================================
           GAME OVER SCREEN STYLES
           ========================================= */

        .game-over-container {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            justify-content: center;
            flex-wrap: wrap;
            padding: 20px;
            max-width: 900px;
        }

        .share-card-wrapper {
            padding: 4px;
            background: linear-gradient(135deg, #ff0066, #9933ff, #00ff66);
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(153, 51, 255, 0.4);
        }

        .share-card {
            position: relative;
            width: 280px;
            height: 380px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 280px;
            max-width: 320px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .name-row input {
            flex: 1;
            padding: 12px 15px;
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: white;
            font-family: var(--f-title);
            font-size: 1.1rem;
            letter-spacing: 2px;
            outline: none;
            text-transform: uppercase;
        }

        .name-row input::placeholder {
            color: #666;
            text-transform: uppercase;
        }

        .name-row input:focus {
            border-bottom-color: var(--green);
        }

        .control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #444;
            color: white;
            font-family: var(--f-mono);
            font-size: 0.95rem;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
        }

        .upload-btn {
            text-align: center;
        }

        .reboot-btn {
            background: rgba(0, 243, 255, 0.1);
            border-color: var(--primary);
            color: var(--primary);
            font-family: var(--f-title);
            margin-top: 5px;
        }

        .reboot-btn:hover {
            background: var(--primary);
            color: black;
            box-shadow: 0 0 20px var(--primary);
        }

        .share-message-box {
            background: rgba(0, 255, 102, 0.05);
            border: 1px solid rgba(0, 255, 102, 0.2);
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }

        /* Star Rating */
        .rating-section {
            padding: 12px 0;
            text-align: center;
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .star {
            font-size: 1.8rem;
            color: #333;
            cursor: pointer;
            transition: all 0.15s;
            text-shadow: none;
        }

        .star:hover,
        .star.hovered {
            color: #ffd700;
            transform: scale(1.2);
            text-shadow: 0 0 10px #ffd700;
        }

        .star.active {
            color: #ffd700;
            text-shadow: 0 0 15px #ffd700;
        }

        /* Feedback Section */
        .feedback-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .feedback-section textarea {
            width: 100%;
            height: 70px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 4px;
            color: white;
            font-family: var(--f-mono);
            font-size: 0.85rem;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }

        .feedback-section textarea::placeholder {
            color: #555;
        }

        .feedback-section textarea:focus {
            border-color: var(--primary);
        }

        .send-feedback-btn {
            position: relative;
            padding: 16px 28px;
            background: linear-gradient(135deg, rgba(153, 51, 255, 0.2), rgba(57, 255, 20, 0.2));
            border: 2px solid transparent;
            border-image: linear-gradient(135deg, #9933ff, #39ff14) 1;
            color: white;
            font-family: var(--f-title);
            font-size: 1rem;
            letter-spacing: 2px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            overflow: hidden;
            animation: feedbackPulse 2s infinite;
        }

        .send-feedback-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%) rotate(45deg);
            }

            100% {
                transform: translateX(100%) rotate(45deg);
            }
        }

        @keyframes feedbackPulse {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(153, 51, 255, 0.4), 0 0 30px rgba(57, 255, 20, 0.2);
            }

            50% {
                box-shadow: 0 0 25px rgba(153, 51, 255, 0.6), 0 0 50px rgba(57, 255, 20, 0.4);
            }
        }

        .send-feedback-btn:hover {
            transform: scale(1.05) translateY(-2px);
            background: linear-gradient(135deg, rgba(153, 51, 255, 0.4), rgba(57, 255, 20, 0.4));
            box-shadow: 0 0 40px rgba(153, 51, 255, 0.6), 0 0 60px rgba(57, 255, 20, 0.4), 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .send-feedback-btn:active {
            transform: scale(0.98);
        }

        .send-feedback-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            animation: none;
        }

        .send-feedback-btn.sent {
            background: linear-gradient(135deg, #39ff14, #00ff88);
            color: black;
            font-weight: bold;
            animation: none;
            box-shadow: 0 0 30px rgba(57, 255, 20, 0.6);
        }

        /* ACHIEVEMENT TIERS */
        .ach-card.tier-common {
            border: 1px solid #cd7f32;
            box-shadow: 0 0 5px rgba(205, 127, 50, 0.3);
        }

        .ach-card.tier-common .ach-card-icon {
            text-shadow: 0 0 5px #cd7f32;
        }

        .ach-card.tier-rare {
            border: 1px solid silver;
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.1), transparent);
            box-shadow: 0 0 10px rgba(192, 192, 192, 0.4);
        }

        .ach-card.tier-rare .ach-card-icon {
            text-shadow: 0 0 10px silver;
        }

        .ach-card.tier-epic {
            border: 2px solid #ff003c;
            background: linear-gradient(135deg, rgba(255, 0, 60, 0.15), transparent);
            box-shadow: 0 0 15px rgba(255, 0, 60, 0.5);
            animation: epicPulse 2s infinite alternate;
        }

        .ach-card.tier-epic .ach-card-name {
            color: #ff003c;
            text-shadow: 0 0 5px #ff003c;
        }

        .ach-card.tier-legendary {
            border: 2px solid #ffd700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), transparent, rgba(255, 215, 0, 0.1));
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), inset 0 0 20px rgba(255, 215, 0, 0.2);
            animation: legendaryShine 3s infinite linear;
            position: relative;
            overflow: hidden;
        }

        .ach-card.tier-legendary::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        .ach-card.tier-legendary .ach-card-name {
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
        }

        @keyframes epicPulse {
            0% {
                box-shadow: 0 0 15px rgba(255, 0, 60, 0.5);
            }

            100% {
                box-shadow: 0 0 25px rgba(255, 0, 60, 0.8), inset 0 0 10px rgba(255, 0, 60, 0.2);
            }
        }

        @keyframes legendaryShine {
            0% {
                border-color: #ffd700;
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            }

            50% {
                border-color: #fff;
                box-shadow: 0 0 50px rgba(255, 215, 0, 1);
            }

            100% {
                border-color: #ffd700;
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            }
        }

        /* BIGGER BUTTON */
        #open-ach-btn {
            transform: scale(1.3);
            border-bottom: 2px solid var(--primary);
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 4000;
            padding: 15px 25px;
            font-size: 1.2rem;
            animation: btnFloat 3s ease-in-out infinite;
        }

        @keyframes btnFloat {

            0%,
            100% {
                transform: scale(1.3) translateY(0);
            }

            50% {
                transform: scale(1.3) translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 243, 255, 0.4);
            }
        }
    </style>
</head>

<body>

    <!-- DARKNESS OVERLAY for cinematic transitions -->
    <div class="darkness-overlay" id="darkness-overlay"></div>

    <!-- CLICK TO START SCREEN -->
    <div class="click-to-start" id="click-to-start">
        <div class="start-text">⚡ NEURO-FRIED ⚡</div>
        <div class="headphones-warning">🎧 USE HEADPHONES FOR BETTER OPTIMIZATION 🎧</div>
        <div class="start-subtext">[ CLICK ANYWHERE TO BEGIN ]</div>
    </div>

    <div id="render-layer"><canvas id="c"></canvas></div>
    <div class="vignette"></div>
    <div class="scanlines"></div>

    <!-- BLOOD HORROR OVERLAYS -->
    <div class="blood-veins"></div>
    <div class="blood-drip" id="blood-drip"></div>

    <div class="fx-overlay fx-rewind"></div>
    <div class="fx-overlay fx-freeze"></div>

    <div class="heartbeat-vignette" id="heartbeat-vignette"></div>

    <div class="clutch-save-overlay" id="clutch-save-overlay">
        <div class="clutch-save-text">⚡ CLUTCH SAVE ⚡</div>
    </div>

    <div class="screen-crack-overlay" id="screen-crack-overlay"></div>

    <!-- MOBILE BLOCKER -->
    <div class="mobile-blocker" id="mobile-blocker">
        <h1>🖥️ DESKTOP ONLY</h1>
        <p>NEURO-FRIED requires a desktop browser for the full neural experience. The timeline cannot be accessed from
            mobile devices.</p>
        <div class="desktop-icon">💻</div>
        <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.6;">Switch to a computer to play.</p>
    </div>

    <!-- LUCK RANDOMIZER SCREEN -->
    <div id="s-luck" class="screen hidden">
        <h2 style="font-family:var(--f-title); color:var(--text-main); margin-bottom:10px; font-size:2rem;">
            FATE SELECTION
        </h2>
        <div class="story-container" id="fate-story-container">
            <!-- Typewriter text generated here -->
        </div>
        <div class="luck-box" id="luck-box-container" style="opacity:0; pointer-events:none;">
            <div class="luck-container">
                <div class="luck-slots">
                    <div class="luck-slot" id="luck-slot-1">?</div>
                    <div class="luck-slot" id="luck-slot-2">?</div>
                    <div class="luck-slot" id="luck-slot-3">?</div>
                </div>
                <div class="luck-result" id="luck-result"></div>
            </div>
            <button class="tech-btn" id="spin-luck-btn" style="margin-top:30px;">SPIN FATE</button>
        </div>
    </div>

    <!-- DREAM OVERLAY (Mode B) -->
    <div class="dream-overlay" id="dream-overlay">
        <div class="dream-text" id="dream-text">IT WAS A DREAM...</div>
        <div class="dream-subtext" id="dream-subtext">Timeline resetting...</div>
    </div>

    <!-- DUEL GAME SCREEN (Mode C) -->
    <div id="s-game-duel" class="screen hidden">
        <div class="duel-container">
            <!-- PLAYER SIDE -->
            <div class="duel-side player">
                <div class="duel-label">⚡ YOU</div>
                <span class="era-tag" id="era-display-player" style="margin-bottom:15px;">YEAR: 1990</span>
                <div class="q-text" id="q-text-player" style="font-size:1.1rem; margin-bottom:20px;">LOADING...</div>
                <div class="opt-grid" id="opt-area-player"></div>
                <div style="margin-top:auto; padding-top:20px; text-align:center;">
                    <span style="font-family:var(--f-mono); color:var(--primary);">SCORE: <span
                            id="player-duel-score">0</span></span>
                </div>
            </div>

            <!-- AI SIDE -->
            <div class="duel-side ai">
                <div class="duel-label">🤖 OTHER YOU</div>
                <span class="era-tag" id="era-display-ai" style="margin-bottom:15px;">YEAR: 1990</span>
                <div class="q-text" id="q-text-ai" style="font-size:1.1rem; margin-bottom:20px;">LOADING...</div>
                <div class="opt-grid" id="opt-area-ai"></div>
                <div style="margin-top:auto; padding-top:20px; text-align:center;">
                    <span style="font-family:var(--f-mono); color:var(--secondary);">SCORE: <span
                            id="ai-duel-score">0</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- PUZZLE MODAL (Mode C End) -->
    <div class="puzzle-modal" id="puzzle-modal">
        <div class="puzzle-box">
            <div class="puzzle-title">⏳ FINAL CHALLENGE ⏳</div>
            <div style="font-family:var(--f-mono); color:var(--text-dim); margin-bottom:20px;">
                Solve to escape the timeline...
            </div>
            <div class="puzzle-question" id="puzzle-question">2 + 2 = ?</div>
            <input type="text" class="puzzle-input" id="puzzle-input" placeholder="?" autocomplete="off">
            <button class="tech-btn puzzle-submit" id="puzzle-submit">SUBMIT</button>
            <div id="puzzle-feedback" style="margin-top:15px; font-family:var(--f-mono); min-height:30px;"></div>
        </div>
    </div>

    <!-- CREEPY RESTART OVERLAY -->
    <div class="creepy-overlay" id="creepy-overlay">
        <div class="creepy-text" id="creepy-text">YOU CANNOT ESCAPE</div>
        <div class="creepy-subtext" id="creepy-subtext">You must play again...</div>
        <button class="tech-btn" id="creepy-continue"
            style="margin-top:40px; border-color:var(--danger); color:var(--danger);">CONTINUE</button>
    </div>

    <div id="fail-modal" class="fail-modal">
        <div class="fail-title">TIMELINE FRACTURED</div>
        <div class="fail-sub">ANOMALY DETECTED. CHOOSE ACTION.</div>
        <div style="font-family:var(--f-mono); opacity:0.6;">
            EVERY REWIND ACCELERATES COLLAPSE.
        </div>

        <div class="fail-btn-row">
            <button class="fail-btn btn-rewind" onclick="Game.triggerRewind()">REWIND<br><span
                    style="font-size:0.8rem">COST: 1 CHARGE</span></button>
            <button class="fail-btn btn-exit" onclick="Game.gameOver()">EXIT<br><span style="font-size:0.8rem">ACCEPT
                    FATE</span></button>
        </div>
    </div>

    <div id="victory-screen" class="win-modal" style="display:none;">
        <h1 class="glitch-title"
            style="color: var(--green); text-shadow: 0 0 30px var(--green), 0 0 80px rgba(57, 255, 20, 0.5); transform: scale(0.8); position: relative; z-index: 10;">
            NEURAL SYNC COMPLETE
        </h1>
        <div class="victory-stats" style="
            background: rgba(0, 20, 10, 0.85);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(57, 255, 20, 0.4);
            border-radius: 16px;
            padding: 30px 50px;
            margin: 30px 0;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 0 40px rgba(57, 255, 20, 0.2), inset 0 0 30px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 10;
        ">
            <div class="stat-row"
                style="display: flex; justify-content: space-between; margin: 15px 0; border-bottom: 1px solid rgba(57, 255, 20, 0.2); padding-bottom: 10px;">
                <span class="stat-label" style="font-family: var(--f-ui); color: rgba(255,255,255,0.7);">FINAL
                    SCORE</span>
                <span class="stat-val" id="final-score"
                    style="font-family: var(--f-mono); font-size: 1.5rem; color: var(--green); text-shadow: 0 0 10px var(--green);">0</span>
            </div>
            <div class="stat-row"
                style="display: flex; justify-content: space-between; margin: 15px 0; border-bottom: 1px solid rgba(57, 255, 20, 0.2); padding-bottom: 10px;">
                <span class="stat-label" style="font-family: var(--f-ui); color: rgba(255,255,255,0.7);">TIME
                    SURVIVED</span>
                <span class="stat-val" id="time-survived"
                    style="font-family: var(--f-mono); font-size: 1.5rem; color: var(--secondary); text-shadow: 0 0 10px var(--secondary);">0s</span>
            </div>
            <div class="stat-row"
                style="display: flex; justify-content: space-between; margin: 15px 0; border-bottom: 1px solid rgba(57, 255, 20, 0.2); padding-bottom: 10px;">
                <span class="stat-label" style="font-family: var(--f-ui); color: rgba(255,255,255,0.7);">QUESTIONS
                    CLEARED</span>
                <span class="stat-val" id="questions-cleared"
                    style="font-family: var(--f-mono); font-size: 1.5rem; color: var(--text-main);">0</span>
            </div>
            <div class="stat-row" style="display: flex; justify-content: space-between; margin: 15px 0;">
                <span class="stat-label" style="font-family: var(--f-ui); color: rgba(255,255,255,0.7);">MAX
                    SPEED</span>
                <span class="stat-val" id="max-speed"
                    style="font-family: var(--f-mono); font-size: 1.5rem; color: var(--danger); text-shadow: 0 0 10px var(--danger);">1x</span>
            </div>
        </div>
        <button class="tech-btn" style="position: relative; z-index: 10;" onclick="location.reload()">REBOOT</button>
    </div>

    <header>
        <div style="display:flex; flex-direction:column; align-items:flex-start;">
            <div class="brand">NEURO-FRIED</div>
            <div
                style="font-family:var(--f-ui); font-size:1rem; color:var(--primary); font-weight:700; letter-spacing:2px; margin-top:0px; text-shadow: 0 0 5px rgba(0, 243, 255, 0.4);">
                DEV: KAUSTAV CHOWDHURY
            </div>
        </div>
        <!-- TOGGLE CONTROLS -->
        <div class="toggle-controls">
            <!-- THEME TOGGLE - DARK MONOCHROME THEME -->
            <button class="toggle-btn theme-btn" id="theme-toggle-btn" title="Switch Theme" onclick="
                var r = document.documentElement;
                var isDark = document.body.classList.contains('theme-dark');
                if (isDark) {
                    /* SWITCH BACK TO INDIGO */
                    r.style.setProperty('--primary', '#4f46e5');
                    r.style.setProperty('--primary-light', '#818cf8');
                    r.style.setProperty('--secondary', '#a5b4fc');
                    r.style.setProperty('--danger', '#ff003c');
                    r.style.setProperty('--green', '#39ff14');
                    r.style.setProperty('--text-main', '#ffffff');
                    r.style.setProperty('--text-dim', '#94a3b8');
                    r.style.setProperty('--bg-color', '#000005');
                    r.style.setProperty('--glass-bg', 'rgba(0, 0, 5, 0.98)');
                    r.style.setProperty('--glass-border', '1px solid rgba(79, 70, 229, 0.2)');
                    document.body.classList.remove('theme-dark');
                    this.querySelector('.icon').textContent = '🔄';
                    console.log('Switched to INDIGO (Color Mode)');
                } else {
                    /* SWITCH TO DARK MONOCHROME - Black/Ash/White only */
                    r.style.setProperty('--primary', '#a0a0a0');
                    r.style.setProperty('--primary-light', '#c0c0c0');
                    r.style.setProperty('--secondary', '#808080');
                    r.style.setProperty('--danger', '#606060');
                    r.style.setProperty('--green', '#d0d0d0');
                    r.style.setProperty('--text-main', '#ffffff');
                    r.style.setProperty('--text-dim', '#707070');
                    r.style.setProperty('--bg-color', '#000000');
                    r.style.setProperty('--glass-bg', 'rgba(10, 10, 10, 0.98)');
                    r.style.setProperty('--glass-border', '1px solid rgba(100, 100, 100, 0.3)');
                    document.body.classList.add('theme-dark');
                    this.querySelector('.icon').textContent = '🌙';
                    console.log('Switched to DARK MONO (Black/Ash/White)');
                }
            ">
                <span class="icon">🔄</span>
            </button>
        </div>
    </header>

    <div id="hud" class="hidden">
        <!-- New Left HUD Timer -->
        <div class="hud-panel hud-top-left" id="timer-panel" style="
            top: 90px;
            left: 40px;
            right: auto;
            border-left: 4px solid var(--primary);
            border-right: none;
            text-align: left;
        ">
            <div class="stat-label">TIME REMAINING</div>
            <div class="stat-val" id="time-display" style="font-size: 2.5rem; color: var(--primary);">60.0</div>
            <div class="time-bar-container" style="
                width: 150px;
                height: 8px;
                background: rgba(255,255,255,0.1);
                border-radius: 4px;
                margin-top: 10px;
                overflow: hidden;
            ">
                <div class="time-bar" id="time-bar" style="
                    height: 100%;
                    width: 100%;
                    background: linear-gradient(90deg, var(--danger), var(--primary));
                    transition: width 0.1s linear;
                    box-shadow: 0 0 10px var(--primary);
                "></div>
            </div>
        </div>
        <div class="hud-panel hud-top-right">
            <div class="stat-label">TIMELINES SAVED</div>
            <div style="display:flex; align-items:center; justify-content:flex-end;">
                <div class="coin-cont">
                    <div class="retro-coin"></div>
                </div>
                <div class="stat-val" id="hud-score">0</div>
            </div>
            <div class="stat-label" style="margin-top:10px;">REALITY ANCHORS</div>
            <div id="hud-streak"
                style="font-family:var(--f-mono); color:var(--green); font-size:1.2rem; min-height:1.5rem;"></div>
            <div class="lives-container" id="lives-container">
                <div class="life-pip"></div>
                <div class="life-pip"></div>
                <div class="life-pip"></div>
            </div>
        </div>

        <div class="freeze-container">
            <button class="big-freeze-btn" id="btn-freeze" onclick="TimePowers.useFreeze()">
                FREEZE
                <span>[SPACE]</span>
            </button>
            <button class="big-freeze-btn btn-hud-rewind" id="btn-rewind-hud" onclick="TimePowers.useRewind()">
                REWIND
                <span>[R]</span>
            </button>
        </div>
    </div>

    <div id="s-title" class="screen active">
        <h1 class="glitch-title" data-text="NEURO FRIED">NEURO<br>FRIED</h1>

        <div class="protocol-container">
            <div class="protocol-trigger">[ TRANSMISSION INTERCEPTED ]</div>
            <div class="story-container" id="title-story-container">
                <!-- Typewriter text will be generated here -->
            </div>
        </div>

        <button class="tech-btn" id="init-btn" style="opacity:0; pointer-events:none;">INITIALIZE SYSTEM</button>
    </div>

    <div id="s-roulette" class="screen hidden">
        <h2 style="font-family:var(--f-title); color:var(--text-main); margin-bottom:20px; opacity:0.8;">SEARCHING
            ARCHIVES...</h2>
        <div class="story-container" id="roulette-story-container">
            <!-- Typewriter text generated here -->
        </div>
        <div class="roulette-box">
            <div class="roulette-window">
                <div class="roulette-track" id="roulette-track"></div>
                <div
                    style="position:absolute; inset:0; background:linear-gradient(to bottom, var(--glass-bg), transparent 40%, transparent 60%, var(--glass-bg)); pointer-events:none; z-index:20;">
                </div>
            </div>
            <div id="roulette-actions" class="hidden" style="margin-top:10px;">
                <button class="tech-btn" onclick="Game.confirmTopic()"
                    style="border-color:var(--primary); color:var(--primary);">ACCEPT</button>
                <button class="tech-btn" onclick="Game.reroll()"
                    style="border-color:var(--danger); color:var(--danger);">REROLL</button>
            </div>
        </div>
    </div>

    <div id="s-timeline" class="screen hidden">
        <div class="timeline-box">
            <h2 style="font-family:var(--f-title); color:var(--text-main);">CHOOSE YOUR PATH</h2>
            <div class="story-container" id="timeline-story-container">
                <!-- Typewriter text generated here -->
            </div>
            <div id="timeline-controls" style="opacity:0; pointer-events:none;">
                <div style="margin:20px 0; font-family:var(--f-mono); font-size:2rem; color:var(--secondary);">
                    1935 <span style="opacity:0.5">&lt;---&gt;</span> 2035
                </div>
                <div class="btn-row">
                    <button class="tech-btn" style="border-color:var(--primary); color:var(--primary);"
                        onclick="Game.startGame('asc')">CHRONOLOGICAL</button>
                    <button class="tech-btn" style="border-color:var(--danger); color:var(--danger);"
                        onclick="Game.startGame('desc')">REWIND FLOW</button>
                </div>
            </div>
        </div>
    </div>

    <div id="s-register" class="screen hidden" style="background: black; z-index: 5500;">
        <div class="register-box">
            <h2 style="font-family:var(--f-title); color:var(--primary); margin-bottom:10px;">IDENTITY REGISTRATION</h2>
            <p style="font-family:var(--f-mono); color:#888; margin-bottom:30px;">REQUIRED FOR NEURAL SYNC</p>

            <label for="reg-photo" class="avatar-upload">
                <span id="reg-upload-text" style="color:var(--secondary); font-family:var(--f-mono);">+ PHOTO</span>
                <img id="reg-preview" class="avatar-preview">
                <input type="file" id="reg-photo" hidden accept="image/*" onchange="previewAvatar(this)">
            </label>

            <input type="text" id="reg-name" class="cyber-input" placeholder="ENTER CODENAME" maxlength="12"
                autocomplete="off">

            <button class="mega-btn" onclick="registerAndStart()">INITIATE SYNC</button>
        </div>
    </div>

    <div id="s-hype" class="screen hidden" style="background: rgba(0,0,0,0.9); z-index: 5000;">
        <div id="hype-count" class="hype-num">3</div>
        <div id="hype-msg-cont" class="hype-msg-cont hidden"></div>
    </div>

    <div id="s-outro" class="screen hidden"
        style="background: black; z-index: 6000; flex-direction: column; justify-content: center; align-items: center;">
        <div id="outro-t1" class="outro-text">THANKS</div>
        <div id="outro-t2" class="outro-text">FOR PLAYING</div>
        <div id="outro-t3" class="outro-text" style="color:var(--primary)">MY GAME</div>
        <div id="outro-final" class="outro-text hidden" style="margin-top: 50px;">
            <span id="word-restart"
                style="text-decoration: line-through; text-decoration-color: var(--danger); text-decoration-thickness: 5px; opacity: 0.5;">RESTART</span>
            <br>
            <span id="word-rewind" class="glitch-text"
                style="color:var(--secondary); font-size: 1.5em; display:none;">REWIND</span>
        </div>
    </div>

    <div id="s-game" class="screen hidden">
        <div class="time-ring" id="timeRing">
            <svg viewBox="0 0 100 100">
                <circle class="time-ring-bg" cx="50" cy="50" r="40"></circle>
                <circle class="time-ring-progress" id="timeProgress" cx="50" cy="50" r="40"></circle>
            </svg>
            <div class="time-ring-text" id="timeText">15</div>
        </div>
        <div class="game-grid">
            <div class="timer-rail">
                <div class="timer-fill" id="timer-bar"></div>
            </div>
            <div class="q-card">
                <span class="era-tag" id="era-display">YEAR: 1990</span>
                <div class="q-text" id="q-text">LOADING...</div>
            </div>
            <div class="opt-grid" id="opt-area"></div>
        </div>
    </div>

    <div id="s-over" class="screen hidden">
        <h1 id="game-over-headline"
            style="font-family:var(--f-title); font-size:4rem; color:var(--danger); margin-bottom:10px;">SIGNAL LOST
        </h1>

        <div class="game-over-container">
            <!-- LEFT: Share Card -->
            <div class="share-card-wrapper">
                <div class="share-card">
                    <img id="card-img"
                        style="width:100%; height:100%; object-fit:cover; filter:grayscale(100%); opacity:0.6;"
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25'%3E%3Crect fill='%23111' width='100%25' height='100%25'/%3E%3Ctext x='50%25' y='50%25' fill='%23333' font-family='monospace' text-anchor='middle' dominant-baseline='middle'%3ENO IMAGE%3C/text%3E%3C/svg%3E">
                    <div
                        style="position:absolute; inset:0; background:linear-gradient(to top, black 20%, transparent 80%);">
                    </div>
                    <div style="position:absolute; inset:10px; border:1px solid rgba(255,255,255,0.2);"></div>
                    <div
                        style="position:absolute; top:20px; width:100%; text-align:center; font-family:var(--f-title); color:var(--danger); font-size:0.9rem; letter-spacing:2px;">
                        NEURO-FRIED // AGENT</div>

                    <div style="position:absolute; bottom:30px; width:100%; text-align:center;">
                        <div style="color:#aaa; font-family:var(--f-mono); margin-bottom:5px;">FINAL AURA</div>
                        <div style="color:var(--green); font-family:var(--f-title); font-size:4rem; text-shadow:0 0 20px var(--green);"
                            id="final-aura-score">0</div>
                        <div style="color:white; font-family:var(--f-title); font-size:1.5rem; letter-spacing:3px;"
                            id="final-name">UNKNOWN</div>
                    </div>
                    <div class="kia-stamp" id="kia-stamp">K.I.A.</div>
                </div>
            </div>

            <!-- RIGHT: Controls Panel -->
            <div class="controls-panel">
                <!-- User Info Readout -->
                <div class="control-row name-row" style="justify-content: center; margin-bottom: 20px;">
                    <span style="color:var(--primary); font-family:var(--f-mono); font-size:1.2rem;">IDENTITY
                        VERIFIED</span>
                </div>

                <!-- Feedback Button - Opens Google Form -->
                <button class="send-feedback-btn" onclick="sendFeedback()">📝 SHARE FEEDBACK</button>

                <!-- Reboot Button -->
                <button class="control-btn reboot-btn" onclick="location.reload()">🔄 REBOOT SYSTEM</button>

                <!-- Leaderboard Button -->
                <button class="control-btn" onclick="showLeaderboard()" style="margin-top:10px;">🏆 LEADERBOARD</button>
            </div>

            <!-- Share Message -->
            <div class="share-message-box">
                <div style="color:var(--green); font-family:var(--f-title); font-size:1rem; line-height:1.4;">
                    TAKE A SCREENSHOT<br>AND REVIVE YOUR<br>HAPPINESS
                </div>
                <div
                    style="color:#888; font-family:var(--f-mono); font-size:0.8rem; margin-top:8px; letter-spacing:1px;">
                    SHARE AMONG ALL
                </div>
            </div>

            <!-- Feedback Button - Opens Google Form -->
            <button class="send-feedback-btn" onclick="sendFeedback()">📝 SHARE FEEDBACK</button>

            <!-- Reboot Button -->
            <button class="control-btn reboot-btn" onclick="location.reload()">🔄 REBOOT SYSTEM</button>

            <!-- Leaderboard Button -->
            <button class="control-btn" onclick="showLeaderboard()" style="margin-top:10px;">🏆 LEADERBOARD</button>
        </div>
    </div>
    </div>

    <script>
        // --- 1. DATA: 20 CATEGORIES (400 Qs Skeleton - Full sample set) ---
        const TOPICS = [
            {
                id: 'finance', name: 'FINANCE & MARKETS', icon: '📈', theme: 't-finance', qs: [
                    { y: 1929, q: "The Great Depression began with...", a: "Black Tuesday", w: ["Red Friday", "Gray Monday"] },
                    { y: 1971, q: "Nixon ended the direct convertibility of the dollar to...", a: "Gold", w: ["Silver", "Oil"] },
                    { y: 1987, q: "Black Monday saw the Dow drop...", a: "22%", w: ["50%", "10%"] },
                    { y: 2001, q: "Enron collapsed due to...", a: "Accounting Fraud", w: ["Market Crash", "Hacks"] },
                    { y: 2008, q: "Bank collapse that sparked the crisis.", a: "Lehman Brothers", w: ["Goldman Sachs", "JP Morgan"] },
                    { y: 2009, q: "Created as a decentralized digital currency.", a: "Bitcoin", w: ["Litecoin", "Ethereum"] },
                    { y: 2021, q: "GameStop stock squeezed by...", a: "Reddit", w: ["Twitter", "Facebook"] },
                    { y: 1944, q: "Bretton Woods established the...", a: "IMF", w: ["WTO", "NATO"] },
                    { y: 1999, q: "Repeal of Glass-Steagall allowed...", a: "Mega Banks", w: ["Crypto", "Offshore"] },
                    { y: 2010, q: "The Flash Crash lasted...", a: "36 Minutes", w: ["1 Hour", "1 Day"] },
                    { y: 2022, q: "FTX Exchange collapsed due to...", a: "Fraud", w: ["Hacks", "Regulation"] },
                    { y: 1933, q: "FDR confiscated private...", a: "Gold", w: ["Guns", "Land"] },
                    { y: 2000, q: "The Dot Com bubble burst caused...", a: "Recession", w: ["Inflation", "War"] },
                    { y: 2023, q: "Silicon Valley Bank failed due to...", a: "Bond Rates", w: ["Crypto", "Hacks"] },
                    { y: 1950, q: "First credit card introduced.", a: "Diners Club", w: ["Visa", "Amex"] },
                    { y: 1998, q: "Long-Term Capital Management...", a: "Collapsed", w: ["Soared", "Merged"] },
                    { y: 2007, q: "The start of the...", a: "Subprime Crisis", w: ["Oil Crisis", "Tech Boom"] },
                    { y: 2017, q: "Bitcoin hit this milestone.", a: "$20,000", w: ["$1,000", "$100,000"] },
                    { y: 1923, q: "Hyperinflation destroyed the...", a: "German Mark", w: ["US Dollar", "Pound"] },
                    { y: 2030, q: "Projected year for...", a: "CBDCs", w: ["Cash End", "Gold Return"] }
                ]
            },
            {
                id: 'coding', name: 'CODE & ALGOS', icon: '💻', theme: 't-code', qs: [
                    { y: 1936, q: "Father of theoretical computer science.", a: "Alan Turing", w: ["Ada Lovelace", "Charles Babbage"] },
                    { y: 1945, q: "First actual computer bug.", a: "Moth", w: ["Ant", "Fly"] },
                    { y: 1957, q: "First high-level language.", a: "FORTRAN", w: ["COBOL", "BASIC"] },
                    { y: 1972, q: "Language created by Dennis Ritchie.", a: "C", w: ["B", "D"] },
                    { y: 1991, q: "Linux kernel was released by...", a: "Linus Torvalds", w: ["Steve Jobs", "Bill Gates"] },
                    { y: 1995, q: "Programming language created in 10 days.", a: "JavaScript", w: ["Java", "Python"] },
                    { y: 2004, q: "Google's email service launched on April 1st.", a: "Gmail", w: ["Hotmail", "Yahoo"] },
                    { y: 2008, q: "GitHub was founded to host...", a: "Git Repos", w: ["SVN", "Mercurial"] },
                    { y: 2009, q: "Language created by Google.", a: "Go", w: ["Rust", "Swift"] },
                    { y: 2014, q: "HTML5 became a...", a: "Standard", w: ["Suggestion", "Law"] },
                    { y: 1983, q: "C++ was released by...", a: "Stroustrup", w: ["Gosling", "Rossum"] },
                    { y: 1991, q: "Python was released by...", a: "Guido van Rossum", w: ["Eich", "Wall"] },
                    { y: 2010, q: "Rust was released by...", a: "Mozilla", w: ["Google", "Apple"] },
                    { y: 2023, q: "AI model that changed coding.", a: "GPT-4", w: ["DeepBlue", "Watson"] },
                    { y: 1969, q: "UNIX was developed at...", a: "Bell Labs", w: ["Xerox PARC", "MIT"] },
                    { y: 1995, q: "Java slogan: Write Once...", a: "Run Anywhere", w: ["Run Fast", "Debug Everywhere"] },
                    { y: 2001, q: "Agile Manifesto was...", a: "Signed", w: ["Rejected", "Lost"] },
                    { y: 2015, q: "VS Code was released by...", a: "Microsoft", w: ["Apple", "Adobe"] },
                    { y: 1989, q: "Python is named after...", a: "Monty Python", w: ["Snake", "Constrictor"] },
                    { y: 2024, q: "Devin AI claimed to be...", a: "First AI Engineer", w: ["Fastest Coder", "Best Debugger"] }
                ]
            },
            {
                id: 'tech', name: 'FUTURE TECH', icon: '🤖', theme: 't-tech', qs: [
                    { y: 1969, q: "Network that became the basis for the Internet.", a: "ARPANET", w: ["SKYNET", "INTRANET"] },
                    { y: 1984, q: "Apple launched Macintosh with...", a: "1984 Ad", w: ["Think Different", "Hello"] },
                    { y: 2007, q: "Device that combined phone, ipod, and communicator.", a: "iPhone", w: ["Blackberry", "Palm Pilot"] },
                    { y: 2016, q: "AI that defeated the Go world champion.", a: "AlphaGo", w: ["DeepBlue", "Watson"] },
                    { y: 2023, q: "Large Language Model released by OpenAI.", a: "GPT-4", w: ["Bard", "Llama"] },
                    { y: 2024, q: "Apple's Spatial Computer.", a: "Vision Pro", w: ["Oculus", "Hololens"] },
                    { y: 1977, q: "First complete personal computer.", a: "Apple II", w: ["Altair", "Commodore"] },
                    { y: 1998, q: "Google was founded in a...", a: "Garage", w: ["Dorm", "Office"] },
                    { y: 2001, q: "Wikipedia was launched by...", a: "Jimmy Wales", w: ["Assange", "Snowden"] },
                    { y: 2011, q: "Siri was integrated into...", a: "iPhone 4S", w: ["iPhone 3G", "iPhone 5"] },
                    { y: 1989, q: "World Wide Web invented by...", a: "Tim Berners-Lee", w: ["Al Gore", "Vint Cerf"] },
                    { y: 2004, q: "Firefox 1.0 challenged...", a: "Internet Explorer", w: ["Netscape", "Opera"] },
                    { y: 2012, q: "Google Glass was a...", a: "Flop", w: ["Hit", "Standard"] },
                    { y: 2020, q: "Zoom became the standard for...", a: "Meetings", w: ["Gaming", "Dating"] },
                    { y: 1990, q: "Photoshop 1.0 released for...", a: "Macintosh", w: ["Windows", "Linux"] },
                    { y: 2006, q: "Tesla Roadster revealed.", a: "Electric Car", w: ["Hybrid", "Hydrogen"] },
                    { y: 2015, q: "OpenAI was founded.", a: "Non-Profit", w: ["For-Profit", "Gov Org"] },
                    { y: 1979, q: "Sony Walkman changed...", a: "Music", w: ["Video", "Gaming"] },
                    { y: 2022, q: "DALL-E 2 generated...", a: "Images", w: ["Video", "Music"] },
                    { y: 2025, q: "The Singularity is...", a: "Near", w: ["Far", "Impossible"] }
                ]
            },
            {
                id: 'social', name: 'SOCIAL MEDIA', icon: '📱', theme: 't-social', qs: [
                    { y: 2004, q: "The Facebook started at...", a: "Harvard", w: ["Yale", "Stanford"] },
                    { y: 2006, q: "Twitter's original character limit.", a: "140", w: ["280", "100"] },
                    { y: 2010, q: "Instagram launched for...", a: "iOS Only", w: ["Android", "Web"] },
                    { y: 2011, q: "Snapchat's key feature.", a: "Disappearing", w: ["Filters", "Stories"] },
                    { y: 2016, q: "TikTok original name.", a: "Douyin", w: ["Musical.ly", "Vine"] },
                    { y: 2003, q: "First major social network.", a: "MySpace", w: ["Friendster", "Hi5"] },
                    { y: 2005, q: "YouTube's first video.", a: "Me at the zoo", w: ["Cat video", "Dance"] },
                    { y: 2012, q: "Facebook bought Instagram for...", a: "$1 Billion", w: ["$500 Million", "$10 Billion"] },
                    { y: 2013, q: "Vine introduced...", a: "6 sec videos", w: ["Stories", "Live"] },
                    { y: 2018, q: "Cambridge Analytica scandal hit...", a: "Facebook", w: ["Twitter", "Google"] },
                    { y: 2022, q: "Elon Musk bought Twitter for...", a: "$44 Billion", w: ["$20 Billion", "$100 Billion"] },
                    { y: 2007, q: "Hashtags were invented on...", a: "Twitter", w: ["Instagram", "Facebook"] },
                    { y: 2020, q: "BeReal encouraged...", a: "Authenticity", w: ["Filters", "Ads"] },
                    { y: 2011, q: "Google+ was a...", a: "Failure", w: ["Success", "Standard"] },
                    { y: 2014, q: "Amazon bought Twitch.", a: "Streaming", w: ["Shopping", "Gaming"] },
                    { y: 2004, q: "Digg was a news...", a: "Aggregator", w: ["Creator", "Paper"] },
                    { y: 2010, q: "Pinterest launched for...", a: "Moodboards", w: ["Dating", "Jobs"] },
                    { y: 2016, q: "Pokemon GO was...", a: "Social AR", w: ["VR", "Console"] },
                    { y: 2023, q: "Threads challenged...", a: "Twitter", w: ["Reddit", "TikTok"] },
                    { y: 2008, q: "Spotify launched in...", a: "Europe", w: ["USA", "Asia"] }
                ]
            },
            {
                id: 'space', name: 'COSMIC FRONTIER', icon: '🚀', theme: 't-space', qs: [
                    { y: 1957, q: "First satellite in orbit.", a: "Sputnik 1", w: ["Explorer", "Vostok"] },
                    { y: 1969, q: "Apollo 11 landed on...", a: "The Moon", w: ["Mars", "Venus"] },
                    { y: 1990, q: "Telescope launched into orbit.", a: "Hubble", w: ["Webb", "Kepler"] },
                    { y: 2015, q: "SpaceX landed a...", a: "Rocket Booster", w: ["Shuttle", "Capsule"] },
                    { y: 2022, q: "Successor to Hubble.", a: "James Webb", w: ["Galileo", "Copernicus"] },
                    { y: 1961, q: "First human in space.", a: "Yuri Gagarin", w: ["Shepard", "Glenn"] },
                    { y: 1986, q: "Challenger disaster involved...", a: "O-Rings", w: ["Engine", "Fuel"] },
                    { y: 2012, q: "Curiosity Rover landed on...", a: "Mars", w: ["Moon", "Titan"] },
                    { y: 1977, q: "Voyager probes carry...", a: "Golden Record", w: ["CD", "Map"] },
                    { y: 1998, q: "ISS construction...", a: "Began", w: ["Ended", "Failed"] },
                    { y: 2003, q: "Columbia disaster on...", a: "Re-entry", w: ["Launch", "Orbit"] },
                    { y: 2020, q: "SpaceX launched humans to...", a: "ISS", w: ["Moon", "Mars"] },
                    { y: 1969, q: "Armstrong's first word.", a: "Houston", w: ["Eagle", "Step"] },
                    { y: 2019, q: "First image of a...", a: "Black Hole", w: ["Quasar", "Pulsar"] },
                    { y: 1958, q: "NASA was...", a: "Founded", w: ["Ended", "Merged"] },
                    { y: 2021, q: "Perseverance landed with...", a: "Helicopter", w: ["Bike", "Boat"] },
                    { y: 1972, q: "Last moon landing.", a: "Apollo 17", w: ["Apollo 11", "Apollo 13"] },
                    { y: 2006, q: "Pluto was...", a: "Demoted", w: ["Discovered", "Exploded"] },
                    { y: 2024, q: "Artemis mission targets...", a: "Moon", w: ["Mars", "Asteroid"] },
                    { y: 2030, q: "Goal for Mars...", a: "Landing", w: ["Colony", "Flyby"] }
                ]
            },
            {
                id: 'gaming', name: 'GAMING HISTORY', icon: '🎮', theme: 't-gaming', qs: [
                    { y: 1985, q: "Nintendo saved the industry with...", a: "NES", w: ["Atari", "Sega"] },
                    { y: 1993, q: "FPS that caused controversy.", a: "DOOM", w: ["Quake", "Halo"] },
                    { y: 1996, q: "Mario went...", a: "3D", w: ["VR", "Online"] },
                    { y: 2004, q: "WoW defined...", a: "MMORPGs", w: ["FPS", "RTS"] },
                    { y: 2011, q: "Minecraft officially...", a: "Released", w: ["Beta", "Alpha"] },
                    { y: 1980, q: "Pac-Man was created by...", a: "Namco", w: ["Nintendo", "Sega"] },
                    { y: 1989, q: "Game Boy launched with...", a: "Tetris", w: ["Mario", "Zelda"] },
                    { y: 1991, q: "Sonic challenged...", a: "Mario", w: ["Zelda", "Link"] },
                    { y: 1997, q: "Final Fantasy VII on...", a: "PlayStation", w: ["N64", "Saturn"] },
                    { y: 2000, q: "PS2 became the...", a: "Best Seller", w: ["Worst", "Average"] },
                    { y: 2001, q: "Halo launched with...", a: "Xbox", w: ["PS2", "GameCube"] },
                    { y: 2006, q: "Wii introduced...", a: "Motion", w: ["VR", "4K"] },
                    { y: 2013, q: "GTA V broke...", a: "Sales Records", w: ["Consoles", "Laws"] },
                    { y: 2017, q: "Switch combined...", a: "Home & Handheld", w: ["VR & AR", "PC & Console"] },
                    { y: 2020, q: "Cyberpunk 2077 had a...", a: "Rough Launch", w: ["Perfect Launch", "Delay"] },
                    { y: 1972, q: "Pong was the...", a: "First Hit", w: ["Last Hit", "Flop"] },
                    { y: 1998, q: "Ocarina of Time set...", a: "Standards", w: ["Records", "Traps"] },
                    { y: 2007, q: "Portal introduced...", a: "Portals", w: ["Guns", "Zombies"] },
                    { y: 2018, q: "Fortnite popularized...", a: "Battle Royale", w: ["FPS", "RPG"] },
                    { y: 2022, q: "Elden Ring won...", a: "GOTY", w: ["Nothing", "Indie"] }
                ]
            },
            {
                id: 'cyber', name: 'CYBER SECURITY', icon: '🔒', theme: 't-cyber', qs: [
                    { y: 1988, q: "The Morris Worm was the...", a: "First Worm", w: ["Virus", "Trojan"] },
                    { y: 2010, q: "Stuxnet targeted...", a: "Iran Nuclear", w: ["US Banks", "Russia"] },
                    { y: 2013, q: "Snowden revealed...", a: "NSA Spying", w: ["CIA Plots", "FBI"] },
                    { y: 2017, q: "WannaCry was...", a: "Ransomware", w: ["Spyware", "Adware"] },
                    { y: 2020, q: "SolarWinds hack affected...", a: "US Gov", w: ["Facebook", "Google"] },
                    { y: 1995, q: "Kevin Mitnick was...", a: "Arrested", w: ["Hired", "Found"] },
                    { y: 2000, q: "ILOVEYOU virus spread via...", a: "Email", w: ["USB", "Web"] },
                    { y: 2014, q: "Mt. Gox lost...", a: "Bitcoin", w: ["Dollars", "Gold"] },
                    { y: 2011, q: "PSN was...", a: "Hacked", w: ["Upgraded", "Sold"] },
                    { y: 2016, q: "Mirai Botnet used...", a: "IoT Devices", w: ["PCs", "Phones"] },
                    { y: 2019, q: "Capital One breach via...", a: "Firewall", w: ["Phishing", "Physical"] },
                    { y: 2021, q: "Colonial Pipeline paid...", a: "Ransom", w: ["Taxes", "Nothing"] },
                    { y: 2022, q: "Lapsus$ hacked...", a: "Nvidia", w: ["AMD", "Intel"] },
                    { y: 2008, q: "Conficker worm infected...", a: "Millions", w: ["Thousands", "Hundreds"] },
                    { y: 2015, q: "Ashley Madison data...", a: "Leaked", w: ["Saved", "Lost"] },
                    { y: 2018, q: "GDPR enacted for...", a: "Privacy", w: ["Speed", "Security"] },
                    { y: 2023, q: "MGM Resorts...", a: "Hacked", w: ["Closed", "Sold"] },
                    { y: 1999, q: "Melissa Virus was a...", a: "Macro", w: ["Micro", "Nano"] },
                    { y: 2012, q: "LinkedIn passwords...", a: "Stolen", w: ["Reset", "Sold"] },
                    { y: 2024, q: "AI Phishing is...", a: "Rising", w: ["Falling", "Stable"] }
                ]
            },
            {
                id: 'mobile', name: 'MOBILE PHONES', icon: '📵', theme: 't-mobile', qs: [
                    { y: 1973, q: "First mobile call by...", a: "Motorola", w: ["Nokia", "Bell"] },
                    { y: 1983, q: "Motorola DynaTAC price.", a: "$4000", w: ["$1000", "$500"] },
                    { y: 2000, q: "The indestructible phone.", a: "Nokia 3310", w: ["Razr", "Ericsson"] },
                    { y: 2007, q: "iPhone introduced...", a: "Multi-touch", w: ["Stylus", "Keyboard"] },
                    { y: 2008, q: "Android launched on...", a: "HTC Dream", w: ["Samsung", "Pixel"] },
                    { y: 1992, q: "First Smartphone concept.", a: "IBM Simon", w: ["Apple Newton", "Palm"] },
                    { y: 2004, q: "Moto Razr was a...", a: "Fashion Icon", w: ["Smart Phone", "Brick"] },
                    { y: 2010, q: "iPhone 4 scandal.", a: "Antennagate", w: ["Bendgate", "Battery"] },
                    { y: 2016, q: "Samsung Note 7...", a: "Exploded", w: ["Cracked", "Lost"] },
                    { y: 1999, q: "Blackberry introduced...", a: "Email", w: ["Games", "Music"] },
                    { y: 2002, q: "Nokia 7650 had a...", a: "Camera", w: ["GPS", "Wifi"] },
                    { y: 2017, q: "iPhone X removed...", a: "Home Button", w: ["Screen", "Cam"] },
                    { y: 2009, q: "App Store slogan.", a: "There's an app", w: ["Download it", "Get it"] },
                    { y: 2011, q: "Galaxy Note popularized...", a: "Phablets", w: ["Tablets", "Watches"] },
                    { y: 2019, q: "Foldable phones...", a: "Returned", w: ["Died", "Exploded"] },
                    { y: 2020, q: "5G rollout...", a: "Began", w: ["Ended", "Failed"] },
                    { y: 1996, q: "StarTAC was the first...", a: "Clamshell", w: ["Slider", "Touch"] },
                    { y: 2013, q: "Fingerprint sensor on...", a: "iPhone 5S", w: ["iPhone 5", "iPhone 6"] },
                    { y: 2023, q: "USB-C on iPhone...", a: "15", w: ["14", "13"] },
                    { y: 2005, q: "Google bought...", a: "Android", w: ["Nokia", "HTC"] }
                ]
            },
            {
                id: 'internet', name: 'INTERNET CULTURE', icon: '🌐', theme: 't-net', qs: [
                    { y: 1993, q: "Eternal September began on...", a: "Usenet", w: ["Reddit", "Digg"] },
                    { y: 1996, q: "Dancing Baby was a...", a: "Meme", w: ["Virus", "Game"] },
                    { y: 2005, q: "First YouTube video.", a: "Me at zoo", w: ["Cats", "Shoes"] },
                    { y: 2007, q: "Rickrolling uses...", a: "Never Gonna", w: ["Sandstorm", "Halo"] },
                    { y: 2012, q: "Gangnam Style hit...", a: "1 Billion", w: ["1 Million", "1 Trillion"] },
                    { y: 1998, q: "Hamster Dance was...", a: "Viral", w: ["Viral", "Dead"] },
                    { y: 2004, q: "Numa Numa guy...", a: "Lip Synced", w: ["Danced", "Sang"] },
                    { y: 2006, q: "Lonelygirl15 was...", a: "Fake", w: ["Real", "Alien"] },
                    { y: 2011, q: "Nyan Cat is a...", a: "Pop Tart", w: ["Toast", "Bread"] },
                    { y: 2013, q: "The Fox says...", a: "Ring Ding", w: ["Meow", "Woof"] },
                    { y: 2015, q: "The Dress was...", a: "Blue/Black", w: ["Gold/White", "Red/Green"] },
                    { y: 2016, q: "Harambe became a...", a: "Symbol", w: ["Pet", "Logo"] },
                    { y: 2019, q: "Storm Area 51...", a: "Failed", w: ["Succeeded", "Happened"] },
                    { y: 2009, q: "David After...", a: "Dentist", w: ["School", "Doctor"] },
                    { y: 2010, q: "Bed Intruder...", a: "Song", w: ["Movie", "Book"] },
                    { y: 2014, q: "Ice Bucket Challenge for...", a: "ALS", w: ["Cancer", "Flu"] },
                    { y: 2018, q: "Tide Pods are not...", a: "Food", w: ["Soap", "Toys"] },
                    { y: 2007, q: "Charlie bit my...", a: "Finger", w: ["Toe", "Ear"] },
                    { y: 2020, q: "Coffin Dance...", a: "Meme", w: ["Song", "Dance"] },
                    { y: 2012, q: "Overly Attached...", a: "Girlfriend", w: ["Boyfriend", "Mom"] }
                ]
            },
            {
                id: 'chips', name: 'HARDWARE', icon: '💾', theme: 't-hard', qs: [
                    { y: 1965, q: "Moore's Law involves...", a: "Transistors", w: ["Heat", "Cost"] },
                    { y: 1971, q: "First Microprocessor.", a: "Intel 4004", w: ["8086", "Pentium"] },
                    { y: 1993, q: "Pentium processor by...", a: "Intel", w: ["AMD", "IBM"] },
                    { y: 2006, q: "Core 2 Duo introduced...", a: "Multi-core", w: ["Speed", "Heat"] },
                    { y: 2020, q: "Apple M1 chip used...", a: "ARM", w: ["x86", "RISC"] },
                    { y: 1981, q: "IBM PC used...", a: "Intel 8088", w: ["Motorola", "Zilog"] },
                    { y: 1999, q: "Nvidia invented the...", a: "GPU", w: ["CPU", "APU"] },
                    { y: 2017, q: "Ryzen challenged...", a: "Intel", w: ["Nvidia", "Apple"] },
                    { y: 1958, q: "Integrated Circuit...", a: "Invented", w: ["Lost", "Sold"] },
                    { y: 1985, q: "Amiga used...", a: "Custom Chips", w: ["Standard", "None"] },
                    { y: 2011, q: "Raspberry Pi is a...", a: "Tiny PC", w: ["Cake", "Toy"] },
                    { y: 2000, q: "USB drives replaced...", a: "Floppies", w: ["CDs", "DVDs"] },
                    { y: 2012, q: "SSD prices...", a: "Dropped", w: ["Rose", "Stalled"] },
                    { y: 1995, q: "3dfx Voodoo was for...", a: "Graphics", w: ["Sound", "Net"] },
                    { y: 2022, q: "RTX 4090 requires...", a: "Power", w: ["Water", "Air"] },
                    { y: 2005, q: "Xbox 360 used...", a: "PowerPC", w: ["x86", "ARM"] },
                    { y: 1991, q: "Sound Blaster...", a: "Audio", w: ["Video", "Net"] },
                    { y: 2015, q: "USB-C introduced...", a: "Reversibility", w: ["Speed", "Power"] },
                    { y: 1976, q: "Cray-1 was a...", a: "Supercomputer", w: ["Laptop", "Phone"] },
                    { y: 2024, q: "Chips Act boosts...", a: "US Fab", w: ["China", "EU"] }
                ]
            },
            {
                id: 'os', name: 'OPERATING SYS', icon: '💿', theme: 't-os', qs: [
                    { y: 1981, q: "MS-DOS launched with...", a: "IBM PC", w: ["Apple", "Compaq"] },
                    { y: 1984, q: "MacOS introduced...", a: "GUI", w: ["CLI", "Touch"] },
                    { y: 1995, q: "Windows 95 brought...", a: "Start Menu", w: ["Tiles", "Dock"] },
                    { y: 2001, q: "Windows XP was...", a: "Beloved", w: ["Hated", "Ignored"] },
                    { y: 2015, q: "Windows 10 was the...", a: "Last Version", w: ["First", "Best"] },
                    { y: 1991, q: "Linux Kernel...", a: "Released", w: ["Sold", "Closed"] },
                    { y: 1985, q: "Windows 1.0 was a...", a: "Shell", w: ["OS", "App"] },
                    { y: 2007, q: "iOS was based on...", a: "OS X", w: ["Linux", "Windows"] },
                    { y: 2009, q: "Windows 7 fixed...", a: "Vista", w: ["XP", "98"] },
                    { y: 2001, q: "Mac OS X used...", a: "Unix", w: ["DOS", "Linux"] },
                    { y: 2012, q: "Windows 8 removed...", a: "Start Btn", w: ["Desktop", "Mouse"] },
                    { y: 1969, q: "Unix created at...", a: "Bell Labs", w: ["MIT", "Stanford"] },
                    { y: 1990, q: "Windows 3.0 was a...", a: "Hit", w: ["Flop", "Bug"] },
                    { y: 2004, q: "Ubuntu made Linux...", a: "Easy", w: ["Hard", "Fast"] },
                    { y: 2008, q: "Android is based on...", a: "Linux", w: ["Java", "Windows"] },
                    { y: 2021, q: "Windows 11 centered...", a: "Taskbar", w: ["Windows", "Icons"] },
                    { y: 1993, q: "Windows NT was...", a: "32-bit", w: ["16-bit", "64-bit"] },
                    { y: 1987, q: "OS/2 was by...", a: "IBM/MS", w: ["Apple", "Dell"] },
                    { y: 2011, q: "ChromeOS runs...", a: "Web Apps", w: ["Exe", "Dmg"] },
                    { y: 2000, q: "Windows ME was...", a: "Unstable", w: ["Great", "Fast"] }
                ]
            },
            {
                id: 'crypto', name: 'CRYPTO & WEB3', icon: '⛓️', theme: 't-crypto', qs: [
                    { y: 2009, q: "Bitcoin Genesis Block.", a: "Jan 3", w: ["Dec 25", "Jan 1"] },
                    { y: 2015, q: "Ethereum launched...", a: "Smart Contracts", w: ["NFTs", "Mining"] },
                    { y: 2013, q: "Dogecoin started as...", a: "Joke", w: ["Scam", "Bank"] },
                    { y: 2017, q: "ICO Boom raised...", a: "Billions", w: ["Millions", "Trillions"] },
                    { y: 2022, q: "The Merge moved ETH to...", a: "Proof of Stake", w: ["Work", "History"] },
                    { y: 2010, q: "Bitcoin Pizza cost...", a: "10k BTC", w: ["100 BTC", "1k BTC"] },
                    { y: 2014, q: "Mt Gox hack lost...", a: "850k BTC", w: ["100k", "1M"] },
                    { y: 2021, q: "Beeple NFT sold for...", a: "$69M", w: ["$1M", "$100k"] },
                    { y: 2011, q: "Silk Road used...", a: "Bitcoin", w: ["Cash", "Card"] },
                    { y: 2016, q: "The DAO was...", a: "Hacked", w: ["Success", "Sold"] },
                    { y: 2022, q: "Terra Luna...", a: "Crashed", w: ["Mooned", "Stayed"] },
                    { y: 2008, q: "Whitepaper by...", a: "Satoshi", w: ["Vitalik", "CZ"] },
                    { y: 2020, q: "DeFi Summer...", a: "Exploded", w: ["Failed", "Stopped"] },
                    { y: 2017, q: "CryptoKitties clogged...", a: "Ethereum", w: ["Bitcoin", "Solana"] },
                    { y: 2021, q: "El Salvador adopted...", a: "Bitcoin", w: ["ETH", "Doge"] },
                    { y: 2018, q: "Crypto Winter...", a: "Froze", w: ["Heated", "Melted"] },
                    { y: 2024, q: "Bitcoin ETF...", a: "Approved", w: ["Denied", "Pending"] },
                    { y: 2019, q: "Facebook Libra...", a: "Failed", w: ["Launched", "Succeeded"] },
                    { y: 2021, q: "Bored Apes...", a: "Minted", w: ["Sold", "Lost"] },
                    { y: 2013, q: "Vitalik proposed...", a: "Ethereum", w: ["Bitcoin 2", "Solana"] }
                ]
            },
            {
                id: 'vr', name: 'VR & AR', icon: '🥽', theme: 't-vr', qs: [
                    { y: 2012, q: "Oculus Kickstarter.", a: "Palmer Luckey", w: ["Zuckerberg", "Carmack"] },
                    { y: 2016, q: "HTC Vive used...", a: "Lighthouses", w: ["Cameras", "Lasers"] },
                    { y: 2014, q: "Facebook bought Oculus.", a: "$2B", w: ["$1B", "$500M"] },
                    { y: 2019, q: "Oculus Quest was...", a: "Standalone", w: ["PC Only", "Phone"] },
                    { y: 2024, q: "Apple Vision Pro.", a: "Spatial", w: ["Virtual", "Augmented"] },
                    { y: 1995, q: "Virtual Boy was...", a: "Red", w: ["Blue", "Green"] },
                    { y: 2016, q: "PSVR launched for...", a: "PS4", w: ["PS3", "PS5"] },
                    { y: 2020, q: "Half-Life: Alyx...", a: "VR Only", w: ["PC", "Console"] },
                    { y: 2011, q: "Ready Player One...", a: "Book", w: ["Movie", "Game"] },
                    { y: 2015, q: "Google Cardboard...", a: "Cheap", w: ["Expensive", "Complex"] },
                    { y: 2021, q: "Metaverse hype...", a: "Peaked", w: ["Died", "Started"] },
                    { y: 1968, q: "Sword of Damocles...", a: "First HMD", w: ["Game", "Movie"] },
                    { y: 2018, q: "Beat Saber...", a: "Hit", w: ["Miss", "Flop"] },
                    { y: 2016, q: "Pokemon GO is...", a: "AR", w: ["VR", "MR"] },
                    { y: 2013, q: "Google Glass...", a: "Failed", w: ["Won", "Stayed"] },
                    { y: 2022, q: "Meta Quest Pro...", a: "Expensive", w: ["Cheap", "Free"] },
                    { y: 1992, q: "Lawnmower Man...", a: "Movie", w: ["Game", "Book"] },
                    { y: 2019, q: "Valve Index...", a: "Finger Tracking", w: ["Eye", "Body"] },
                    { y: 2023, q: "Quest 3...", a: "Mixed Reality", w: ["VR", "AR"] },
                    { y: 1990, q: "Virtuality Arcade...", a: "Machines", w: ["Consoles", "PCs"] }
                ]
            },
            {
                id: 'ai', name: 'AI REVOLUTION', icon: '🧠', theme: 't-ai', qs: [
                    { y: 2022, q: "ChatGPT launch.", a: "Nov 30", w: ["Jan 1", "Dec 25"] },
                    { y: 2016, q: "AlphaGo beat...", a: "Lee Sedol", w: ["Kasparov", "Carlsen"] },
                    { y: 1950, q: "Turing Test...", a: "Proposed", w: ["Solved", "Failed"] },
                    { y: 1997, q: "Deep Blue beat...", a: "Kasparov", w: ["Sedol", "Fischer"] },
                    { y: 2023, q: "GPT-4 release.", a: "Multimodal", w: ["Text", "Image"] },
                    { y: 2011, q: "Watson won...", a: "Jeopardy", w: ["Chess", "Go"] },
                    { y: 2012, q: "AlexNet breakthrough.", a: "Vision", w: ["Text", "Audio"] },
                    { y: 2017, q: "Transformer paper.", a: "Attention", w: ["Memory", "Speed"] },
                    { y: 2021, q: "DALL-E generated...", a: "Images", w: ["Video", "Text"] },
                    { y: 2014, q: "GANs invented by...", a: "Goodfellow", w: ["Hinton", "LeCun"] },
                    { y: 2020, q: "GPT-3 released.", a: "175B Params", w: ["100B", "1T"] },
                    { y: 1956, q: "Dartmouth Workshop.", a: "AI Born", w: ["AI Died", "AI Peak"] },
                    { y: 1966, q: "ELIZA chatbot.", a: "Therapist", w: ["Friend", "Enemy"] },
                    { y: 2015, q: "OpenAI founded.", a: "Non-profit", w: ["For-profit", "Gov"] },
                    { y: 2024, q: "Sora generates...", a: "Video", w: ["Audio", "Code"] },
                    { y: 2018, q: "BERT model by...", a: "Google", w: ["Meta", "OpenAI"] },
                    { y: 2006, q: "Deep Learning...", a: "Rebranded", w: ["Invented", "Lost"] },
                    { y: 2023, q: "Bard became...", a: "Gemini", w: ["Bing", "Chat"] },
                    { y: 1980, q: "Expert Systems...", a: "Peak", w: ["Start", "End"] },
                    { y: 2025, q: "AGI is...", a: "Prediction", w: ["Here", "Gone"] }
                ]
            },
            {
                id: 'founder', name: 'TECH FOUNDERS', icon: '👔', theme: 't-founder', qs: [
                    { y: 1976, q: "Jobs & Wozniak founded...", a: "Apple", w: ["Microsoft", "IBM"] },
                    { y: 1975, q: "Gates & Allen founded...", a: "Microsoft", w: ["Apple", "Intel"] },
                    { y: 1994, q: "Bezos founded...", a: "Amazon", w: ["eBay", "PayPal"] },
                    { y: 1998, q: "Page & Brin founded...", a: "Google", w: ["Yahoo", "Bing"] },
                    { y: 2004, q: "Zuckerberg founded...", a: "Facebook", w: ["Twitter", "Snap"] },
                    { y: 2002, q: "Musk founded...", a: "SpaceX", w: ["Tesla", "PayPal"] },
                    { y: 1968, q: "Moore & Noyce...", a: "Intel", w: ["AMD", "Nvidia"] },
                    { y: 1993, q: "Jensen Huang...", a: "Nvidia", w: ["ATI", "Intel"] },
                    { y: 1984, q: "Michael Dell...", a: "Dell", w: ["HP", "Compaq"] },
                    { y: 2006, q: "Jack Dorsey...", a: "Twitter", w: ["Square", "Vine"] },
                    { y: 2008, q: "Brian Chesky...", a: "Airbnb", w: ["Uber", "Lyft"] },
                    { y: 2009, q: "Travis Kalanick...", a: "Uber", w: ["Lyft", "Grab"] },
                    { y: 2011, q: "Evan Spiegel...", a: "Snapchat", w: ["Insta", "FB"] },
                    { y: 1977, q: "Larry Ellison...", a: "Oracle", w: ["SAP", "Salesforce"] },
                    { y: 2012, q: "Vitalik Buterin...", a: "Ethereum", w: ["Bitcoin", "Solana"] },
                    { y: 1995, q: "Pierre Omidyar...", a: "eBay", w: ["Amazon", "Craigslist"] },
                    { y: 2007, q: "Reed Hastings...", a: "Netflix", w: ["Hulu", "Disney"] },
                    { y: 2010, q: "Kevin Systrom...", a: "Instagram", w: ["Vine", "TikTok"] },
                    { y: 1939, q: "Hewlett & Packard...", a: "HP", w: ["IBM", "Dell"] },
                    { y: 2005, q: "Sam Altman...", a: "Y Combinator", w: ["OpenAI", "Reddit"] }
                ]
            },
            {
                id: 'phys', name: 'PHYSICS', icon: '⚛️', theme: 't-phys', qs: [
                    { y: 1905, q: "Einstein's...", a: "Annus Mirabilis", w: ["Year", "Day"] },
                    { y: 1915, q: "General Relativity...", a: "Published", w: ["Written", "Lost"] },
                    { y: 1945, q: "Trinity Test...", a: "Atomic Bomb", w: ["H-Bomb", "TNT"] },
                    { y: 1964, q: "Higgs mechanism...", a: "Proposed", w: ["Found", "Lost"] },
                    { y: 2012, q: "Higgs Boson...", a: "Discovered", w: ["Lost", "Hidden"] },
                    { y: 1927, q: "Solvay Conference...", a: "Quantum", w: ["Relativity", "Light"] },
                    { y: 1986, q: "Chernobyl...", a: "Meltdown", w: ["Test", "Fire"] },
                    { y: 2015, q: "Gravitational Waves...", a: "Detected", w: ["Seen", "Heard"] },
                    { y: 1990, q: "Webb construction...", a: "Began", w: ["Ended", "Launched"] },
                    { y: 1965, q: "Cosmic Background...", a: "Found", w: ["Lost", "Hidden"] },
                    { y: 1935, q: "Schrodinger's...", a: "Cat", w: ["Dog", "Rat"] },
                    { y: 1954, q: "CERN established.", a: "Geneva", w: ["Paris", "London"] },
                    { y: 2019, q: "Black Hole...", a: "Imaged", w: ["Found", "Lost"] },
                    { y: 1974, q: "Hawking Radiation...", a: "Proposed", w: ["Found", "Seen"] },
                    { y: 1911, q: "Superconductivity...", a: "Discovered", w: ["Invented", "Lost"] },
                    { y: 2022, q: "Fusion Ignition...", a: "Achieved", w: ["Failed", "Tried"] },
                    { y: 1900, q: "Planck's...", a: "Constant", w: ["Variable", "Number"] },
                    { y: 1924, q: "Hubble found...", a: "Galaxies", w: ["Stars", "Planets"] },
                    { y: 1995, q: "Top Quark...", a: "Found", w: ["Lost", "Hidden"] },
                    { y: 2011, q: "Neutrinos...", a: "Faster?", w: ["Slower", "Same"] }
                ]
            },
            {
                id: 'startup', name: 'TECH HUSTLE', icon: '💼', theme: 't-startup', qs: [
                    { y: 2000, q: "Dot Com...", a: "Bubble", w: ["Boom", "Bang"] },
                    { y: 2008, q: "Airbnb founded during...", a: "Recession", w: ["Boom", "War"] },
                    { y: 2010, q: "WeWork founded.", a: "Coworking", w: ["Living", "Eating"] },
                    { y: 2019, q: "WeWork IPO...", a: "Failed", w: ["Soared", "Okay"] },
                    { y: 2022, q: "Theranos founder...", a: "Convicted", w: ["Freed", "Hired"] },
                    { y: 2009, q: "Uber founded as...", a: "UberCab", w: ["Taxi", "Lyft"] },
                    { y: 2011, q: "Zoom founded.", a: "Video", w: ["Chat", "Phone"] },
                    { y: 2013, q: "Slack launched.", a: "Messaging", w: ["Email", "Video"] },
                    { y: 2005, q: "Y Combinator...", a: "Started", w: ["Ended", "Sold"] },
                    { y: 2012, q: "Coinbase founded.", a: "Crypto", w: ["Bank", "Stock"] },
                    { y: 2014, q: "Magic Leap...", a: "Hype", w: ["Real", "Fake"] },
                    { y: 2020, q: "Snowflake IPO.", a: "Cloud", w: ["Data", "Web"] },
                    { y: 2021, q: "Rivian IPO.", a: "EV", w: ["Gas", "Hybrid"] },
                    { y: 2006, q: "Spotify founded.", a: "Music", w: ["Video", "Pod"] },
                    { y: 2015, q: "Juicero...", a: "Failed", w: ["Won", "Sold"] },
                    { y: 2003, q: "Tesla founded.", a: "EVs", w: ["Gas", "Solar"] },
                    { y: 2016, q: "Quibi...", a: "Short", w: ["Long", "Med"] },
                    { y: 2020, q: "Quibi...", a: "Died", w: ["Lived", "Sold"] },
                    { y: 1999, q: "Pets.com...", a: "Icon", w: ["Store", "Site"] },
                    { y: 2018, q: "Robinhood...", a: "Trading", w: ["Bank", "Loan"] }
                ]
            },
            {
                id: 'bio', name: 'BIOTECH & FUTURE', icon: '🧬', theme: 't-bio', qs: [
                    { y: 1953, q: "Watson and Crick famously discovered the double helix structure of what?", a: "DNA", w: ["RNA", "Proteins"] },
                    { y: 1996, q: "Dolly became the first mammal cloned from an adult cell. What animal was she?", a: "Sheep", w: ["Cow", "Goat"] },
                    { y: 2003, q: "The Human Genome Project completed the sequencing of what?", a: "Human DNA", w: ["Monkey DNA", "Virus DNA"] },
                    { y: 2012, q: "CRISPR-Cas9 technology was developed to perform what function?", a: "Gene Editing", w: ["Cloning", "Sequencing"] },
                    { y: 2020, q: "Pfizer and Moderna released vaccines for COVID-19 using which technology?", a: "mRNA", w: ["Viral Vector", "Inactivated Virus"] },
                    { y: 1978, q: "Louise Brown was the first human born via which method?", a: "IVF", w: ["Surrogacy", "Cloning"] },
                    { y: 1990, q: "The Human Genome Project began. How much did it initially cost?", a: "$3 Billion", w: ["$3 Million", "$300 Billion"] },
                    { y: 2006, q: "23andMe was founded to provide what service to consumers?", a: "Genetic Testing", w: ["Ancestry Books", "Medical Advice"] },
                    { y: 2018, q: "Scientist He Jiankui was condemned for creating the first...", a: "Gene-Edited Babies", w: ["Cloned Humans", "Super Soldiers"] },
                    { y: 1928, q: "Alexander Fleming discovered Penicillin, which is what type of drug?", a: "Antibiotic", w: ["Painkiller", "Antiviral"] },
                    { y: 1983, q: "PCR technology allowed scientists to amplify what?", a: "DNA Segments", w: ["Blood Cells", "Neurons"] },
                    { y: 2024, q: "Neuralink successfully implanted its device in a human. What does it do?", a: "Brain-Computer Interface", w: ["Memory Erasure", "Vision Restoration"] },
                    { y: 2013, q: "The first lab-grown burger was eaten in London. What was its price tag?", a: "$330,000", w: ["$3,300", "$33"] },
                    { y: 2001, q: "One week after 9/11, letters containing which deadly spores were mailed?", a: "Anthrax", w: ["Smallpox", "Ricin"] },
                    { y: 1951, q: "The immortal 'HeLa' cells were taken without consent from whom?", a: "Henrietta Lacks", w: ["Rosa Parks", "Marie Curie"] },
                    { y: 2022, q: "Surgeons successfully transplanted a heart from which animal into a human?", a: "Pig", w: ["Chimpanzee", "Cow"] },
                    { y: 1997, q: "The film 'Gattaca' explored a future society based on what?", a: "Eugenics", w: ["Robotics", "Virtual Reality"] },
                    { y: 2015, q: "Elizabeth Holmes was exposed for fraud regarding her company, Theranos. What did it promise?", a: "Blood Testing", w: ["Anti-Aging", "Brain Uploading"] },
                    { y: 1980, q: "The Supreme Court ruled that man-made organisms could be...", a: "Patented", w: ["Released", "Taxed"] },
                    { y: 2025, q: "Biohacking involves altering one's own biology. What is a common method?", a: "Implanting Chips", w: ["Drinking Bleach", "Laser Eyes"] }
                ]
            },
            {
                id: 'energy', name: 'ENERGY & AUTO', icon: '⚡', theme: 't-energy', qs: [
                    { y: 2008, q: "Tesla Motors released its first production vehicle. What was it called?", a: "Roadster", w: ["Model S", "Cybertruck"] },
                    { y: 2011, q: "A tsunami caused a nuclear meltdown at which power plant in Japan?", a: "Fukushima Daiichi", w: ["Chernobyl", "Three Mile Island"] },
                    { y: 1886, q: "Karl Benz patented what is typically regarded as the first...", a: "Automobile", w: ["Bicycle", "Steam Engine"] },
                    { y: 1908, q: "Henry Ford revolutionized the industry with the mass production of which car?", a: "Model T", w: ["Mustang", "F-150"] },
                    { y: 2020, q: "Tesla became the most valuable car company, surpassing which giant?", a: "Toyota", w: ["Ford", "Volkswagen"] },
                    { y: 2015, q: "Volkswagen was caught cheating on emissions tests in a scandal known as...", a: "Dieselgate", w: ["Fuelgate", "Smogcheck"] },
                    { y: 1973, q: "Which organization effectively caused an oil crisis by proclaiming an embargo?", a: "OPEC", w: ["NATO", "UN"] },
                    { y: 1986, q: "Where did the worst nuclear disaster in history occur?", a: "Chernobyl", w: ["Fukushima", "Kiev"] },
                    { y: 2010, q: "The Deepwater Horizon rig explosion caused an oil spill in which body of water?", a: "Gulf of Mexico", w: ["Persian Gulf", "North Sea"] },
                    { y: 1997, q: "Toyota launched the Prius, making it the first mass-produced...", a: "Hybrid Car", w: ["Electric Car", "Hydrogen Car"] },
                    { y: 2012, q: "Tesla launched the Model S, proving electric cars could be...", a: "Desirable Luxury", w: ["Cheap", "Slow"] },
                    { y: 2019, q: "Elon Musk unveiled the Cybertruck, during which what famously broke?", a: "The Window", w: ["The Wheel", "The Battery"] },
                    { y: 1954, q: "Bell Labs demonstrated the first practical version of what energy technology?", a: "Solar Cell", w: ["Wind Turbine", "Nuclear Reactor"] },
                    { y: 2006, q: "Al Gore starring in 'An Inconvenient Truth' raised awareness about what?", a: "Climate Change", w: ["Deforestation", "Ocean Plastic"] },
                    { y: 2016, q: "The Paris Agreement was a global accord to limit...", a: "Temperature Rise", w: ["Plastic Waste", "Deforestation"] },
                    { y: 2022, q: "Scientists at NIF achieved 'ignition' in which type of energy research?", a: "Nuclear Fusion", w: ["Fission", "Solar"] },
                    { y: 1979, q: "The Three Mile Island accident halted nuclear growth in which country?", a: "USA", w: ["Russia", "France"] },
                    { y: 2003, q: "Martin Eberhard and Marc Tarpenning founded which company?", a: "Tesla", w: ["Rivian", "Lucid"] },
                    { y: 2025, q: "Many countries have set bans on the sale of new...", a: "Gasoline Cars", w: ["Electric Cars", "Hybrids"] },
                    { y: 1900, q: "At the turn of the 20th century, 38% of American cars were powered by what?", a: "Electricity", w: ["Gasoline", "Steam"] }
                ]
            },
            {
                id: 'general', name: 'GENERAL FACTS', icon: '📚', theme: 't-gen', qs: [
                    { y: 1939, q: "World War II officially began when Germany invaded which country?", a: "Poland", w: ["France", "Austria"] },
                    { y: 1945, q: "World War II ended in the Pacific after the bombing of Hiroshima and...", a: "Nagasaki", w: ["Tokyo", "Kyoto"] },
                    { y: 1963, q: "President John F. Kennedy was assassinated in which city?", a: "Dallas", w: ["Houston", "Austin"] },
                    { y: 1989, q: "The fall of which barrier symbolized the end of the Cold War?", a: "Berlin Wall", w: ["Iron Curtain", "Great Wall"] },
                    { y: 2001, q: "Which terrorist group was responsible for the September 11 attacks?", a: "Al-Qaeda", w: ["ISIS", "Taliban"] },
                    { y: 1912, q: "The RMS Titanic sank after hitting an iceberg on its maiden voyage to...", a: "New York", w: ["Boston", "London"] },
                    { y: 1969, q: "The Woodstock music festival took place in which US state?", a: "New York", w: ["California", "Texas"] },
                    { y: 1991, q: "The Soviet Union officially dissolved on December 26 of this year.", a: "1991", w: ["1989", "1993"] },
                    { y: 2020, q: "The WHO declared COVID-19 a global pandemic in which month?", a: "March", w: ["January", "June"] },
                    { y: 2016, q: "The UK voted to leave the European Union. What was this termed?", a: "Brexit", w: ["ExitEU", "UK-Out"] },
                    { y: 1953, q: "Edmund Hillary and Tenzing Norgay were the first to summit which peak?", a: "Mount Everest", w: ["K2", "Matterhorn"] },
                    { y: 1977, q: "George Lucas released the first movie of which franchise?", a: "Star Wars", w: ["Star Trek", "Alien"] },
                    { y: 1994, q: "Disney's The Lion King became the highest-grossing animated film of its time.", a: "True", w: ["False", "Maybe"] },
                    { y: 2009, q: "James Cameron's Avatar popularized which film technology?", a: "3D", w: ["IMAX", "CGI"] },
                    { y: 2019, q: "Avengers: Endgame briefly became the highest-grossing film ever.", a: "True", w: ["False", "Maybe"] },
                    { y: 1980, q: "Which Beatle was tragically shot outside his apartment in New York?", a: "John Lennon", w: ["Paul McCartney", "George Harrison"] },
                    { y: 1997, q: "Princess Diana died in a car crash in which city?", a: "Paris", w: ["London", "Rome"] },
                    { y: 2011, q: "A series of anti-government protests across the Middle East was known as...", a: "Arab Spring", w: ["Desert Storm", "Cedar Revolution"] },
                    { y: 2022, q: "Queen Elizabeth II passed away after reigning for how many years?", a: "70 Years", w: ["60 Years", "80 Years"] },
                    { y: 1937, q: "Aviator Amelia Earhart disappeared while attempting to...", a: "Fly Around the World", w: ["Cross the Atlantic", "Fly to Antarctic"] }
                ]
            }
        ];


        // --- MULTI-TRACK MUSIC SYSTEM ---
        // aka "The DJ of the Apocalypse"
        // Swaps tracks based on how screwed the player is.
        const MusicSystem = {
            tracks: {
                start: new Audio('gamestart bgm.mp3'),   // The calm before the storm
                gameplay: new Audio('gameplay bgm.mp3'), // The storm
                gameover: new Audio('gameover bgm.mp3')  // The... aftermath
            },
            currentTrack: null,
            fadeInterval: null,
            baseVolume: 0.25,
            duckVolume: 0.1,

            init() {
                // Configure all tracks
                Object.values(this.tracks).forEach(track => {
                    track.loop = true;
                    track.volume = 0; // Start silent for fade-in
                });
            },

            play(trackName) {
                if (!soundEnabled) return;

                const newTrack = this.tracks[trackName];
                if (!newTrack) return;

                // If already playing this track, ensure it's playing but don't reset
                if (this.currentTrack === newTrack && !newTrack.paused) return;

                // Stop current track with rapid fade out
                if (this.currentTrack) {
                    const oldTrack = this.currentTrack;
                    this.fadeOut(oldTrack);
                }

                // Start new track
                this.currentTrack = newTrack;
                newTrack.currentTime = 0;
                newTrack.volume = 0;

                const playPromise = newTrack.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("Auto-play prevented (will resume on click):", error);
                        // Add one-time click handler to resume if blocked
                        document.addEventListener('click', () => {
                            if (this.currentTrack === newTrack && newTrack.paused) {
                                newTrack.play();
                                this.fadeIn(newTrack);
                            }
                        }, { once: true });
                    });
                }

                this.fadeIn(newTrack);
            },

            stop() {
                if (this.currentTrack) {
                    this.fadeOut(this.currentTrack);
                    this.currentTrack = null;
                }
            },

            // Duck volume (for typewriter)
            duck() {
                if (this.currentTrack) {
                    this.fadeGeneric(this.currentTrack, this.duckVolume, 500);
                }
            },

            // Unduck/Restore volume
            unduck() {
                if (this.currentTrack) {
                    this.fadeGeneric(this.currentTrack, this.baseVolume, 800);
                }
            },

            fadeIn(track) {
                this.fadeGeneric(track, this.baseVolume, 800);
            },

            fadeOut(track) {
                // Rapid fade out then pause
                if (track) {
                    // Manual interval for fade out to ensure we pause at end
                    let vol = track.volume;
                    const interval = setInterval(() => {
                        vol = Math.max(0, vol - 0.05);
                        track.volume = vol;
                        if (vol <= 0) {
                            clearInterval(interval);
                            track.pause();
                            track.currentTime = 0;
                        }
                    }, 50);
                }
            },

            // Generic fader
            fadeGeneric(track, targetVol, duration) {
                if (!soundEnabled) return;

                const startVol = track.volume;
                const startTime = Date.now();

                // Unique interval key per track to prevent conflicts? 
                // Simple approach: global interval is risky if switching tracks fast.
                // We'll trust the single-threaded nature + short durations.

                const step = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    if (track !== this.currentTrack && targetVol > 0) return; // Stop fading in if track switched away

                    const newVol = startVol + (targetVol - startVol) * progress;
                    track.volume = Math.max(0, Math.min(1, newVol));

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    }
                };
                requestAnimationFrame(step);
            }
        };

        // Let's get this party started
        MusicSystem.init();

        // =============================================
        // GLOBAL TOGGLE SYSTEMS
        // =============================================
        console.log('✅ UI Systems online. Don\'t break anything.');

        // --- SOUND TOGGLE ---
        let soundEnabled = true;
        let savedBgmVolume = 0.25;

        function toggleSound() {
            const btn = document.getElementById('sound-toggle');
            if (!btn) return;
            const icon = btn.querySelector('.icon');

            soundEnabled = !soundEnabled;

            if (soundEnabled) {
                // Enable sound
                if (typeof MusicSystem !== 'undefined' && MusicSystem.currentTrack) {
                    MusicSystem.currentTrack.volume = savedBgmVolume;
                }
                if (typeof AudioSystem !== 'undefined' && AudioSystem.ctx && AudioSystem.ctx.state === 'suspended') {
                    AudioSystem.resume();
                }
                if (icon) icon.textContent = '🔊';
                btn.classList.remove('sound-off');
                btn.title = 'Sound ON - Click to mute';
            } else {
                // Disable sound
                if (typeof MusicSystem !== 'undefined' && MusicSystem.currentTrack) {
                    savedBgmVolume = MusicSystem.currentTrack.volume;
                    MusicSystem.currentTrack.volume = 0;
                }
                if (typeof AudioSystem !== 'undefined' && AudioSystem.ctx) {
                    AudioSystem.ctx.suspend();
                }
                if (icon) icon.textContent = '🔇';
                btn.classList.add('sound-off');
                btn.title = 'Sound OFF - Click to unmute';
            }
        }

        // --- THEME TOGGLE - 3 THEMES: COLORFUL, BLOODY, NOIR ---
        let currentTheme = 'bloody'; // Start with current bloody theme

        function toggleTheme() {
            try {
                const btn = document.getElementById('theme-toggle-btn');
                if (!btn) return;

                const icon = btn.querySelector('.icon');
                const root = document.documentElement;

                // Rotate icon
                if (icon) {
                    icon.style.transform = 'rotate(360deg)';
                    setTimeout(() => icon.style.transform = 'rotate(0deg)', 500);
                }

                // Cycle: bloody -> colorful -> noir -> bloody
                if (currentTheme === 'bloody') {
                    // COLORFUL (Indigo/Blue) - Original theme
                    root.style.setProperty('--primary', '#6366f1');
                    root.style.setProperty('--primary-light', '#818cf8');
                    root.style.setProperty('--secondary', '#a5b4fc');
                    root.style.setProperty('--danger', '#ef4444');
                    root.style.setProperty('--blood', '#dc2626');
                    root.style.setProperty('--bg-color', '#000005');
                    root.style.setProperty('--text-main', '#ffffff');
                    root.style.setProperty('--horror-glow', 'rgba(99, 102, 241, 0.2)');
                    root.style.setProperty('--glass-bg', 'rgba(10, 10, 30, 0.9)');
                    document.body.classList.remove('theme-bloody', 'theme-noir');
                    document.body.classList.add('theme-colorful');
                    currentTheme = 'colorful';
                    if (icon) icon.textContent = '🌈';
                    btn.title = 'Theme: COLORFUL - Click for NOIR';
                } else if (currentTheme === 'colorful') {
                    // NOIR (Black & White)
                    root.style.setProperty('--primary', '#ffffff');
                    root.style.setProperty('--primary-light', '#e0e0e0');
                    root.style.setProperty('--secondary', '#aaaaaa');
                    root.style.setProperty('--danger', '#888888');
                    root.style.setProperty('--blood', '#666666');
                    root.style.setProperty('--bg-color', '#000000');
                    root.style.setProperty('--text-main', '#ffffff');
                    root.style.setProperty('--horror-glow', 'rgba(255, 255, 255, 0.1)');
                    root.style.setProperty('--glass-bg', 'rgba(20, 20, 20, 0.9)');
                    document.body.classList.remove('theme-colorful', 'theme-bloody');
                    document.body.classList.add('theme-noir');
                    currentTheme = 'noir';
                    if (icon) icon.textContent = '⬛';
                    btn.title = 'Theme: NOIR - Click for BLOODY';
                } else {
                    // BLOODY (Red Horror) - Current default
                    root.style.setProperty('--primary', '#ff1a1a');
                    root.style.setProperty('--primary-light', '#ff6666');
                    root.style.setProperty('--secondary', '#ff4444');
                    root.style.setProperty('--danger', '#ff0000');
                    root.style.setProperty('--blood', '#8b0000');
                    root.style.setProperty('--bg-color', '#050000');
                    root.style.setProperty('--text-main', '#ffffff');
                    root.style.setProperty('--horror-glow', 'rgba(255, 0, 0, 0.25)');
                    root.style.setProperty('--glass-bg', 'rgba(15, 0, 0, 0.9)');
                    document.body.classList.remove('theme-colorful', 'theme-noir');
                    document.body.classList.add('theme-bloody');
                    currentTheme = 'bloody';
                    if (icon) icon.textContent = '🩸';
                    btn.title = 'Theme: BLOODY - Click for COLORFUL';
                }
            } catch (error) {
                console.error('Error in toggleTheme:', error);
            }
        }

        // =============================================
        // TYPEWRITER SYSTEM - Story Narrative Effect
        // =============================================
        // =============================================
        // TYPEWRITER SYSTEM - The "Ghost in the Machine"
        // (Simulates frantic/human typing with variance)
        // =============================================
        const TypeWriter = {
            baseSpeed: 30, // Base ms per char (tweak if too slow)
            lineDelay: 600, // Breathing room between lines

            async type(elementId, text) {
                const el = document.getElementById(elementId);
                // Fail silently if element is gone (don't crash the party)
                if (!el) return;

                // duck volume for dramatic effect
                if (typeof MusicSystem !== 'undefined') MusicSystem.duck();

                el.textContent = '';
                el.classList.add('typewriter-text');
                el.classList.remove('done');

                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    el.textContent += char;

                    // Sound logic: Don't spam it. 
                    // Every 2-3 chars feels more natural than machine-gun fire.
                    if (char !== ' ' && i % 3 === 0) {
                        this.playTypingSound();
                    }

                    // --- HUMANIZATION MAGIC ---
                    // No one types at perfect constant speed.
                    // Add some jitter (+/- 10ms)
                    let delay = this.baseSpeed + (Math.random() * 20 - 10);

                    // Pause at punctuation (caught in thought?)
                    if (char === '.' || char === '!' || char === '?') {
                        delay += 350; // Dramatic pause
                    } else if (char === ',' || char === ';') {
                        delay += 150; // Brief pause
                    }

                    // Sanity check: don't let it be negative
                    await this.wait(Math.max(5, delay));
                }

                el.classList.add('done');

                // Restore volume
                if (typeof MusicSystem !== 'undefined') MusicSystem.unduck();
            },

            async typeLines(containerId, lines) {
                const container = document.getElementById(containerId);
                if (!container) return;

                // duck volume
                if (typeof MusicSystem !== 'undefined') MusicSystem.duck();

                container.innerHTML = '';

                for (const line of lines) {
                    const p = document.createElement('p');
                    p.className = 'story-line typewriter-text';
                    // Inject custom styles if needed (e.g. red warning text)
                    if (line.style) p.style.cssText = line.style;
                    container.appendChild(p);

                    // Brief pause before starting a new line
                    await this.wait(150);
                    p.classList.add('visible');

                    for (let i = 0; i < line.text.length; i++) {
                        const char = line.text[i];
                        p.textContent += char;

                        // Sound: randomness makes it organic
                        if (char !== ' ' && Math.random() > 0.6) {
                            this.playTypingSound();
                        }

                        // Jittery typing speed
                        let delay = this.baseSpeed + (Math.random() * 25 - 10);

                        // Dramatic pauses for effect
                        if (['.', '!', '?'].includes(char)) delay += 400;
                        if ([':', ',', '-'].includes(char)) delay += 200;

                        await this.wait(Math.max(5, delay));
                    }

                    p.classList.add('done');
                    // Wait before next line (let the user read!)
                    await this.wait(this.lineDelay);
                }

                // Restore volume
                if (typeof MusicSystem !== 'undefined') MusicSystem.unduck();
            },

            // The subtle "click" of a mechanical keyboard provided by Web Audio API
            playTypingSound() {
                try {
                    // Always try to wake up the audio context if it's sleeping
                    if (typeof AudioSystem !== 'undefined') {
                        if (!AudioSystem.ctx) AudioSystem.init();
                        AudioSystem.resume();

                        if (AudioSystem.ctx) {
                            const osc = AudioSystem.ctx.createOscillator();
                            const gain = AudioSystem.ctx.createGain();
                            osc.connect(gain);
                            gain.connect(AudioSystem.ctx.destination);

                            // Randomize pitch slightly for realism
                            // (No two keypresses sound exactly identical)
                            osc.frequency.value = 800 + Math.random() * 250;
                            osc.type = 'square'; // Square wave gives that 8-bit clicky feel

                            gain.gain.value = 0.025; // Keep it subtle, don't blow ears out

                            osc.start();
                            osc.stop(AudioSystem.ctx.currentTime + 0.025);
                        }
                    }
                } catch (e) {
                    // If audio fails, game plays on. No biggie.
                }
            },

            wait(ms) {
                return new Promise(r => setTimeout(r, ms));
            }
        };

        // =============================================
        // GAME MODE SYSTEMS
        // =============================================

        // Mode Constants
        const GAME_MODES = {
            A: {
                name: 'OWN LUCK',
                icon: '🎯',
                desc: 'Standard gameplay with Freeze & Rewind powers',
                theme: 'normal'
            },
            B: {
                name: 'TIME LOOP',
                icon: '🌀',
                desc: 'Glitch effects • Dream sequences • Loop on death',
                theme: 'dream'
            },
            C: {
                name: 'TIMELINE DUEL',
                icon: '⚔️',
                desc: 'You vs AI • Day to Night • Puzzle finale',
                theme: 'duel'
            }
        };

        let currentGameMode = null;
        let gameInProgress = false;

        // --- MOBILE DETECTION ---
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                || window.innerWidth < 1024;
        }

        function checkMobileBlock() {
            const blocker = document.getElementById('mobile-blocker');
            if (blocker) {
                // Mobile restriction removed as per user request
                blocker.classList.remove('active');
            }
        }

        // --- EXIT WARNING ---
        window.addEventListener('beforeunload', (e) => {
            if (gameInProgress) {
                e.preventDefault();
                e.returnValue = 'You have an active game. Are you sure you want to leave?';
                return e.returnValue;
            }
        });

        // --- LUCK RANDOMIZER SYSTEM ---
        const LuckSystem = {
            spinning: false,

            spin() {
                if (this.spinning) return;
                this.spinning = true;

                const slots = document.querySelectorAll('.luck-slot');
                const modes = ['A', 'B', 'C'];
                const icons = { 'A': '🎯', 'B': '🌀', 'C': '⚔️' };

                // Disable button immediately
                const spinBtn = document.getElementById('spin-luck-btn');
                spinBtn.textContent = 'SPINNING...';
                spinBtn.disabled = true;

                // Play initial sound
                if (typeof AudioSystem !== 'undefined') AudioSystem.playRouletteClick();

                // Add spinning class for glow effect
                slots.forEach(slot => slot.classList.add('spinning'));

                // Decide final result upfront
                currentGameMode = modes[Math.floor(Math.random() * 3)];

                // Spin each slot independently with staggered stop times
                const slotStopTimes = [2000, 2500, 3000]; // Each slot stops at different time

                slots.forEach((slot, index) => {
                    this.spinSlot(slot, icons, modes, slotStopTimes[index], index === slots.length - 1);
                });
            },

            spinSlot(slot, icons, modes, duration, isLast) {
                const startTime = Date.now();
                const startInterval = 50;  // Start fast (50ms)
                const endInterval = 400;   // End slow (400ms)

                let lastUpdate = 0;
                let currentInterval = startInterval;

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // Ease-out curve: starts fast, slows down dramatically at end
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    currentInterval = startInterval + (endInterval - startInterval) * easeOut;

                    // Only update if enough time has passed
                    if (elapsed - lastUpdate >= currentInterval) {
                        const randomMode = modes[Math.floor(Math.random() * 3)];
                        slot.textContent = icons[randomMode];
                        lastUpdate = elapsed;

                        // Play tick sound on slower spins
                        if (currentInterval > 150 && typeof AudioSystem !== 'undefined') {
                            AudioSystem.playRouletteClick();
                        }
                    }

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // Final stop - show selected mode with bounce effect
                        this.stopSlot(slot, icons, isLast);
                    }
                };

                requestAnimationFrame(animate);
            },

            stopSlot(slot, icons, isLast) {
                slot.classList.remove('spinning');
                slot.textContent = icons[currentGameMode];

                // Bounce animation
                slot.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    slot.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        slot.style.transform = 'scale(1.1)';
                        slot.classList.add('selected');
                        setTimeout(() => {
                            slot.style.transform = 'scale(1)';
                        }, 100);
                    }, 100);
                }, 100);

                // Play stop sound
                if (typeof AudioSystem !== 'undefined') AudioSystem.playCorrect();

                // If this is the last slot, show result
                if (isLast) {
                    setTimeout(() => this.showResult(), 500);
                }
            },

            showResult() {
                const result = document.getElementById('luck-result');
                const mode = GAME_MODES[currentGameMode];

                result.innerHTML = `
                    <span style="font-size:2.5rem;">${mode.icon}</span>
                    <span>${mode.name}</span>
                    <span class="mode-desc">${mode.desc}</span>
                `;

                // Update button
                const spinBtn = document.getElementById('spin-luck-btn');
                spinBtn.textContent = 'ENTERING TIMELINE...';

                this.spinning = false;

                // Proceed after delay
                setTimeout(() => {
                    if (typeof Game !== 'undefined') {
                        Game.proceedWithMode();
                    }
                }, 2000);
            },

            reset() {
                const slots = document.querySelectorAll('.luck-slot');
                slots.forEach(slot => {
                    slot.textContent = '?';
                    slot.classList.remove('spinning', 'selected');
                });
                document.getElementById('luck-result').innerHTML = '';
                const spinBtn = document.getElementById('spin-luck-btn');
                spinBtn.textContent = 'SPIN FATE';
                spinBtn.disabled = false;
                currentGameMode = null;
            }
        };

        // --- DREAM MODE (Mode B) ---
        const DreamMode = {
            maxQuestions: 20,
            questionsInDream: 0,
            currentQuestionCount: 0,
            dreamCount: 0,
            active: false,

            init() {
                // Random questions between 8-20
                this.questionsInDream = Math.floor(Math.random() * 13) + 8;
                this.currentQuestionCount = 0;
                this.dreamCount = 0;
                this.active = true;
                document.body.classList.add('mode-dream');
            },

            onQuestionAnswered() {
                if (!this.active) return false;
                this.currentQuestionCount++;

                // Check if dream sequence should trigger
                if (this.currentQuestionCount >= this.questionsInDream) {
                    return true; // Trigger dream
                }
                return false;
            },

            triggerDreamSequence(isWin) {
                const overlay = document.getElementById('dream-overlay');
                const dreamText = document.getElementById('dream-text');
                const dreamSubtext = document.getElementById('dream-subtext');

                if (isWin) {
                    dreamText.textContent = 'YOU ARE RECOVERED';
                    dreamText.style.color = 'var(--green)';
                    dreamSubtext.textContent = 'Timeline stabilized...';
                } else {
                    dreamText.textContent = 'IT WAS A DREAM...';
                    dreamText.style.color = 'var(--primary)';
                    dreamSubtext.textContent = 'Timeline resetting...';
                }

                overlay.classList.add('active');

                if (typeof AudioSystem !== 'undefined') AudioSystem.playRewind();

                setTimeout(() => {
                    overlay.classList.remove('active');

                    if (isWin) {
                        // Victory!
                        this.cleanup();
                        if (typeof Game !== 'undefined') Game.gameWin();
                    } else {
                        // Loop back
                        this.dreamCount++;
                        this.currentQuestionCount = 0;
                        this.questionsInDream = Math.floor(Math.random() * 13) + 8;

                        // Restart the game round
                        if (typeof Game !== 'undefined') {
                            Game.round = 0;
                            Game.score = Math.floor(Game.score * 0.5); // Lose half score
                            document.getElementById('hud-score').innerText = Game.score;
                            TimerSystem.start(60);
                            Game.nextRound();
                        }
                    }
                }, 3000);
            },

            cleanup() {
                this.active = false;
                document.body.classList.remove('mode-dream');
            }
        };

        // --- DUEL MODE (Mode C) ---
        const DuelMode = {
            playerScore: 0,
            aiScore: 0,
            dayStartTime: null,
            nightTriggered: false,
            nightTimeout: null,
            active: false,
            currentQuestion: null,

            init() {
                this.playerScore = 0;
                this.aiScore = 0;
                this.dayStartTime = Date.now();
                this.nightTriggered = false;
                this.active = true;
                document.body.classList.add('time-day');

                // HIDE TIMER & HUD ELEMENTS FOR DUEL
                const timerPanel = document.getElementById('timer-panel');
                if (timerPanel) timerPanel.classList.add('hidden');

                this.startDayNightCycle();

                document.getElementById('player-duel-score').textContent = '0';
                document.getElementById('ai-duel-score').textContent = '0';
            },

            reset() {
                if (typeof resetAchievementStats !== 'undefined') resetAchievementStats(); // ACHIEVEMENT HOOK
                this.playerScore = 0;
                this.aiScore = 0;
                this.dayStartTime = Date.now();
                this.nightTriggered = false;
                this.active = true;
                document.body.classList.add('time-day');

                // HIDE TIMER & HUD ELEMENTS FOR DUEL
                const timerPanel = document.getElementById('timer-panel');
                if (timerPanel) timerPanel.classList.add('hidden');

                this.startDayNightCycle();

                document.getElementById('player-duel-score').textContent = '0';
                document.getElementById('ai-duel-score').textContent = '0';
            },

            startDayNightCycle() {
                // Random time between 45-90 seconds for night to trigger
                const nightDelay = (Math.random() * 45 + 45) * 1000;
                this.nightDuration = nightDelay; // Save for rewind logic
                this.startTime = Date.now();

                this.nightTimeout = setTimeout(() => {
                    this.triggerNight();
                }, nightDelay);
            },

            rewindTime(ms) {
                // Extend the day phase
                if (this.nightTriggered) return; // Can't rewind once night starts (it's too late)

                clearTimeout(this.nightTimeout);

                // Calculate how much time was left
                const elapsed = Date.now() - this.startTime;
                let remaining = this.nightDuration - elapsed;

                // Add bonus time (rewind)
                remaining += ms;
                if (remaining < 1000) remaining = 1000; // Safety min

                // Restart timeout with new remaining time
                this.startTime = Date.now(); // Reset start base
                this.nightDuration = remaining;

                this.nightTimeout = setTimeout(() => {
                    this.triggerNight();
                }, remaining);

                // Visual feedback of extended day
                const dayEl = document.createElement('div');
                dayEl.innerHTML = "☀️ DAYLIGHT EXTENDED";
                dayEl.className = 'anomaly-alert';
                dayEl.style.color = '#000';
                dayEl.style.background = '#fff';
                document.body.appendChild(dayEl);
                setTimeout(() => dayEl.remove(), 2000);
            },

            triggerNight() {
                if (!this.active) return;

                if (typeof TimerSystem !== 'undefined' && TimerSystem.frozen) {
                    setTimeout(() => this.triggerNight(), 500);
                    return;
                }

                this.nightTriggered = true;
                document.body.classList.remove('time-day');
                document.body.classList.add('time-night');

                if (typeof AudioSystem !== 'undefined') AudioSystem.playFreeze();

                // End game after short night period
                setTimeout(() => {
                    if (this.active) {
                        this.endDuelWithPuzzle();
                    }
                }, 8000);
            },

            loadDuelQuestion(questionData) {
                this.currentQuestion = questionData;

                // Player side
                document.getElementById('era-display-player').innerText = `YEAR: ${questionData.y}`;
                document.getElementById('q-text-player').innerText = questionData.q;

                // AI side (same question)
                document.getElementById('era-display-ai').innerText = `YEAR: ${questionData.y}`;
                document.getElementById('q-text-ai').innerText = questionData.q;

                // Generate options for player
                const playerArea = document.getElementById('opt-area-player');
                playerArea.innerHTML = '';
                const options = [questionData.a, ...questionData.w].sort(() => Math.random() - 0.5);

                options.forEach(txt => {
                    const b = document.createElement('div');
                    b.className = 'opt-btn';
                    b.innerText = txt;
                    b.onclick = () => this.playerAnswer(txt, questionData.a);
                    playerArea.appendChild(b);
                });

                // Generate options for AI (same order)
                const aiArea = document.getElementById('opt-area-ai');
                aiArea.innerHTML = '';
                options.forEach(txt => {
                    const b = document.createElement('div');
                    b.className = 'opt-btn';
                    b.innerText = txt;
                    b.dataset.answer = txt;
                    aiArea.appendChild(b);
                });

                // Simulate AI answering
                this.simulateAIAnswer(questionData, options);
            },

            simulateAIAnswer(questionData, options) {
                // AI has 65% accuracy, answers in 1-4 seconds
                const delay = Math.random() * 3000 + 1000;

                setTimeout(() => {
                    if (!this.active) return;

                    if (typeof TimerSystem !== 'undefined' && TimerSystem.frozen) {
                        setTimeout(() => this.simulateAIAnswer(questionData, options), 500);
                        return;
                    }

                    const correct = Math.random() < 0.65;
                    const aiOpts = document.querySelectorAll('#opt-area-ai .opt-btn');

                    aiOpts.forEach(opt => {
                        // Creepy/Hidden AI Selection Logic
                        if (correct && opt.dataset.answer === questionData.a) {
                            // "Faded portion" & "Hide type"
                            opt.style.transition = 'all 2s ease';
                            opt.style.background = 'rgba(0, 0, 0, 0.8)'; // Dark void
                            opt.style.borderColor = 'rgba(57, 255, 20, 0.1)'; // Very faint green hint
                            opt.style.color = 'transparent'; // HIDE TEXT
                            opt.style.textShadow = 'none';
                            opt.style.filter = 'blur(3px) grayscale(100%)';
                            opt.style.transform = 'scale(0.95)';
                            opt.innerHTML = ''; // Ensure text is gone

                            this.aiScore += 100;
                        } else if (!correct && opt.dataset.answer !== questionData.a && Math.random() > 0.5) {
                            // Decoy / Wrong
                            opt.style.transition = 'all 2s ease';
                            opt.style.background = 'rgba(0, 0, 0, 0.5)';
                            opt.style.color = 'transparent';
                            opt.style.borderColor = 'transparent';
                            opt.style.filter = 'blur(5px)';
                        }
                    });

                    document.getElementById('ai-duel-score').textContent = this.aiScore;
                }, delay);
            },

            playerAnswer(ans, correct) {
                if (!this.active) return;

                const playerOpts = document.querySelectorAll('#opt-area-player .opt-btn');
                playerOpts.forEach(opt => opt.style.pointerEvents = 'none');

                if (ans === correct) {
                    try { if (typeof onCorrectAnswer !== 'undefined') onCorrectAnswer(); } catch (e) { console.error(e); } // ACHIEVEMENT HOOK SAFE
                    this.playerScore += 100;
                    if (typeof AudioSystem !== 'undefined') AudioSystem.playCorrect();
                    playerOpts.forEach(opt => {
                        if (opt.innerText === ans) {
                            opt.style.background = 'rgba(57, 255, 20, 0.3)';
                            opt.style.borderColor = 'var(--green)';
                        }
                    });

                    // Sync with main Game score and HUD
                    if (typeof Game !== 'undefined') {
                        Game.score = this.playerScore;
                        document.getElementById('hud-score').innerText = this.playerScore;
                    }
                } else {
                    try { if (typeof onWrongAnswer !== 'undefined') onWrongAnswer(); } catch (e) { console.error(e); } // ACHIEVEMENT HOOK SAFE
                    if (typeof AudioSystem !== 'undefined') AudioSystem.playWrong();
                    playerOpts.forEach(opt => {
                        if (opt.innerText === ans) {
                            opt.style.background = 'rgba(255, 0, 60, 0.3)';
                            opt.style.borderColor = 'var(--danger)';
                        }
                    });
                }

                document.getElementById('player-duel-score').textContent = this.playerScore;

                // Next question after delay
                setTimeout(() => {
                    if (typeof Game !== 'undefined' && this.active) {
                        Game.round++;
                        Game.nextRound();
                    }
                }, 1500);
            },

            endDuelWithPuzzle() {
                this.active = false;
                if (this.nightTimeout) clearTimeout(this.nightTimeout);

                // Transfer scores to main game
                if (typeof Game !== 'undefined') {
                    Game.score = this.playerScore;
                }

                PuzzleSystem.show();
            },

            cleanup() {
                this.active = false;
                if (this.nightTimeout) clearTimeout(this.nightTimeout);
                document.body.classList.remove('time-day', 'time-night');

                // RESTORE TIMER
                const timerPanel = document.getElementById('timer-panel');
                if (timerPanel) timerPanel.classList.remove('hidden');
            }
        };

        // --- PUZZLE SYSTEM (Mode C Finale) ---
        const PuzzleSystem = {
            puzzles: [
                { q: 'Complete: 2, 4, 8, 16, ?', a: '32' },
                { q: 'Unscramble: MEIT', a: 'TIME' },
                { q: 'What is 7 × 8?', a: '56' },
                { q: 'Complete: 1, 1, 2, 3, 5, ?', a: '8' },
                { q: 'Unscramble: NIREW', a: 'REWIND' },
                { q: 'What is 144 ÷ 12?', a: '12' },
                { q: '⏰ + 🔄 = ?', a: 'REWIND' },
                { q: '60 seconds = ? minutes', a: '1' }
            ],
            currentPuzzle: null,
            attempts: 0,

            show() {
                this.currentPuzzle = this.puzzles[Math.floor(Math.random() * this.puzzles.length)];
                this.attempts = 0;

                document.getElementById('puzzle-question').textContent = this.currentPuzzle.q;
                document.getElementById('puzzle-input').value = '';
                document.getElementById('puzzle-feedback').textContent = '';
                document.getElementById('puzzle-modal').classList.add('active');

                // Focus the input
                setTimeout(() => {
                    document.getElementById('puzzle-input').focus();
                }, 100);
            },

            submit() {
                const input = document.getElementById('puzzle-input').value.trim().toUpperCase();
                const feedback = document.getElementById('puzzle-feedback');

                if (input === this.currentPuzzle.a.toUpperCase()) {
                    feedback.textContent = '✅ CORRECT!';
                    feedback.style.color = 'var(--green)';
                    if (typeof AudioSystem !== 'undefined') AudioSystem.playCorrect();

                    setTimeout(() => {
                        document.getElementById('puzzle-modal').classList.remove('active');
                        DuelMode.cleanup();
                        // Explicitly trigger Win State
                        if (typeof Game !== 'undefined') Game.gameWin();
                    }, 1500);
                } else {
                    this.attempts++;
                    feedback.textContent = `❌ WRONG (${3 - this.attempts} tries left)`;
                    feedback.style.color = 'var(--danger)';
                    if (typeof AudioSystem !== 'undefined') AudioSystem.playWrong();

                    document.getElementById('puzzle-input').value = '';

                    if (this.attempts >= 3) {
                        setTimeout(() => {
                            document.getElementById('puzzle-modal').classList.remove('active');
                            DuelMode.cleanup();
                            // Trigger creepy restart instead of normal game over
                            this.triggerCreepyRestart();
                        }, 1500);
                    }
                }
            },

            triggerCreepyRestart() {
                const overlay = document.getElementById('creepy-overlay');
                const creepyText = document.getElementById('creepy-text');
                const creepySubtext = document.getElementById('creepy-subtext');

                // Horror messages
                const messages = [
                    { text: 'YOU CANNOT ESCAPE', sub: 'You must play again...' },
                    { text: 'THERE IS NO EXIT', sub: 'The timeline demands sacrifice...' },
                    { text: 'YOU HAVE TO PLAY', sub: 'Otherwise you cannot leave...' },
                    { text: 'FOREVER LOOPING', sub: 'Play. Or stay trapped.' }
                ];

                const msg = messages[Math.floor(Math.random() * messages.length)];
                creepyText.textContent = msg.text;
                creepySubtext.textContent = msg.sub;

                overlay.classList.add('active');

                // Stop BGM if playing
                if (typeof stopBGM !== 'undefined') stopBGM();

                document.getElementById('hud').classList.add('hidden');
                document.getElementById('s-game-duel').classList.add('hidden');
            }
        };

        // Initialize on load
        window.addEventListener('resize', checkMobileBlock);
        document.addEventListener('DOMContentLoaded', () => {
            checkMobileBlock();

            // Luck spin button
            const spinBtn = document.getElementById('spin-luck-btn');
            if (spinBtn) {
                spinBtn.addEventListener('click', () => LuckSystem.spin());
            }

            // Puzzle submit
            const puzzleSubmit = document.getElementById('puzzle-submit');
            if (puzzleSubmit) {
                puzzleSubmit.addEventListener('click', () => PuzzleSystem.submit());
            }

            // Puzzle input enter key
            const puzzleInput = document.getElementById('puzzle-input');
            if (puzzleInput) {
                puzzleInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') PuzzleSystem.submit();
                });
            }

            // Creepy continue button - restart game
            const creepyContinue = document.getElementById('creepy-continue');
            if (creepyContinue) {
                creepyContinue.addEventListener('click', () => {
                    // Play horror sound
                    if (typeof AudioSystem !== 'undefined') AudioSystem.playCreepyBoom();

                    // Trigger horror glitch
                    HorrorEffects.glitch();
                    HorrorEffects.shake();

                    setTimeout(() => {
                        document.getElementById('creepy-overlay').classList.remove('active');
                        // Reset game state
                        currentGameMode = null;
                        gameInProgress = false;

                        // Return to title screen
                        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                        document.getElementById('s-title').classList.remove('hidden');

                        // Restart Story System logic (Crucial Fix)
                        if (typeof StorySystem !== 'undefined') {
                            StorySystem.playStory('title', 'title', 'init-btn');
                        }

                        // Restart music
                        if (typeof MusicSystem !== 'undefined') MusicSystem.play('start');
                    }, 800); // Slightly longer delay for effect
                });
            }
        });

        // =============================================
        // HORROR EFFECTS HELPER SYSTEM
        // =============================================
        const HorrorEffects = {
            shake() {
                document.body.classList.add('horror-shake');
                setTimeout(() => document.body.classList.remove('horror-shake'), 400);
            },

            glitch() {
                document.body.classList.add('glitch-active');
                setTimeout(() => document.body.classList.remove('glitch-active'), 300);
            },

            anxiety(enable = true) {
                if (enable) {
                    document.body.classList.add('anxiety-mode');
                } else {
                    document.body.classList.remove('anxiety-mode');
                }
            },

            randomGlitch() {
                // Random chance to glitch during gameplay
                if (Math.random() < 0.1) {
                    this.glitch();
                }
            }
        };

        // --- 2. AUDIO (Safe) ---
        // --- 2. AUDIO SYSTEM ---
        const AudioSystem = {
            ctx: null,
            bgmPlaying: false,

            init() {
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("AudioSystem: Waking up the beast...");
                } catch (e) { console.error("AudioSystem: It's dead, Jim.", e); }
            },

            resume() {
                if (!soundEnabled) return; // User said "shut up", so we shut up.
                if (this.ctx && this.ctx.state === 'suspended') {
                    this.ctx.resume().then(() => console.log("AudioSystem: And... we're back!"));
                }
            },

            // Smooth volume transition helper
            fadeTo(targetVol, duration = 1000) {
                if (typeof bgMusic === 'undefined' || !bgMusic) return;

                // Don't fade if sound is globally disabled, just set internal state
                if (!soundEnabled) return;

                const startVol = bgMusic.volume;
                const startTime = Date.now();

                // Clear any existing fade interval
                if (this.fadeInterval) clearInterval(this.fadeInterval);

                this.fadeInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // Linear interpolation
                    const newVol = startVol + (targetVol - startVol) * progress;
                    bgMusic.volume = Math.max(0, Math.min(1, newVol));

                    if (progress >= 1) clearInterval(this.fadeInterval);
                }, 50);
            },

            // Correct Answer - Satisfying "ding"
            playCorrect() {
                if (!this.ctx) this.init(); this.resume();
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.setValueAtTime(880, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1760, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.3);
            },

            // Wrong Answer - Harsh buzz
            playWrong() {
                if (!this.ctx) this.init(); this.resume();
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, this.ctx.currentTime + 0.4);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.4);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.4);
            },

            // Freeze Time - Whoosh effect
            playFreeze() {
                if (!this.ctx) this.init(); this.resume();
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                osc.type = 'sine';
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.setValueAtTime(2000, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.8);
                filter.frequency.setValueAtTime(3000, this.ctx.currentTime);
                filter.frequency.exponentialRampToValueAtTime(200, this.ctx.currentTime + 0.8);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.8);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.8);
            },

            // Rewind - Reverse tape effect
            playRewind() {
                if (!this.ctx) this.init(); this.resume();
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.setValueAtTime(100, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, this.ctx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.15, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.5);
            },

            // Tick sound for timer (tension!)
            playTick() {
                if (!this.ctx) this.init(); this.resume();
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.setValueAtTime(1000, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.05);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.05);
            },

            // Roulette spinning
            playRouletteClick() {
                if (!this.ctx) this.init(); this.resume();
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.setValueAtTime(600 + Math.random() * 200, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.08, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.03);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.03);
            },

            // UI Click - Soft interaction
            playClick() {
                if (!this.ctx) this.init(); this.resume();
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.1);
            },

            // Horror Boom Effect
            playCreepyBoom() {
                if (!this.ctx) this.init(); this.resume();
                if (!this.ctx) return;

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                // Low frequency noise/rumble
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(30, this.ctx.currentTime + 1.5);

                gain.gain.setValueAtTime(0.5, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 1.5);

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                osc.start();
                osc.stop(this.ctx.currentTime + 1.5);
            }
        };

        // Global UI Click Sound
        document.addEventListener('click', (e) => {
            // Init audio on first interaction
            if (AudioSystem.ctx && AudioSystem.ctx.state === 'suspended') AudioSystem.resume();

            if (e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.classList.contains('opt-btn')) {
                AudioSystem.playClick();
            }
        });

        // --- TIMER SYSTEM ---
        const TimerSystem = {
            timeLeft: 15,
            maxTime: 15,
            interval: null,
            frozen: false,

            start(seconds = 15) {
                this.maxTime = seconds;
                this.timeLeft = seconds;
                this.frozen = false;
                this.update();

                if (this.interval) clearInterval(this.interval);

                // DUEL MODE EXCEPTION: No timer countdown
                if (typeof currentGameMode !== 'undefined' && currentGameMode === 'C') {
                    // Update once to clear/hide info but don't tick
                    this.update();
                    return;
                }

                this.interval = setInterval(() => {
                    if (this.frozen) return;

                    // Apply difficulty multiplier to time drain
                    let rate = 0.1 * DifficultySystem.getTickRate();

                    // Anomaly: Fast
                    if (document.body.classList.contains('anomaly-fast')) rate *= 2;

                    this.timeLeft -= rate;
                    this.update();

                    // Tick sound when low (below 10s)
                    if (this.timeLeft <= 10 && this.timeLeft > 0) {
                        if (Math.floor(this.timeLeft * 5) % 5 === 0) { // Faster ticking
                            AudioSystem.playTick();
                        }
                    }

                    if (this.timeLeft <= 0) {
                        this.stop();
                        Game.gameOver(); // Time out = Game Over now
                    }
                }, 100);
            },

            update() {
                const display = document.getElementById('time-display');
                const bar = document.getElementById('time-bar');

                // Ring (Keep legacy support if exists, or ignore)
                const ring = document.getElementById('timeRing');
                const ringProg = document.getElementById('timeProgress');
                if (ringProg) {
                    const percent = Math.max(0, this.timeLeft / this.maxTime); // Relative to max?
                    // Or relative to 60s base? Let's keep it relative to current Max for Ring
                    const offset = 251 * (1 - percent);
                    ringProg.style.strokeDashoffset = offset;
                }

                if (!display || !bar) return;

                // SPECIAL DISPLAY FOR DUEL MODE
                if (typeof currentGameMode !== 'undefined' && currentGameMode === 'C') {
                    display.textContent = "NO TIME";
                    bar.style.width = "100%";
                    bar.style.backgroundColor = (document.body.classList.contains('time-day')) ? '#000' : '#444';
                    return;
                }

                display.textContent = this.timeLeft.toFixed(1);
                // Bar is relative to 60s (Initial Max) visually, or dynamic?
                // User snippet: (timeRemaining / 60 * 100) + '%'
                // So bar clamps at 60s full.
                let percent = (this.timeLeft / 60) * 100;
                if (percent > 100) percent = 100;
                bar.style.width = percent + '%';

                // Danger state when under 15 seconds (User requested < 15)
                if (this.timeLeft < 15) {
                    bar.classList.add('danger');
                    display.style.color = 'var(--danger)';
                    // Visual Distortion Request
                    document.body.classList.add('time-critical');
                } else {
                    bar.classList.remove('danger');
                    display.style.color = 'var(--primary)';
                    document.body.classList.remove('time-critical');
                }
            },

            freeze(duration = 5) {
                this.frozen = true;
                // Timer pauses for duration, visual effect handled by TimePowers.useFreeze
                setTimeout(() => {
                    this.frozen = false;
                }, duration * 1000);
            },

            addTime(seconds) {
                this.timeLeft = Math.min(this.timeLeft + seconds, this.maxTime);
                this.update();
            },

            stop() {
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
            }
        };

        // --- TIME POWERS ---
        const TimePowers = {
            freezeCharges: 1,
            rewindCharges: 3,

            reset() {
                this.freezeCharges = 1;
                this.rewindCharges = 3;
                this.updatePowerUI();
            },

            useFreeze() {
                if (this.freezeActive || this.freezeCharges <= 0) return;

                if (typeof onFreezeUsed !== 'undefined') onFreezeUsed(); // ACHIEVEMENT HOOK
                this.freezeCharges--;
                // Assuming updateButtons() is a function that updates the UI for powers
                // If not, this line might cause an error. Keeping it as per instruction.
                if (typeof this.updateButtons === 'function') this.updateButtons();
            },

            // Freeze: Pause timer for 5 seconds (timer only, game continues)
            useFreeze() {
                if (this.freezeCharges <= 0 || TimerSystem.frozen || (!Game.active && (typeof DuelMode === 'undefined' || !DuelMode.active))) return false;
                this.freezeCharges--;

                // Freeze only the timer (not full screen)
                TimerSystem.freeze(5);
                AudioSystem.playFreeze();

                // Apply freeze visual effect only to timer panel
                const timerPanel = document.getElementById('timer-panel');
                if (timerPanel) {
                    timerPanel.classList.add('frozen');
                    setTimeout(() => {
                        timerPanel.classList.remove('frozen');
                    }, 5000);
                }

                const btn = document.getElementById('btn-freeze');
                if (btn) btn.classList.add('used');

                this.updatePowerUI();
                return true;
            },

            // Rewind: Adds Time but ACCELERATES COLLAPSE
            useRewind() {
                if (this.rewindCharges <= 0 || (!Game.active && (typeof DuelMode === 'undefined' || !DuelMode.active))) return false;

                // Special Duel Mode Handling
                if (typeof DuelMode !== 'undefined' && DuelMode.active) {
                    this.rewindCharges--;
                    DuelMode.rewindTime(15000); // Add 15s to day cycle
                    AudioSystem.playRewind();
                    this.updatePowerUI();
                    return true;
                }

                this.rewindCharges--;
                Game.triggerRewindEffect();
                return true;
            },

            // Earn powers through streaks
            onStreak(streakCount) {
                if (streakCount % 3 === 0) {
                    this.freezeCharges++;
                    this.showPowerGain('FREEZE +1');
                }

                if (streakCount % 5 === 0) {
                    if (this.rewindCharges < 3) {
                        this.rewindCharges++;
                        this.showPowerGain('REWIND +1');
                    } else {
                        this.showPowerGain('MAX CHARGES');
                    }
                }
                this.updatePowerUI();
            },

            showPowerGain(text) {
                const popup = document.createElement('div');
                popup.className = 'power-popup'; // Ensure CSS exists
                popup.textContent = text;
                popup.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-family: var(--f-title);
                    font-size: 2rem;
                    color: var(--green);
                    text-shadow: 0 0 20px var(--green);
                    z-index: 9999;
                    animation: powerPopup 1.5s forwards;
                `;
                document.body.appendChild(popup);
                setTimeout(() => popup.remove(), 1500);
            },

            updatePowerUI() {
                // Update freeze button
                const freezeBtn = document.querySelector('.big-freeze-btn');
                if (freezeBtn) {
                    freezeBtn.querySelector('span').textContent = `×${this.freezeCharges} [SPACE]`;
                    if (this.freezeCharges > 0) freezeBtn.classList.remove('used');
                    else freezeBtn.classList.add('used');
                }

                // Update rewind button
                const rewindBtn = document.querySelector('.btn-hud-rewind');
                if (rewindBtn) {
                    rewindBtn.querySelector('span').textContent = `×${this.rewindCharges} [R]`;
                    if (this.rewindCharges > 0) rewindBtn.classList.remove('used');
                    else rewindBtn.classList.add('used');
                }

                // Update Life Pips (Health Bar)
                const pips = document.querySelectorAll('.life-pip');
                pips.forEach((pip, i) => {
                    // Show filled if index < charges
                    if (i < this.rewindCharges) {
                        pip.classList.add('filled');
                        pip.style.background = 'var(--primary)';
                        pip.style.boxShadow = '0 0 10px var(--primary)';
                    } else {
                        pip.classList.remove('filled');
                        pip.style.background = 'rgba(255,255,255,0.1)';
                        pip.style.boxShadow = 'none';
                    }
                });
            }
        };

        // --- DIFFICULTY SYSTEM ---
        // --- DIFFICULTY SYSTEM ---
        const DifficultySystem = {
            level: 1,
            questionsAnswered: 0,

            reset() {
                this.level = 1;
                this.questionsAnswered = 0;
            },

            getTickRate() {
                // User requested 0.25 increment per 5 questions (per level)
                // Level 1 = 1x
                // Level 2 = 1.25x
                return 1 + (this.level - 1) * 0.25;
            },

            getScoreMultiplier() {
                return 1 + (this.level - 1) * 0.25;
            },

            onCorrectAnswer() {
                this.questionsAnswered++;

                // Level up every 5 questions
                if (this.questionsAnswered % 5 === 0) {
                    this.level++;

                    // Show Warning as requested
                    const alert = document.createElement('div');
                    alert.className = 'anomaly-alert';
                    alert.innerHTML = '⚠️ TIME ACCELERATION ⚠️<br>Speed: ' + this.getTickRate().toFixed(2) + 'x';
                    document.body.appendChild(alert);
                    setTimeout(() => alert.remove(), 2000);

                    AudioSystem.playWrong(); // Warning sound
                }
            },
        };

        // --- KEYBOARD SHORTCUTS ---
        document.addEventListener('keydown', (e) => {
            // Prevent interference with input fields
            if (e.target.tagName === 'INPUT') return;

            switch (e.key.toLowerCase()) {
                case ' ': // Spacebar = Freeze
                    e.preventDefault();
                    TimePowers.useFreeze();
                    break;
                case 'r': // R = Rewind
                    TimePowers.useRewind();
                    break;
                case '1':
                case '2':
                case '3':
                case '4':
                    // Quick answer selection
                    const optBtns = document.querySelectorAll('.opt-btn');
                    const idx = parseInt(e.key) - 1;
                    if (optBtns[idx]) optBtns[idx].click();
                    break;
            }
        });

        // --- 3. VISUALS ---
        // MOVED AFTER GAME DEFINITION to fix reference error loop but keeping logic here for structure

        // --- 4. GAME LOGIC ---
        const Game = {
            active: false, score: 0, round: 0, curr: 0,
            currentTopic: null, qData: [], rewinding: false,
            active: false, score: 0, round: 0, curr: 0,
            currentTopic: null, qData: [], rewinding: false,
            streak: 0, multiplier: 1, anomaly: null,
            rewindUsedInRound: false,

            startSequence() {
                // Here we go...
                console.log("Game: Starting sequence. Hold onto your butts.");
                try {
                    if (typeof AudioSystem !== 'undefined') { AudioSystem.init(); AudioSystem.resume(); }
                    // Cue the dramatic intro music
                    if (typeof MusicSystem !== 'undefined') MusicSystem.play('start');
                } catch (e) {
                    console.log("Game: Audio glitch. Classic.", e);
                }
                gameInProgress = true;
                LuckSystem.reset();
                if (typeof StorySystem !== 'undefined') StorySystem.reset();
                this.switchScreen('s-title', 's-luck');
            },

            proceedWithMode() {
                // Called by LuckSystem after mode is selected
                switch (currentGameMode) {
                    case 'A':
                        // Normal mode
                        this.switchScreen('s-luck', 's-roulette');
                        this.startRoulette();
                        break;
                    case 'B':
                        // Dream/Time Loop mode
                        DreamMode.init();
                        this.switchScreen('s-luck', 's-roulette');
                        this.startRoulette();
                        break;
                    case 'C':
                        // Duel mode
                        DuelMode.init();
                        this.switchScreen('s-luck', 's-roulette');
                        this.startRoulette();
                        break;
                    default:
                        this.switchScreen('s-luck', 's-roulette');
                        this.startRoulette();
                }
            },

            startRoulette() {
                const track = document.getElementById('roulette-track');
                const acts = document.getElementById('roulette-actions');

                track.innerHTML = "";
                acts.classList.add('hidden');
                track.style.transform = "translateX(0px)";

                // 1. GENERATE ITEMS 
                const itemCount = 50;
                const targetIndex = 35;
                const itemWidth = 200;

                let targetTopic = null;
                const items = [];

                for (let i = 0; i < itemCount; i++) {
                    const t = TOPICS[Math.floor(Math.random() * TOPICS.length)];
                    const el = document.createElement('div');
                    el.className = 'roulette-item';
                    el.innerText = t.name;
                    track.appendChild(el);

                    if (i === targetIndex) targetTopic = t;
                    items.push({ el, cx: i * itemWidth + itemWidth / 2 });
                }

                this.currentTopic = targetTopic;

                // 2. MATHS
                const finalScroll = (targetIndex * itemWidth) + (itemWidth / 2);

                // Physics
                let scrollX = 0;
                let speed = 0;
                const maxSpeed = 50;
                const accelRate = 1.5;
                const decelDist = 2000;
                const minSpeed = 0.5;

                let state = 'accel';

                const loop = () => {
                    const distRemaining = finalScroll - scrollX;

                    if (distRemaining > decelDist) {
                        if (speed < maxSpeed) speed += accelRate;
                    } else if (distRemaining > 0.5) {
                        let targetSpeed = distRemaining * 0.03;
                        if (targetSpeed > maxSpeed) targetSpeed = maxSpeed;
                        if (targetSpeed < minSpeed) targetSpeed = minSpeed;
                        speed += (targetSpeed - speed) * 0.1;
                    } else {
                        scrollX = finalScroll;
                        speed = 0;
                        state = 'done';
                    }

                    scrollX += speed;
                    track.style.transform = `translateX(-${scrollX}px)`;

                    // DYNAMIC SCALE 
                    const viewCenter = scrollX;
                    const visRange = 1000;

                    items.forEach((it) => {
                        const dist = it.cx - viewCenter;
                        if (Math.abs(dist) > visRange) {
                            it.el.style.transform = 'scale(0.5)';
                            it.el.style.opacity = '0';
                            return;
                        }

                        const normDist = Math.abs(dist) / itemWidth;
                        let scale = Math.max(0.6, 1.4 - (normDist * 0.4));
                        let opacity = Math.max(0.1, 1 - (normDist * 0.6));
                        let blur = Math.min(10, normDist * 3);

                        it.el.style.transform = `scale(${scale})`;
                        it.el.style.opacity = opacity;
                        it.el.style.filter = `blur(${blur}px)`;
                        it.el.style.zIndex = Math.floor(100 - normDist);
                    });

                    // Audio Tick
                    if (speed > 1) {
                        const currIdx = Math.floor(scrollX / itemWidth);
                        const prevIdx = Math.floor((scrollX - speed) / itemWidth);
                        if (currIdx !== prevIdx) AudioSystem.playRouletteClick();
                    }

                    if (state !== 'done') {
                        requestAnimationFrame(loop);
                    } else {
                        // Finished
                        items[targetIndex].el.classList.add('locked');
                        items[targetIndex].el.style.transform = 'scale(1.5)';
                        items[targetIndex].el.style.opacity = '1';
                        AudioSystem.playCorrect(); // Win sound replacement
                        acts.classList.remove('hidden');
                    }
                };

                requestAnimationFrame(loop);
            },

            confirmTopic() {
                document.body.className = this.currentTopic.theme;
                this.switchScreen('s-roulette', 's-timeline');
            },

            reroll() { this.startRoulette(); },

            startGame(dir) {
                try {
                    this.qData = [...this.currentTopic.qs];
                    if (dir === 'asc') this.qData.sort((a, b) => a.y - b.y); else this.qData.sort((a, b) => b.y - b.y);

                    this.score = 0; this.round = 0;
                    this.streak = 0; this.multiplier = 1; this.anomaly = null;

                    DifficultySystem.reset();
                    TimePowers.reset();
                    // Ensure Timer is stopped before starting new
                    TimerSystem.stop();

                    if (typeof MusicSystem !== 'undefined') MusicSystem.play('gameplay');

                    document.getElementById('hud').classList.remove('hidden');
                    document.getElementById('hud-score').innerText = "0";
                    document.getElementById('hud-streak').innerText = "";

                    // Reset UI - No lives to reset

                    // TRIGGER HYPE SEQUENCE
                    this.switchScreen('s-timeline', 's-hype');
                    this.runHypeSequence();
                } catch (e) { alert("Start Error: " + e.message); console.error(e); }
            },

            runHypeSequence() {
                const c = document.getElementById('hype-count');
                const m = document.getElementById('hype-msg-cont');
                m.classList.add('hidden'); m.innerHTML = '';

                let num = 3;
                c.innerText = num;
                c.classList.remove('hidden');

                AudioSystem.playRouletteClick(); // Beep

                const step = () => {
                    c.style.animation = 'none';
                    c.offsetHeight;
                    c.style.animation = 'zoomFade 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards';

                    c.innerText = num;
                    AudioSystem.playRouletteClick();

                    if (num > 0) {
                        num--;
                        setTimeout(step, 800);
                    } else {
                        c.classList.add('hidden');
                        m.classList.remove('hidden');
                        AudioSystem.playCorrect();

                        const text = "READY TO REWIND TO WIN";
                        const words = text.split(' ');

                        words.forEach((word, wi) => {
                            const wSpan = document.createElement('div');
                            wSpan.style.display = "inline-block";
                            wSpan.style.margin = "0 15px";

                            word.split('').forEach((char, ci) => {
                                const s = document.createElement('span');
                                s.className = 'hype-char';
                                s.innerText = char;
                                s.style.animationDelay = `${(wi * 2 + ci) * 0.05}s`;
                                if (word === "WIN" || word === "REWIND") s.style.color = "var(--primary)";
                                wSpan.appendChild(s);
                            });
                            m.appendChild(wSpan);
                            if (word === "REWIND") {
                                const br = document.createElement('div');
                                br.style.flexBasis = "100%";
                                br.style.height = "20px";
                                m.appendChild(br);
                            }
                        });


                        setTimeout(() => {
                            const chars = document.querySelectorAll('.hype-char');
                            chars.forEach((char, i) => {
                                char.classList.add('out');
                                char.style.animationDelay = `${i * 0.02}s`;
                            });

                            setTimeout(() => {
                                // Choose correct game screen based on mode
                                if (currentGameMode === 'C') {
                                    this.switchScreen('s-hype', 's-game-duel');
                                } else {
                                    this.switchScreen('s-hype', 's-game');
                                }
                                c.classList.remove('hidden');
                                this.nextRound();
                            }, 800);
                        }, 2000);
                    }
                };
                step();
            },

            nextRound() {
                if (this.round >= this.qData.length) { this.gameWin(); return; }

                const d = this.qData[this.round];
                this.rewindUsedInRound = false;

                // Handle Duel Mode (Mode C) separately
                if (currentGameMode === 'C' && DuelMode.active) {
                    DuelMode.loadDuelQuestion(d);
                    return;
                }

                // Normal and Dream mode use standard game screen
                document.getElementById('era-display').innerText = `YEAR: ${d.y}`;
                document.getElementById('q-text').innerText = d.q;

                const gr = document.getElementById('opt-area'); gr.innerHTML = '';
                [d.a, ...d.w].sort(() => Math.random() - 0.5).forEach(txt => {
                    const b = document.createElement('div');
                    b.className = 'opt-btn'; b.innerText = txt;
                    b.onclick = (e) => this.check(txt, d.a, e);
                    gr.appendChild(b);
                });

                this.active = true;

                // ANOMALY SYSTEM 
                document.body.classList.remove('anomaly-mirror', 'anomaly-fast');
                this.anomaly = null;

                if (Math.random() < 0.3 && this.round > 2) {
                    const type = Math.random() > 0.5 ? 'mirror' : 'fast';
                    this.anomaly = type;

                    const notif = document.createElement('div');
                    notif.className = 'anomaly-alert';

                    if (type === 'mirror') {
                        document.body.classList.add('anomaly-mirror');
                        notif.innerText = "⚠ REALITY INVERSION DETECTED ⚠";
                    } else {
                        // Fast mode handling
                        // TimerSystem will need to know about this? 
                        // Or we just reduce the start time?
                        // The old code reduced time *rate* (drop = 40 instead of 20).
                        // I will set TimerSystem total time to be less? Or I need to tell TimerSystem to tick faster?
                        // Simpler: Just reduce the initial time by half for this round or set a flag.
                        // I'll set a flag in TimerSystem or just act like 'fast' = less time.
                        notif.innerText = "⚠ CHRONO-ACCELERATION DETECTED ⚠";
                    }
                    document.body.appendChild(notif);
                    setTimeout(() => notif.remove(), 2000);
                    AudioSystem.playWrong(); // Use harsh sound for warn
                }

                // Start Timer ONLY if it's the first round (or we handle it in startGame)
                // Actually, startGame calls nextRound. 
                // We want Global Timer to start once.

                if (this.round === 0) {
                    TimerSystem.start(60); // 60s Start
                }
                // Do NOT call TimerSystem.start() every round anymore.

            },

            // Timeout Handler
            handleTimeOut() {
                this.showFailState();
            },

            // Manual Rewind Effect (The "R" Key)
            triggerRewindEffect() {
                // 1. Visuals
                AudioSystem.playRewind();
                document.body.classList.add('is-rewinding');
                setTimeout(() => document.body.classList.remove('is-rewinding'), 500);

                // 2. Logic: Gain Time but Pay the Price
                TimerSystem.addTime(10); // +10 Seconds
                this.showTimeFeedback(10);

                // 3. THE PRICE: Acceleration
                DifficultySystem.level++;
                const speed = DifficultySystem.getTickRate().toFixed(2);

                // 4. Alert
                const alert = document.createElement('div');
                alert.className = 'anomaly-alert';
                alert.innerHTML = `⚠️ CHRONO-ACCELERATION ⚠️<br>SPEED: ${speed}x`;
                document.body.appendChild(alert);
                setTimeout(() => alert.remove(), 2500);
            },

            // Called from Fail Modal
            triggerRewind() {
                // Use a charge if available (Uncapped usage per round as requested)
                if (TimePowers.rewindCharges > 0) {
                    TimePowers.rewindCharges--;
                    TimePowers.updatePowerUI();

                    // Mark as used for this round (Legacy: removed restriction)
                    // this.rewindUsedInRound = true;

                    document.getElementById('fail-modal').classList.remove('active');
                    document.body.classList.remove('paradox-hit');

                    // Recover with bonus time
                    AudioSystem.playRewind();
                    this.rewinding = true;
                    document.body.classList.add('is-rewinding');

                    setTimeout(() => {
                        this.rewinding = false;
                        document.body.classList.remove('is-rewinding');

                        // Restart Round or Just Add Time?
                        // User expects to "continue".
                        // Add +15s (Reduced from 20s) and ACCELERATE
                        this.active = true;
                        TimerSystem.addTime(15);

                        // --- THE COLLAPSE ACCELERATES ---
                        DifficultySystem.level++;
                        const speed = DifficultySystem.getTickRate().toFixed(2);

                        // Visual Warning
                        const alert = document.createElement('div');
                        alert.className = 'anomaly-alert';
                        alert.innerHTML = `⚠️ TIMELINE UNSTABLE ⚠️<br>SPEED INCREASED TO ${speed}x`;
                        document.body.appendChild(alert);
                        setTimeout(() => alert.remove(), 3000);

                        TimerSystem.start(TimerSystem.timeLeft);

                    }, 1000);

                } else {
                    // Feedback: No charges!
                    const btn = document.querySelector('.btn-rewind');
                    btn.classList.add('shake');
                    setTimeout(() => btn.classList.remove('shake'), 400);
                }
            },

            check(ans, cor, e) {
                if (!this.active) return;
                this.active = false; // LOCK INPUT


                if (ans === cor) {
                    if (typeof onCorrectAnswer !== 'undefined') onCorrectAnswer(); // ACHIEVEMENT HOOK
                    AudioSystem.playCorrect();
                    if (e && typeof showScorePop === 'function') showScorePop(e.clientX, e.clientY);

                    // GAIN TIME +5s
                    TimerSystem.addTime(5);
                    this.showTimeFeedback(5);

                    // Reset single-rewind flag on correct answer (redundant but safe)
                    this.rewindUsedInRound = false;

                    // STREAK LOGIC
                    this.streak++;
                    DifficultySystem.onCorrectAnswer();
                    TimePowers.onStreak(this.streak); // Check for power gains

                    let multimsg = "";
                    this.multiplier = DifficultySystem.getScoreMultiplier(); // Base multiplier from difficulty

                    if (this.streak > 1) {
                        // Add streak bonus to multiplier
                        this.multiplier += Math.min(4, Math.ceil(this.streak / 2));
                        multimsg = ` x${this.multiplier.toFixed(1)}`;
                        document.getElementById('hud-streak').innerText = "STREAK " + this.streak + multimsg;
                        document.getElementById('hud-streak').classList.add('pulse-text');

                        // Show Streak Overlay
                        Game.showConditionOverlay('streak', `STREAK ${this.streak}x`);
                    }

                    // Sparkle
                    const hud = document.getElementById('hud-score');
                    const rect = hud.getBoundingClientRect();
                    const el = document.createElement('div');
                    el.className = 'score-sparkle';
                    let baseVal = 100 + Math.ceil(TimerSystem.timeLeft * 10);
                    let finalVal = Math.floor(baseVal * this.multiplier);
                    el.innerText = `+${finalVal}`;
                    el.style.left = (rect.left + Math.random() * 20) + 'px';
                    el.style.top = rect.top + 'px';
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 1000);

                    this.score += finalVal;
                    document.getElementById('hud-score').innerText = this.score;

                    // Dream Mode (Mode B) - Check for dream trigger
                    if (currentGameMode === 'B' && DreamMode.active) {
                        if (DreamMode.onQuestionAnswered()) {
                            // Trigger dream sequence - player wins if they completed without dying
                            TimerSystem.stop();
                            DreamMode.triggerDreamSequence(true);
                            return;
                        }
                    }

                    this.round++; this.nextRound();
                } else {
                    // WRONG ANSWER LOGIC
                    if (typeof onWrongAnswer !== 'undefined') onWrongAnswer(); // ACHIEVEMENT HOOK
                    AudioSystem.playWrong();

                    // Lose Time (-5s)
                    TimerSystem.addTime(-5);
                    this.showTimeFeedback(-5);

                    // Visual Feedback
                    const btn = document.querySelector('.btn-rewind'); // Reuse shake logic or add new?
                    document.body.classList.add('paradox-hit');
                    setTimeout(() => document.body.classList.remove('paradox-hit'), 200);

                    this.streak = 0;
                    this.multiplier = 1;
                    document.getElementById('hud-streak').innerText = "";

                    // FATAL CHECK
                    if (TimerSystem.timeLeft <= 0) {
                        this.showFailState();
                    } else {
                        // CONTINUE (Not too change logic: Keeps game flowing)
                        this.round++;
                        this.nextRound();
                    }
                }
            },

            showTimeFeedback(seconds) {
                const indicator = document.createElement('div');
                indicator.className = seconds > 0 ? 'time-indicator time-gain' : 'time-indicator time-loss';
                indicator.textContent = (seconds > 0 ? '+' : '') + seconds + 's';

                // Quick inline styling since CSS might be missing again
                indicator.style.position = 'fixed';
                indicator.style.top = '50%';
                indicator.style.left = '50%';
                indicator.style.transform = 'translate(-50%, -50%)';
                indicator.style.fontSize = '4rem';
                indicator.style.fontWeight = 'bold';
                indicator.style.color = seconds > 0 ? '#00ff00' : '#ff003c';
                indicator.style.zIndex = '10000';
                indicator.style.pointerEvents = 'none';
                indicator.style.textShadow = '0 0 20px currentColor';
                indicator.style.animation = 'floatUp 1s forwards'; // Need keyframes or JS anim

                // Add simple float animation if CSS keyframes missing
                indicator.animate([
                    { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 },
                    { transform: 'translate(-50%, -150%) scale(1.5)', opacity: 0 }
                ], { duration: 1000, easing: 'ease-out' });

                document.body.appendChild(indicator);
                setTimeout(() => indicator.remove(), 1000);
            },



            showFailState() {
                this.active = false;
                TimerSystem.stop();
                AudioSystem.playWrong();

                // Dream Mode (Mode B) - trigger dream loop instead of fail
                if (currentGameMode === 'B' && DreamMode.active) {
                    DreamMode.triggerDreamSequence(false); // false = loss
                    return;
                }

                // Update Rewind Button Text
                const btn = document.querySelector('.btn-rewind');
                if (btn) {
                    const count = TimePowers.rewindCharges;

                    if (this.rewindUsedInRound) {
                        btn.innerHTML = `LOCKED<br><span style="font-size:0.8rem">ALREADY REWOUND</span>`;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                        btn.disabled = true;
                    } else if (count <= 0) {
                        btn.innerHTML = `REWIND<br><span style="font-size:0.8rem">NO CHARGES</span>`;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                        btn.disabled = true;
                    } else {
                        btn.innerHTML = `REWIND<br><span style="font-size:0.8rem">CHARGES: ${count}</span>`;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.disabled = false;
                    }
                }

                document.getElementById('fail-modal').classList.add('active');
                document.body.classList.add('paradox-hit');
            },

            showConditionOverlay(type, text) {
                const el = document.createElement('div');
                el.className = 'anomaly-alert';
                el.style.top = '20%';
                el.style.color = type === 'streak' ? 'var(--green)' : 'var(--primary)';
                el.innerHTML = text;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 1500);
            },



            gameWin() {
                this.active = false;
                TimerSystem.stop();
                if (typeof saveScore === 'function') saveScore(this.score);
                if (typeof MusicSystem !== 'undefined') MusicSystem.play('gameover');
                AudioSystem.playCorrect();
                if (typeof onGameWinAC !== 'undefined') onGameWinAC(TimerSystem.timeLeft);

                // Cleanup any active modes
                if (currentGameMode === 'B') DreamMode.cleanup();
                if (currentGameMode === 'C') DuelMode.cleanup();

                // Set victory headline before showing game over screen
                this.isWin = true;
                const headline = document.getElementById('game-over-headline');
                if (headline) {
                    headline.textContent = 'NEURAL SYNC COMPLETE';
                    headline.style.color = 'var(--green)';
                    headline.style.textShadow = '0 0 30px var(--green)';
                }

                // Update final score for display
                document.getElementById('final-aura-score').textContent = this.score;

                // Hide HUD and game screens
                document.getElementById('hud').classList.add('hidden');
                document.getElementById('s-game').classList.add('hidden');
                document.getElementById('s-game-duel').classList.add('hidden');

                // Use the same outro sequence as game over
                this.runOutroSequence();
            },

            gameOver() {
                this.active = false; AudioSystem.playWrong();
                // MusicSystem.play handles searching/stopping current track
                gameInProgress = false;
                document.getElementById('fail-modal').classList.remove('active');
                document.body.classList.add('power-off-anim');

                // Cleanup any active modes
                if (currentGameMode === 'B') DreamMode.cleanup();
                if (currentGameMode === 'C') DuelMode.cleanup();

                // Reset headline to SIGNAL LOST for game over
                this.isWin = false;
                const headline = document.getElementById('game-over-headline');
                if (headline) {
                    headline.textContent = 'SIGNAL LOST';
                    headline.style.color = 'var(--danger)';
                    headline.style.textShadow = '0 0 30px var(--danger)';
                }

                // Cue the sad violin... or menacing drone in our case
                if (typeof MusicSystem !== 'undefined') MusicSystem.play('gameover');

                setTimeout(() => {
                    document.body.classList.remove('power-off-anim');
                    document.getElementById('hud').classList.add('hidden');
                    document.getElementById('s-game').classList.add('hidden');
                    document.getElementById('s-game-duel').classList.add('hidden');
                    this.runOutroSequence();
                }, 700);
            },

            runOutroSequence() {
                const s = document.getElementById('s-outro');
                const t1 = document.getElementById('outro-t1');
                const t2 = document.getElementById('outro-t2');
                const t3 = document.getElementById('outro-t3');
                const fin = document.getElementById('outro-final');
                const wRes = document.getElementById('word-restart');
                const wRew = document.getElementById('word-rewind');

                s.classList.remove('hidden');
                setTimeout(() => s.classList.add('active'), 10);

                [t1, t2, t3].forEach(el => { el.className = 'outro-text'; el.style.opacity = '0'; });
                fin.classList.add('hidden');
                wRes.style.opacity = '0.5'; wRes.style.textDecoration = "none";
                wRew.style.display = 'none';

                const play = (el, delay, dur) => {
                    setTimeout(() => { el.classList.add('anim-in'); AudioSystem.playRouletteClick(); }, delay);
                    setTimeout(() => { el.classList.remove('anim-in'); el.classList.add('anim-out'); }, delay + dur);
                };

                play(t1, 500, 1000);
                play(t2, 1800, 1000);
                play(t3, 3100, 1500);

                setTimeout(() => {
                    fin.classList.remove('hidden');
                    fin.style.opacity = 1;
                    wRes.style.opacity = 1;

                    setTimeout(() => {
                        wRes.style.textDecoration = 'line-through';
                        wRes.style.textDecorationColor = 'var(--danger)';
                        AudioSystem.playWrong();

                        setTimeout(() => {
                            wRew.style.display = 'inline-block';
                            wRew.style.animation = 'glitchText 0.3s infinite';
                            AudioSystem.playRewind();

                            setTimeout(() => {
                                s.classList.add('hidden');
                                document.getElementById('final-aura-score').innerText = this.score;
                                document.getElementById('s-over').classList.remove('hidden');
                                setTimeout(() => document.getElementById('s-over').classList.add('active'), 50);
                            }, 2000);
                        }, 800);
                    }, 800);
                }, 5000);
            },

            switchScreen(from, to) {
                document.getElementById(from).classList.remove('active');
                document.getElementById(from).classList.add('hidden');
                document.getElementById(to).classList.remove('hidden');
                setTimeout(() => document.getElementById(to).classList.add('active'), 10);

                // Trigger Story System
                setTimeout(async () => {
                    if (to === 's-luck') {
                        await StorySystem.playStory('fate', 'fate', 'luck-box-container');
                    } else if (to === 's-timeline') {
                        await StorySystem.playStory('timeline', 'timeline', 'timeline-controls');
                    } else if (to === 's-roulette') {
                        await StorySystem.playStory('roulette', 'roulette', 'roulette-actions');
                    }
                }, 300);
            }
        };

        // --- VISUALS (Placed After Game Logic to Prevent ReferenceError) ---
        const Canvas = {
            el: document.getElementById('c'), ctx: document.getElementById('c').getContext('2d'), w: 0, h: 0, particles: [], init() { this.resize(); window.addEventListener('resize', () => this.resize()); for (let i = 0; i < 400; i++)this.particles.push({ x: (Math.random() - 0.5) * window.innerWidth, y: (Math.random() - 0.5) * window.innerHeight, z: Math.random() * 2000 }); this.loop(); }, resize() { this.w = this.el.width = window.innerWidth; this.h = this.el.height = window.innerHeight; this.cx = this.w / 2; this.cy = this.h / 2; }, loop() {
                let bg = getComputedStyle(document.body).getPropertyValue('--bg-color');
                this.ctx.fillStyle = bg; this.ctx.fillRect(0, 0, this.w, this.h);

                let col = getComputedStyle(document.body).getPropertyValue('--particle-col');
                this.ctx.fillStyle = col;

                let spd = (typeof Game !== 'undefined' && Game.active) ? 20 : 5;
                if (typeof Game !== 'undefined' && Game.rewinding) spd = -40;

                this.particles.forEach(p => {
                    p.z -= spd;
                    if (p.z <= 0) { p.z = 2000; p.x = (Math.random() - 0.5) * this.w * 2; p.y = (Math.random() - 0.5) * this.h * 2; }
                    if (p.z > 2000) { p.z = 10; } // Loop back if rewinding

                    let scale = 500 / p.z;
                    let x2d = this.cx + p.x * scale;
                    let y2d = this.cy + p.y * scale;

                    // Draw Streak
                    let size = Math.max(0.5, 3 * scale);
                    if (x2d > 0 && x2d < this.w && y2d > 0 && y2d < this.h) {
                        // Opacity based on depth
                        this.ctx.globalAlpha = Math.min(1, scale);
                        this.ctx.fillRect(x2d, y2d, size, size);
                    }
                });
                this.ctx.globalAlpha = 1;
                requestAnimationFrame(() => this.loop());
            }
        };

        function toggleTheme() { document.body.classList.toggle('light-mode'); }
        function updateName(v) { document.getElementById('final-name').innerText = v.toUpperCase() || "UNKNOWN"; }

        // STARTUP
        Canvas.init();

        // EVENT LISTENER BINDING
        document.getElementById('init-btn').addEventListener('click', () => {
            Game.startSequence();
        });

        // =========================================
        // FEEDBACK SYSTEM
        // =========================================
        const GOOGLE_FORM_URL = 'https://forms.gle/QptiuezmtJs8iFJZ9';

        function sendFeedback() {
            const btn = document.querySelector('.send-feedback-btn');

            // Visual confirmation
            btn.textContent = '✓ OPENING FORM...';
            btn.classList.add('sent');

            // Play success sound
            if (AudioSystem && AudioSystem.playCorrect) {
                AudioSystem.playCorrect();
            }

            // Open Google Form in new tab
            setTimeout(() => {
                window.open(GOOGLE_FORM_URL, '_blank');
                btn.textContent = '✓ FORM OPENED!';
            }, 300);
        }

        // Add shake animation for feedback button
        const shakeStyle = document.createElement('style');
        shakeStyle.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(shakeStyle);

        // Extra visual polish stuff

        // Heartbeat visual sync
        const HeartbeatVignetteSystem = {
            vignetteEl: null,

            init() {
                this.vignetteEl = document.getElementById('heartbeat-vignette');
            },

            pulse(bpm) {
                if (!this.vignetteEl) this.init();
                if (!this.vignetteEl) return;

                // Calculate animation speed from BPM (faster BPM = faster pulse)
                const speed = 60000 / bpm / 1000; // Convert to seconds
                this.vignetteEl.style.setProperty('--heartbeat-speed', speed + 's');

                // Trigger pulse animation
                this.vignetteEl.classList.remove('pulse');
                void this.vignetteEl.offsetWidth; // Force reflow
                this.vignetteEl.classList.add('pulse');
            },

            stop() {
                if (this.vignetteEl) {
                    this.vignetteEl.classList.remove('pulse');
                }
            }
        };

        // Override HeartbeatSystem.playBeat to sync vignette
        if (typeof HeartbeatSystem !== 'undefined') {
            const originalPlayBeat = HeartbeatSystem.playBeat;
            HeartbeatSystem.playBeat = function () {
                originalPlayBeat.call(this);
                // Sync vignette pulse with audio heartbeat
                if (this.currentBPM > 0) {
                    HeartbeatVignetteSystem.pulse(this.currentBPM);
                }
            };

            const originalStop = HeartbeatSystem.stop;
            HeartbeatSystem.stop = function () {
                originalStop.call(this);
                HeartbeatVignetteSystem.stop();
            };
        }

        // Last breath clutch mechanic - gives you half a second to save yourself
        const DeathsDoorSystem = {
            active: false,
            timeout: null,

            enter() {
                if (this.active) return;
                this.active = true;

                // Stop all sounds except allow answer clicks
                if (typeof bgMusic !== 'undefined') bgMusic.pause();
                if (typeof HeartbeatSystem !== 'undefined') HeartbeatSystem.stop();

                // Apply death's door visual
                document.body.classList.add('deaths-door');

                // Allow 500ms window for clutch save
                this.timeout = setTimeout(() => {
                    this.exit(false); // No clutch save
                }, 500);
            },

            exit(clutchSave = false) {
                if (!this.active) return;
                this.active = false;

                if (this.timeout) {
                    clearTimeout(this.timeout);
                    this.timeout = null;
                }

                document.body.classList.remove('deaths-door');

                if (clutchSave) {
                    this.celebrateClutchSave();
                } else {
                    // Proceed to game over
                    if (typeof Game !== 'undefined') {
                        Game.gameOver();
                    }
                }
            },

            celebrateClutchSave() {
                // Show clutch save overlay
                const overlay = document.getElementById('clutch-save-overlay');
                if (overlay) {
                    overlay.classList.add('active');
                    setTimeout(() => overlay.classList.remove('active'), 1500);
                }

                // Award bonus points
                if (typeof Game !== 'undefined') {
                    Game.score += 500;
                    document.getElementById('hud-score').innerText = Game.score;

                    // Show bonus feedback
                    const bonus = document.createElement('div');
                    bonus.className = 'anomaly-alert';
                    bonus.style.color = 'var(--green)';
                    bonus.innerHTML = '⚡ +500 CLUTCH BONUS ⚡';
                    document.body.appendChild(bonus);
                    setTimeout(() => bonus.remove(), 2000);
                }

                // Resume timer with small bonus
                if (typeof TimerSystem !== 'undefined') {
                    TimerSystem.timeLeft = 5; // Give 5 seconds
                    TimerSystem.update();
                    TimerSystem.frozen = false;
                }

                // Play celebration sound
                if (typeof AudioSystem !== 'undefined') AudioSystem.playCorrect();

                // Resume music
                if (typeof bgMusic !== 'undefined') {
                    bgMusic.play().catch(() => { });
                }

                // Continue to next question
                if (typeof Game !== 'undefined') {
                    Game.active = true;
                    Game.round++;
                    Game.nextRound();
                }
            },

            // Check if an answer was clicked during death's door
            checkClutch(isCorrect) {
                if (this.active && isCorrect) {
                    this.exit(true); // Clutch save!
                    return true;
                }
                return false;
            }
        };

        // Override TimerSystem to trigger death's door instead of immediate game over
        if (typeof TimerSystem !== 'undefined') {
            const originalTimerInterval = TimerSystem.start;
            TimerSystem.start = function (seconds = 15) {
                this.maxTime = seconds;
                this.timeLeft = seconds;
                this.frozen = false;
                this.update();

                if (this.interval) clearInterval(this.interval);
                this.interval = setInterval(() => {
                    if (this.frozen) return;

                    let rate = 0.1 * (typeof DifficultySystem !== 'undefined' ? DifficultySystem.getTickRate() : 1);
                    if (document.body.classList.contains('anomaly-fast')) rate *= 2;

                    this.timeLeft -= rate;
                    this.update();

                    if (this.timeLeft <= 10 && this.timeLeft > 0) {
                        if (Math.floor(this.timeLeft * 5) % 5 === 0) {
                            if (typeof AudioSystem !== 'undefined') AudioSystem.playTick();
                        }
                    }

                    // LAST BREATH: Instead of immediate game over, trigger death's door
                    if (this.timeLeft <= 0) {
                        this.stop();
                        DeathsDoorSystem.enter();
                    }
                }, 100);
            };
        }

        // Override Game.check to support clutch saves
        if (typeof Game !== 'undefined') {
            const originalGameCheck = Game.check;
            Game.check = function (ans, cor) {
                // Check if in death's door and this is a correct answer
                if (DeathsDoorSystem.active) {
                    if (ans === cor) {
                        DeathsDoorSystem.checkClutch(true);
                    } else {
                        DeathsDoorSystem.exit(false); // Wrong answer during death's door = game over
                    }
                    return;
                }

                // Normal answer check
                originalGameCheck.call(this, ans, cor);
            };
        }

        // Screen crack effect on anchor loss
        const ScreenCrackSystem = {
            crackEl: null,
            crackCount: 0,

            init() {
                this.crackEl = document.getElementById('screen-crack-overlay');
            },

            showCrack() {
                if (!this.crackEl) this.init();
                if (!this.crackEl) return;

                this.crackCount++;
                this.crackEl.classList.add('cracked');

                // Fade out after delay
                setTimeout(() => {
                    if (this.crackEl) this.crackEl.classList.remove('cracked');
                }, 2000);
            },

            reset() {
                this.crackCount = 0;
                if (this.crackEl) this.crackEl.classList.remove('cracked');
            }
        };

        // Override TimePowers.useRewind to trigger screen crack
        if (typeof TimePowers !== 'undefined') {
            const originalUseRewind = TimePowers.useRewind;
            TimePowers.useRewind = function () {
                const hadCharges = this.rewindCharges > 0;
                const result = originalUseRewind.call(this);

                // Show screen crack when losing an anchor
                if (hadCharges && result) {
                    ScreenCrackSystem.showCrack();
                }

                return result;
            };
        }

        // Stamp system for game over card
        const KIAStampSystem = {
            stampEl: null,

            init() {
                this.stampEl = document.getElementById('kia-stamp');
            },

            triggerStamp() {
                if (!this.stampEl) this.init();
                if (!this.stampEl) return;

                // Check if this is a win or loss
                const isWin = typeof Game !== 'undefined' && Game.isWin;

                // Update stamp text and color based on win/loss
                if (isWin) {
                    this.stampEl.textContent = 'SYNCED';
                    this.stampEl.style.color = 'rgba(57, 255, 20, 0.9)';
                    this.stampEl.style.borderColor = 'rgba(57, 255, 20, 0.9)';
                    this.stampEl.style.textShadow = '0 0 10px rgba(57, 255, 20, 0.5)';
                } else {
                    this.stampEl.textContent = 'K.I.A.';
                    this.stampEl.style.color = 'rgba(255, 0, 60, 0.9)';
                    this.stampEl.style.borderColor = 'rgba(255, 0, 60, 0.9)';
                    this.stampEl.style.textShadow = '0 0 10px rgba(255, 0, 60, 0.5)';
                }

                // Add dramatic delay then slam stamp
                setTimeout(() => {
                    if (this.stampEl) {
                        this.stampEl.classList.add('stamped');
                        // Play appropriate sound
                        if (typeof AudioSystem !== 'undefined') {
                            if (isWin) {
                                AudioSystem.playCorrect();
                            } else {
                                AudioSystem.playWrong();
                            }
                        }
                    }
                }, 500);
            },

            reset() {
                if (this.stampEl) {
                    this.stampEl.classList.remove('stamped');
                }
            }
        };

        // Override Game.runOutroSequence to trigger KIA stamp
        if (typeof Game !== 'undefined') {
            const originalRunOutroSequence = Game.runOutroSequence;
            Game.runOutroSequence = function () {
                // Save score on game over (loss/KIA)
                if (typeof saveScore === 'function') saveScore(this.score || 0);

                // Reset stamp before showing
                KIAStampSystem.reset();

                // Call original
                originalRunOutroSequence.call(this);

                // Trigger stamp when game over screen appears
                setTimeout(() => {
                    KIAStampSystem.triggerStamp();
                }, 5500); // After outro sequence completes
            };
        }

        // Canvas glitch effects when time gets low
        if (typeof Canvas !== 'undefined') {
            const originalCanvasLoop = Canvas.loop;
            Canvas.loop = function () {
                let bg = getComputedStyle(document.body).getPropertyValue('--bg-color');
                this.ctx.fillStyle = bg;
                this.ctx.fillRect(0, 0, this.w, this.h);

                let col = getComputedStyle(document.body).getPropertyValue('--particle-col');
                this.ctx.fillStyle = col;

                let spd = (typeof Game !== 'undefined' && Game.active) ? 20 : 5;
                if (typeof Game !== 'undefined' && Game.rewinding) spd = -40;

                // FEATURE 3: Calculate stability for world decay effects
                let stability = 100;
                if (typeof TimerSystem !== 'undefined' && typeof Game !== 'undefined' && Game.active) {
                    stability = Math.max(0, (TimerSystem.timeLeft / 60) * 100);
                }

                this.particles.forEach((p, i) => {
                    p.z -= spd;
                    if (p.z <= 0) { p.z = 2000; p.x = (Math.random() - 0.5) * this.w * 2; p.y = (Math.random() - 0.5) * this.h * 2; }
                    if (p.z > 2000) { p.z = 10; }

                    let scale = 500 / p.z;
                    let x2d = this.cx + p.x * scale;
                    let y2d = this.cy + p.y * scale;

                    // FEATURE 3: Add jitter at low stability
                    if (stability < 50) {
                        const jitterAmount = (50 - stability) / 10;
                        x2d += (Math.random() - 0.5) * jitterAmount;
                        y2d += (Math.random() - 0.5) * jitterAmount;
                    }

                    let size = Math.max(0.5, 3 * scale);
                    if (x2d > 0 && x2d < this.w && y2d > 0 && y2d < this.h) {
                        this.ctx.globalAlpha = Math.min(1, scale);

                        // FEATURE 3: Color shift at very low stability
                        if (stability < 20 && Math.random() < 0.1) {
                            this.ctx.fillStyle = Math.random() > 0.5 ? '#ff003c' : '#00f3ff';
                        }

                        this.ctx.fillRect(x2d, y2d, size, size);
                        this.ctx.fillStyle = col; // Reset color
                    }
                });

                // FEATURE 3: Add glitch blocks at critical stability
                if (stability < 20 && typeof Game !== 'undefined' && Game.active) {
                    for (let i = 0; i < 3; i++) {
                        if (Math.random() < 0.3) {
                            this.ctx.fillStyle = Math.random() > 0.5 ? 'rgba(255,0,60,0.3)' : 'rgba(0,243,255,0.3)';
                            const gx = Math.random() * this.w;
                            const gy = Math.random() * this.h;
                            const gw = Math.random() * 100 + 20;
                            const gh = Math.random() * 20 + 5;
                            this.ctx.fillRect(gx, gy, gw, gh);
                        }
                    }
                }

                this.ctx.globalAlpha = 1;
                requestAnimationFrame(() => this.loop());
            };
        }

        // Initialize new systems
        HeartbeatVignetteSystem.init();
        ScreenCrackSystem.init();
        KIAStampSystem.init();

        // =============================================
        // ATTACH TOGGLE BUTTON EVENT LISTENERS
        // =============================================
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🔧 Attaching toggle button event listeners...');

            const themeBtn = document.getElementById('theme-toggle-btn');

            if (themeBtn) {
                themeBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    console.log('🔄 Theme button clicked via event listener!');
                    toggleTheme();
                });
                console.log('✅ Theme button listener attached');
            } else {
                console.error('❌ Theme button not found!');
            }
            // Initialize +1 pop-up container (already in HTML)
            // Initialize leaderboard modal handling
            const leaderboardModal = document.getElementById('leaderboard-modal');
            const closeLeaderboardBtn = document.getElementById('close-leaderboard');
            if (closeLeaderboardBtn) {
                closeLeaderboardBtn.addEventListener('click', () => {
                    leaderboardModal.classList.add('hidden');
                });
            }
            // Function to show leaderboard (populate list from localStorage)
            function showLeaderboard() {
                const scores = JSON.parse(localStorage.getItem('neuro_fried_scores') || '[]');
                const list = document.getElementById('leaderboard-list');
                if (list) {
                    list.innerHTML = '';
                    scores.slice(0, 3).forEach((s, i) => {
                        const li = document.createElement('li');
                        li.textContent = `${i + 1}. ${s}`;
                        list.appendChild(li);
                    });
                }
                leaderboardModal.classList.remove('hidden');
            }
            // Save score function (to be called on game over)
            function saveScore(score) {
                const scores = JSON.parse(localStorage.getItem('neuro_fried_scores') || '[]');
                scores.push(score);
                scores.sort((a, b) => b - a);
                localStorage.setItem('neuro_fried_scores', JSON.stringify(scores));
            }
            // Dark mode toggle implementation
            function toggleTheme() {
                const html = document.documentElement;
                const current = html.getAttribute('data-theme') || 'dark';
                const next = current === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', next);
            }
            // Blood drop generator (simple interval creating small divs)
            function spawnBloodDrop() {
                const container = document.getElementById('blood-drop-container');
                if (!container) return;
                const drop = document.createElement('div');
                drop.style.position = 'absolute';
                drop.style.width = '4px';
                drop.style.height = '10px';
                drop.style.background = 'rgba(139,0,0,0.7)';
                drop.style.left = Math.random() * window.innerWidth + 'px';
                drop.style.top = '-20px';
                drop.style.opacity = '0.8';
                drop.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';
                container.appendChild(drop);
                // animate falling
                const duration = 2000 + Math.random() * 1000;
                drop.animate([
                    { transform: `translateY(${window.innerHeight + 20}px)` },
                    { opacity: 0 }
                ], { duration, easing: 'ease-out' });
                setTimeout(() => drop.remove(), duration);
            }
            // Start blood drops interval during gameplay
            let bloodInterval = null;
            function startBloodDrops() {
                if (bloodInterval) return;
                bloodInterval = setInterval(spawnBloodDrop, 300);
            }
            function stopBloodDrops() {
                clearInterval(bloodInterval);
                bloodInterval = null;
            }
            // BGM speed modulation
            function rampBGM() {
                if (typeof MusicSystem === 'undefined' || !MusicSystem.currentTrack) return;
                const track = MusicSystem.currentTrack;
                track.playbackRate = 0.7;
                const targetRate = 1.0;
                const step = 0.01;
                const interval = setInterval(() => {
                    if (track.playbackRate >= targetRate) {
                        clearInterval(interval);
                    } else {
                        track.playbackRate = Math.min(targetRate, track.playbackRate + step);
                    }
                }, 500);
            }
            // Hook into game start to ramp BGM
            if (typeof MusicSystem !== 'undefined') {
                MusicSystem.play = (function (orig) {
                    return function (name) {
                        orig.call(this, name);
                        if (name === 'start') rampBGM();
                    };
                })(MusicSystem.play);
            }
        });

        // =============================================
        // STORY SYSTEM - All Screen Narratives
        // =============================================
        const StorySystem = {
            stories: {
                title: [
                    { text: '"You wake up. Your head is pounding."', style: 'color:#ff4444; font-style:italic;' },
                    { text: '◉ The clock reads 60 SECONDS. It\'s counting down.', style: 'color:#ffffff;' },
                    { text: '◉ Your memories... they\'re bleeding away.', style: 'color:#ffffff; opacity:0.9;' },
                    { text: '◉ The only way out? REMEMBER. Answer correctly.', style: 'color:#ffffff; opacity:0.85;' },
                    { text: '◉ Each correct answer buys you time. Each mistake costs you.', style: 'color:#ffffff; opacity:0.8;' },
                    { text: '"Time is the only currency. And yours is running out."', style: 'color:#ff6666; font-weight:bold;' }
                ],
                fate: [
                    { text: '"The timeline fractures into three paths..."', style: 'color:#ff4444; font-style:italic;' },
                    { text: '◉ Your fate is not yours to choose.', style: 'color:#ffffff;' },
                    { text: '◉ The machine will decide.', style: 'color:#ffffff; opacity:0.9;' },
                    { text: '◉ OWN LUCK... TIME LOOP... or TIMELINE DUEL?', style: 'color:#ffffff; opacity:0.85;' },
                    { text: '"Spin the wheel. Accept your destiny."', style: 'color:#ff6666; font-weight:bold;' }
                ],
                timeline: [
                    { text: '"Two paths through time. Neither is safe."', style: 'color:#ff4444; font-style:italic;' },
                    { text: '◉ Forward through history as it happened...', style: 'color:#ffffff;' },
                    { text: '◉ Or backwards, unraveling memory itself?', style: 'color:#ffffff; opacity:0.9;' },
                    { text: '"Choose wisely. Time waits for no one."', style: 'color:#ff6666; font-weight:bold;' }
                ],
                roulette: [
                    { text: '"Searching the corrupted archives..."', style: 'color:#ff4444; font-style:italic;' },
                    { text: '◉ Fragments of knowledge swirl before you.', style: 'color:#ffffff;' },
                    { text: '"Accept your topic. Or risk a reroll."', style: 'color:#ff6666; font-weight:bold;' }
                ]
            },

            playedScreens: new Set(),

            async fadeFromDarkness() {
                const overlay = document.getElementById('darkness-overlay');
                if (overlay) {
                    overlay.style.opacity = '1';
                    await new Promise(r => setTimeout(r, 100));
                    overlay.classList.add('fade-out');
                    await new Promise(r => setTimeout(r, 1000));
                }
            },

            async playStory(screenId, storyKey, controlsId) {
                if (this.playedScreens.has(screenId)) return;
                this.playedScreens.add(screenId);

                const containerId = screenId + '-story-container';
                const story = this.stories[storyKey];
                if (!story) return;

                await TypeWriter.typeLines(containerId, story, 30);

                // Reveal controls after typing
                if (controlsId) {
                    const controls = document.getElementById(controlsId);
                    if (controls) {
                        await new Promise(r => setTimeout(r, 400));
                        controls.style.transition = 'opacity 0.5s ease';
                        controls.style.opacity = '1';
                        controls.style.pointerEvents = 'auto';
                    }
                }
            },

            reset() {
                this.playedScreens.clear();
            }
        };

        // CLICK TO START HANDLER
        document.getElementById('click-to-start').addEventListener('click', async function () {
            // Unlocks Audio Context immediately on interaction (Crucial for Chrome/Edge)
            if (typeof AudioSystem !== 'undefined') {
                if (!AudioSystem.ctx) AudioSystem.init();
                AudioSystem.resume();
            }

            // Start BGM (Intro)
            if (typeof MusicSystem !== 'undefined') MusicSystem.play('start');

            const startScreen = document.getElementById('click-to-start');
            startScreen.style.transition = 'opacity 0.8s ease';
            startScreen.style.opacity = '0';

            await new Promise(r => setTimeout(r, 800));
            startScreen.style.display = 'none';

            // Start the title screen story
            await StorySystem.playStory('title', 'title', 'init-btn');
        });

        // Hook into screen transitions
        const originalShowScreen = window.showScreen || function () { };
        window.showScreen = function (screenId) {
            originalShowScreen(screenId);

            // Trigger story for specific screens
            setTimeout(async () => {
                if (screenId === 's-luck') {
                    await StorySystem.playStory('fate', 'fate', 'luck-box-container');
                } else if (screenId === 's-timeline') {
                    await StorySystem.playStory('timeline', 'timeline', 'timeline-controls');
                } else if (screenId === 's-roulette') {
                    await StorySystem.playStory('roulette', 'roulette', 'roulette-actions');
                }
            }, 300);
        };
    </script>
    <style>
        /* +1 POP-UP */
        #score-pop-container {
            position: absolute;
            pointer-events: none;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .score-pop {
            position: absolute;
            font-size: 2rem;
            color: var(--green);
            animation: popFade 1s ease-out forwards;
        }

        @keyframes popFade {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-50px) scale(1.5);
            }
        }

        /* LEADERBOARD MODAL */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: var(--glass-bg);
            padding: 20px;
            border: var(--glass-border);
            border-radius: 8px;
            color: var(--text-main);
            min-width: 200px;
        }

        #leaderboard-list {
            list-style: decimal;
            margin-left: 20px;
        }

        /* DARK MODE TOGGLE */
        .theme-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--glass-bg);
            color: var(--text-main);
            border: var(--glass-border);
            padding: 5px 10px;
            cursor: pointer;
            z-index: 10001;
        }

        /* BLOOD DROP CONTAINER */
        #blood-drop-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 9994;
        }

        /* COIN LOGO ANIMATION */
        #coin-logo {
            width: 50px;
            animation: coinSpin 3s linear infinite;
        }

        @keyframes coinSpin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* REGISTER SCREEN STYLES */
        .register-box {
            background: rgba(10, 10, 15, 0.95);
            border: 2px solid var(--primary);
            box-shadow: 0 0 30px var(--primary), inset 0 0 50px rgba(0, 0, 0, 0.8);
            padding: 40px;
            width: 500px;
            max-width: 90vw;
            text-align: center;
            position: relative;
            clip-path: polygon(0 0, 100% 0, 100% 90%, 90% 100%, 0 100%);
        }

        .avatar-upload {
            width: 150px;
            height: 150px;
            border: 2px dashed var(--secondary);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            transition: all 0.3s;
        }

        .avatar-upload:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary);
        }

        .avatar-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .cyber-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--secondary);
            color: var(--primary);
            font-family: var(--f-mono);
            font-size: 1.5rem;
            padding: 10px;
            text-align: center;
            margin-bottom: 30px;
            outline: none;
            transition: all 0.3s;
        }

        .cyber-input:focus {
            border-color: var(--primary);
            box-shadow: 0 10px 20px -10px var(--primary);
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--primary);
            margin-right: 10px;
            object-fit: cover;
            vertical-align: middle;
        }

        .black-glow {
            text-shadow: 0 0 10px #000, 0 0 20px #000, 0 0 30px #000, 0 0 10px #000;
        }
    </style>
    <style>
        /* NEW LEADERBOARD STYLES */
        .cyber-terminal {
            background: rgba(10, 10, 15, 0.95);
            border: 2px solid var(--primary);
            box-shadow: 0 0 30px var(--primary), inset 0 0 20px rgba(0, 0, 0, 0.8);
            color: var(--primary);
            font-family: var(--f-mono);
            width: 400px;
            max-width: 90vw;
            padding: 0;
            /* Clear padding for custom layout */
            text-align: center;
            position: relative;
            overflow: hidden;
            clip-path: polygon(0 0, 100% 0, 100% 95%, 95% 100%, 0 100%);
        }

        .cyber-terminal::before {
            /* Scanline effect */
            content: "";
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.5) 4px);
            pointer-events: none;
            z-index: 1;
        }

        .terminal-header {
            background: var(--primary);
            color: #000;
            padding: 10px;
            font-family: var(--f-title);
            font-size: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-container {
            padding: 20px;
        }

        #leaderboard-list {
            list-style: none;
            margin: 0;
            padding: 0;
            font-family: var(--f-mono);
            text-align: left;
        }

        #leaderboard-list li {
            font-size: 1.2rem;
            padding: 15px 10px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #leaderboard-list li::before {
            content: ">";
            margin-right: 10px;
            color: var(--danger);
        }

        .mega-btn {
            width: 100%;
            padding: 20px;
            font-size: 1.5rem;
            font-family: var(--f-title);
            background: var(--danger);
            color: #fff;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s;
            position: relative;
            z-index: 2;
            /* Clickable above scanlines */
        }

        .mega-btn:hover {
            background: #fff;
            color: #000;
            box-shadow: 0 0 30px var(--danger);
        }
    </style>
    <script>
        // Feature functions for Neuro-Fried enhancements
        function showLeaderboard() {
            const scores = JSON.parse(localStorage.getItem('neuro_fried_scores') || '[]');
            const list = document.getElementById('leaderboard-list');
            if (list) {
                list.innerHTML = '';
                scores.slice(0, 3).forEach((s, i) => { const li = document.createElement('li'); li.textContent = `${i + 1}. ${s}`; list.appendChild(li); });
            }
            if (typeof achievementStats !== 'undefined' && typeof unlockAchievement !== 'undefined') {
                achievementStats.leaderboardOpenCount = (achievementStats.leaderboardOpenCount || 0) + 1;
                if (achievementStats.leaderboardOpenCount >= 3) unlockAchievement('social_butterfly'); // EXPANSION HOOK
            }
            document.getElementById('leaderboard-modal').classList.remove('hidden');
        }
        function saveScore(score) {
            const scores = JSON.parse(localStorage.getItem('neuro_fried_scores') || '[]');
            scores.push(score);
            scores.sort((a, b) => b - a);
            localStorage.setItem('neuro_fried_scores', JSON.stringify(scores));
        }
        function toggleTheme() {
            const html = document.documentElement;
            const cur = html.getAttribute('data-theme') || 'dark';
            html.setAttribute('data-theme', cur === 'dark' ? 'light' : 'dark');

            if (typeof achievementStats !== 'undefined' && typeof unlockAchievement !== 'undefined') {
                achievementStats.themeToggleCount = (achievementStats.themeToggleCount || 0) + 1;
                if (achievementStats.themeToggleCount >= 5) unlockAchievement('void_gazer'); // EXPANSION HOOK
            }
        }
        function spawnBloodDrop() {
            const container = document.getElementById('blood-drop-container');
            if (!container) return;
            const drop = document.createElement('div');
            drop.style.position = 'fixed';
            drop.style.width = '4px';
            drop.style.height = '10px';
            drop.style.background = 'rgba(139,0,0,0.7)';
            drop.style.left = Math.random() * window.innerWidth + 'px';
            drop.style.top = '-20px';
            drop.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';
            container.appendChild(drop);
            const dur = 2000 + Math.random() * 1000;
            drop.animate([{ transform: `translateY(${window.innerHeight + 20}px)` }, { opacity: 0 }], { duration: dur, easing: 'ease-out' });
            setTimeout(() => drop.remove(), dur);
        }
        let bloodInterval = null;
        function startBloodDrops() { if (bloodInterval) return; bloodInterval = setInterval(spawnBloodDrop, 300); }
        function stopBloodDrops() { clearInterval(bloodInterval); bloodInterval = null; }
        function rampBGM() {
            if (!MusicSystem || !MusicSystem.currentTrack) return;
            const track = MusicSystem.currentTrack;
            track.playbackRate = 0.7;
            const target = 1.0; const step = 0.01;
            const int = setInterval(() => { if (track.playbackRate >= target) { clearInterval(int); } else { track.playbackRate = Math.min(target, track.playbackRate + step); } }, 500);
        }
        if (typeof MusicSystem !== 'undefined') {
            const origPlay = MusicSystem.play;
            MusicSystem.play = function (name) { origPlay.call(this, name); if (name === 'start') rampBGM(); };
        }
        // Attach theme toggle button
        const themeBtn = document.getElementById('theme-toggle-btn');
        if (themeBtn) {
            themeBtn.addEventListener('click', toggleTheme);
        }

        // Start blood drops when game starts (if Game.start exists)
        if (typeof Game !== 'undefined' && Game.start) {
            const originalStart = Game.start;
            Game.start = function () {
                originalStart.call(this);
                startBloodDrops();
            };
        }

        // Function to show +1 pop-up at given coordinates
        function showScorePop(x, y) {
            const container = document.getElementById('score-pop-container');
            if (!container) return;
            const pop = document.createElement('div');
            pop.className = 'score-pop';
            pop.textContent = '+1';
            pop.style.left = x + 'px';
            pop.style.top = y + 'px';
            container.appendChild(pop);
            setTimeout(() => pop.remove(), 1000);
        }
    </script>
    <!-- +1 pop-up container -->
    <div id="score-pop-container"></div>

    <script>
        // --- PLAYER PROFILE SYSTEM ---
        const UserProfile = {
            name: "UNKNOWN",
            photo: null,
            registered: false
        };

        function registerAndStart() {
            const nameInput = document.getElementById('reg-name');
            const name = nameInput.value.toUpperCase().trim() || "AGENT";

            UserProfile.name = name;
            UserProfile.registered = true;

            if (typeof unlockAchievement !== 'undefined') unlockAchievement('identity_verified'); // EXPANSION HOOK

            // Photo is already set by previewAvatar helper

            // Save to LocalStorage for persistence
            localStorage.setItem('neuro_fried_last_user', JSON.stringify({ name: UserProfile.name, photo: UserProfile.photo }));

            // Update UI elements immediately
            updateIdentityDisplays();

            // Hide Register Screen -> Show Luck Screen (Game Start)
            // Hide Register Screen -> Show Luck Screen (Game Start)
            const regScreen = document.getElementById('s-register');
            regScreen.classList.add('hidden');
            regScreen.classList.remove('active');

            const luckScreen = document.getElementById('s-luck');
            luckScreen.classList.remove('hidden');
            luckScreen.classList.add('active');

            // Continue start sequence
            if (typeof StorySystem !== 'undefined') StorySystem.playStory('fate', 'fate', 'luck-box-container');
        }

        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('reg-preview');
                    const text = document.getElementById('reg-upload-text');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    text.style.display = 'none';
                    UserProfile.photo = e.target.result; // Store base64
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateIdentityDisplays() {
            // Update "Agent Card" on Game Over screen
            const finalName = document.getElementById('final-name');
            const cardImg = document.getElementById('card-img');

            if (finalName) finalName.textContent = UserProfile.name;
            if (cardImg && UserProfile.photo) {
                cardImg.src = UserProfile.photo;
                cardImg.style.filter = "none"; // Remove grayscale
                cardImg.style.opacity = "1";
            }
        }

        // Intercept Game Start
        // We look for the "INITIALIZE SYSTEM" button click or similar start trigger
        // Actually, Game.startSequence is called. Let's override it or the transition to it.
        // It seems Game.startSequence switches to 's-luck'. We will intercept that.

        if (typeof Game !== 'undefined') {
            const originalStartSequence = Game.startSequence;
            Game.startSequence = function () {
                // Check if already registered in this session? 
                // User asked to add options "when the start off the game".
                // So we always show register screen first.

                // NEW ACHIEVEMENT TRACKING
                if (typeof achievementStats !== 'undefined') {
                    achievementStats.gamesPlayed++;
                    if (currentGameMode) achievementStats.modesPlayed.add(currentGameMode);

                    if (achievementStats.gamesPlayed >= 5) unlockAchievement('veteran');
                    if (achievementStats.modesPlayed.size >= 3) unlockAchievement('mode_traveler');
                }

                // Initialize Audio
                try {
                    if (typeof AudioSystem !== 'undefined') { AudioSystem.init(); AudioSystem.resume(); }
                    if (typeof MusicSystem !== 'undefined') MusicSystem.play('start');
                } catch (e) { }

                gameInProgress = true;
                LuckSystem.reset();
                if (typeof StorySystem !== 'undefined') StorySystem.reset();

                // SHOW REGISTER SCREEN INSTEAD OF LUCK
                // Hide Title
                document.getElementById('s-title').classList.add('hidden');
                document.getElementById('s-title').classList.remove('active');

                // Show Register
                const regScreen = document.getElementById('s-register');
                regScreen.classList.remove('hidden');
                regScreen.classList.add('active');

                // Pre-fill if exists
                try {
                    const saved = JSON.parse(localStorage.getItem('neuro_fried_last_user'));
                    if (saved) {
                        if (saved.name) document.getElementById('reg-name').value = saved.name;
                        if (saved.photo) {
                            UserProfile.photo = saved.photo;
                            const preview = document.getElementById('reg-preview');
                            const text = document.getElementById('reg-upload-text');
                            preview.src = saved.photo;
                            preview.style.display = 'block';
                            text.style.display = 'none';
                        }
                    }
                } catch (e) { }
            };
        }

        // OVERRIDE SHOW LEADERBOARD TO INCLUDE PHOTO
        const originalShowLeaderboard = showLeaderboard;
        showLeaderboard = function () { // Override global function
            const scores = JSON.parse(localStorage.getItem('neuro_fried_scores_v2') || '[]');
            const list = document.getElementById('leaderboard-list');
            if (list) {
                list.innerHTML = '';
                scores.slice(0, 5).forEach((item, i) => { // Top 5
                    const li = document.createElement('li');

                    let photoHtml = '';
                    if (item.photo) {
                        photoHtml = `<img src="${item.photo}" class="leaderboard-avatar">`;
                    } else {
                        photoHtml = `<div class="leaderboard-avatar" style="background:#333; display:inline-block;"></div>`;
                    }

                    li.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            ${photoHtml}
                            <span>${item.name || 'UNKNOWN'}</span>
                        </div>
                        <span>${item.score}</span>
                    `;
                    list.appendChild(li);
                });
            }
            document.getElementById('leaderboard-modal').classList.remove('hidden');
        };

        // OVERRIDE SAVE SCORE TO INCLUDE PROFILE
        saveScore = function (score) {
            const scores = JSON.parse(localStorage.getItem('neuro_fried_scores_v2') || '[]');
            scores.push({
                score: parseInt(score),
                name: UserProfile.name,
                photo: UserProfile.photo
            });
            scores.sort((a, b) => b.score - a.score);
            localStorage.setItem('neuro_fried_scores_v2', JSON.stringify(scores));
        };

        // Ensure UI is updated on load if persisted
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const saved = JSON.parse(localStorage.getItem('neuro_fried_last_user'));
                if (saved) {
                    UserProfile.name = saved.name;
                    UserProfile.photo = saved.photo;
                    updateIdentityDisplays();
                }
            } catch (e) { }

            // Initialize Achievements
            loadAchievements();
        });

        /* =============================================
           ACHIEVEMENT SYSTEM - No Backend Required
           ============================================= */

        const ACHIEVEMENTS = {
            // LEVEL 1: COMMON (Bronze)
            first_blood: { id: 'first_blood', icon: '🩸', name: 'FIRST BLOOD', desc: 'Get your first correct answer', unlocked: false, tier: 'common' },
            time_lord: { id: 'time_lord', icon: '❄️', name: 'TIME LORD', desc: 'Use the Freeze ability', unlocked: false, tier: 'common' },
            temporal_paradox: { id: 'temporal_paradox', icon: '⏪', name: 'TEMPORAL PARADOX', desc: 'Use the Rewind ability', unlocked: false, tier: 'common' },
            identity_verified: { id: 'identity_verified', icon: '🆔', name: 'IDENTITY VERIFIED', desc: 'Register a Full Profile', unlocked: false, tier: 'common' },
            social_butterfly: { id: 'social_butterfly', icon: '🦋', name: 'SOCIAL BUTTERFLY', desc: 'Open the Leaderboard 3 times', unlocked: false, tier: 'common' },

            // LEVEL 2: RARE (Silver)
            hot_streak: { id: 'hot_streak', icon: '🔥', name: 'HOT STREAK', desc: 'Get 5 correct answers in a row', unlocked: false, tier: 'rare' },
            survivor: { id: 'survivor', icon: '🚑', name: 'SURVIVOR', desc: 'Win with less than 5 seconds left', unlocked: false, tier: 'rare' },
            risk_taker: { id: 'risk_taker', icon: '🎲', name: 'RISK TAKER', desc: 'Win after using Rewind 3+ times', unlocked: false, tier: 'rare' },
            void_gazer: { id: 'void_gazer', icon: '⚫', name: 'VOID GAZER', desc: 'Stare into the abyss (Toggle Theme 5x)', unlocked: false, tier: 'rare' },
            nocturnal: { id: 'nocturnal', icon: '🌑', name: 'NOCTURNAL', desc: 'Survive the Night Phase', unlocked: false, tier: 'rare' },

            // LEVEL 3: EPIC (Red/Dark)
            unstoppable: { id: 'unstoppable', icon: '🚀', name: 'UNSTOPPABLE', desc: 'Get 10 correct answers in a row', unlocked: false, tier: 'epic' },
            comeback_king: { id: 'comeback_king', icon: '👑', name: 'COMEBACK KING', desc: 'Win after time dropped below 10s', unlocked: false, tier: 'epic' },
            chrono_master: { id: 'chrono_master', icon: '⏳', name: 'CHRONO MASTER', desc: 'Use both Freeze and Rewind in one game', unlocked: false, tier: 'epic' },
            speed_demon: { id: 'speed_demon', icon: '⚡', name: 'SPEED DEMON', desc: 'Win with more than 30 seconds left', unlocked: false, tier: 'epic' },
            system_overload: { id: 'system_overload', icon: '👾', name: 'SYSTEM OVERLOAD', desc: 'You shouldn\'t be here', unlocked: false, tier: 'epic' },

            // LEGENDARY (Shining)
            neural_sync: { id: 'neural_sync', icon: '🧠', name: 'NEURAL SYNC', desc: 'Complete all questions and win', unlocked: false, tier: 'legendary' },
            perfect_mind: { id: 'perfect_mind', icon: '💎', name: 'PERFECT MIND', desc: 'Win with 0 wrong answers', unlocked: false, tier: 'legendary' },
            timeline_purist: { id: 'timeline_purist', icon: '⚔️', name: 'TIMELINE PURIST', desc: 'Win without using ANY Powers', unlocked: false, tier: 'legendary' },

            // NEW EXPANSION V2
            warp_speed: { id: 'warp_speed', icon: '⏩', name: 'WARP SPEED', desc: 'Reach 2x Score Multiplier', unlocked: false, tier: 'common' },
            ice_breaker: { id: 'ice_breaker', icon: '🌡️', name: 'THERMAL DYNAMICS', desc: 'Win without ever freezing time', unlocked: false, tier: 'rare' },
            no_looking_back: { id: 'no_looking_back', icon: '🚫', name: 'FORWARD MARCH', desc: 'Win without ever rewinding', unlocked: false, tier: 'rare' },
            mode_traveler: { id: 'mode_traveler', icon: '🗺️', name: 'DIMENSION HOPPER', desc: 'Play all 3 gamemodes in one session', unlocked: false, tier: 'rare' },
            veteran: { id: 'veteran', icon: '🎖️', name: 'VET', desc: 'Play 5 games in one session', unlocked: false, tier: 'epic' }
        };

        // Track game stats for achievements
        let achievementStats = {
            correctAnswers: 0,
            wrongAnswers: 0,
            currentStreak: 0,
            maxStreak: 0,
            freezeUsed: false,
            rewindUsed: false,
            rewindCount: 0,
            droppedBelow10: false,
            lowestTime: 60,
            // New stats
            themeToggleCount: 0,
            modesPlayed: new Set(),
            gamesPlayed: 0
            leaderboardOpenCount: 0,
            titleClickCount: 0
        };

        function loadAchievements() {
            const saved = localStorage.getItem('neurofried_achievements');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.keys(parsed).forEach(key => {
                    if (ACHIEVEMENTS[key]) ACHIEVEMENTS[key].unlocked = parsed[key];
                });
            }
            updateAchievementCount();
        }

        function saveAchievements() {
            const toSave = {};
            Object.keys(ACHIEVEMENTS).forEach(key => {
                toSave[key] = ACHIEVEMENTS[key].unlocked;
            });
            localStorage.setItem('neurofried_achievements', JSON.stringify(toSave));
        }

        function unlockAchievement(id) {
            if (!ACHIEVEMENTS[id] || ACHIEVEMENTS[id].unlocked) return;

            ACHIEVEMENTS[id].unlocked = true;
            saveAchievements();
            showAchievementPopup(ACHIEVEMENTS[id]);
            updateAchievementCount();
            if (typeof AudioSystem !== 'undefined') AudioSystem.playBtnHover(); // Reuse hover sound as placeholder
            console.log("UNLOCKED: " + id);
        }

        function showAchievementPopup(achievement) {
            const popup = document.getElementById('achievement-popup');
            document.getElementById('ach-popup-icon').textContent = achievement.icon;
            document.getElementById('ach-popup-name').textContent = achievement.name;
            document.getElementById('ach-popup-desc').textContent = achievement.desc;

            popup.classList.add('show');
            document.body.classList.add('glitch-active');
            setTimeout(() => document.body.classList.remove('glitch-active'), 300);

            // Allow multiple popups by resetting timer if needed (simple implementation)
            setTimeout(() => popup.classList.remove('show'), 4000);
        }

        function updateAchievementCount() {
            const total = Object.keys(ACHIEVEMENTS).length;
            const unlocked = Object.values(ACHIEVEMENTS).filter(a => a.unlocked).length;

            const countEl = document.getElementById('ach-count');
            const progressEl = document.getElementById('ach-progress');

            if (countEl) countEl.textContent = `${unlocked}/${total}`;
            if (progressEl) progressEl.textContent = `${unlocked} of ${total} achievements unlocked`;
        }

        // ... helper to get tier name for display
        function getTierLabel(tier) {
            switch (tier) {
                case 'common': return 'LVL 1 - COMMON';
                case 'rare': return 'LVL 2 - RARE';
                case 'epic': return 'LVL 3 - EPIC';
                case 'legendary': return 'LEGENDARY';
                default: return '';
            }
        }

        window.openAchievements = function () { // Expose globally
            const modal = document.getElementById('ach-modal');
            const grid = document.getElementById('ach-grid');

            if (!modal || !grid) return;

            // Define Tier Order & Headers
            const tiers = ['common', 'rare', 'epic', 'legendary'];
            const tierNames = {
                'common': 'LEVEL 1 - COMMON',
                'rare': 'LEVEL 2 - RARE',
                'epic': 'LEVEL 3 - EPIC',
                'legendary': 'LEGENDARY'
            };

            let html = '';

            tiers.forEach(tier => {
                // Filter achievements for this tier
                const tierAchs = Object.values(ACHIEVEMENTS).filter(a => (a.tier || 'common') === tier);

                if (tierAchs.length > 0) {
                    // Add Section Header
                    html += `<h3 class="tier-header tier-${tier}">${tierNames[tier]}</h3>`;

                    // Add Grid for this section works better if we don't nest grids, 
                    // or we wrap them. Let's just output cards and rely on CSS or add a wrapper.
                    // The current CSS might expect a grid container. 
                    // Let's create a sub-grid or just let them flow if the main grid is flex/grid.
                    // If #ach-grid is display:grid, headers effectively break the row flow if not handled.
                    // Better approach: Use a wrapper div for the grid of cards for THIS tier.

                    html += `<div class="ach-tier-group">`;

                    tierAchs.forEach(ach => {
                        const tierLabel = getTierLabel(ach.tier || 'common');
                        html += `
                            <div class="ach-card ${ach.unlocked ? 'unlocked' : 'locked'} tier-${tier}">
                                <span class="ach-card-icon">${ach.unlocked ? ach.icon : '🔒'}</span>
                                <div class="ach-card-info">
                                    <div style="font-size:0.7rem; color:var(--text-dim); margin-bottom:2px; letter-spacing:1px;">${ach.unlocked ? tierLabel : 'LOCKED'}</div>
                                    <div class="ach-card-name">${ach.unlocked ? ach.name : '??? '}</div>
                                    <div class="ach-card-desc">${ach.unlocked ? ach.desc : 'Keep playing to unlock'}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div>`; // End group
                }
            });

            grid.innerHTML = html;
            modal.classList.add('show');
        };

        window.closeAchievements = function () {
            document.getElementById('ach-modal').classList.remove('show');
        };

        function resetAchievementStats() {
            // Preserve session-based stats
            const sessionModes = achievementStats.modesPlayed || new Set();
            const sessionGames = achievementStats.gamesPlayed || 0;
            const sessionThemes = achievementStats.themeToggleCount || 0;
            const sessionClicks = achievementStats.titleClickCount || 0;
            const sessionLeaderboard = achievementStats.leaderboardOpenCount || 0;

            achievementStats = {
                correctAnswers: 0,
                wrongAnswers: 0,
                currentStreak: 0,
                maxStreak: 0,
                freezeUsed: false,
                rewindUsed: false,
                rewindCount: 0,
                droppedBelow10: false,
                lowestTime: 60,
                // Restore session stats
                modesPlayed: sessionModes,
                gamesPlayed: sessionGames,
                themeToggleCount: sessionThemes,
                titleClickCount: sessionClicks,
                leaderboardOpenCount: sessionLeaderboard
            };
        }

        // HOOKS
        function onCorrectAnswer() {
            achievementStats.correctAnswers++;
            achievementStats.currentStreak++;
            achievementStats.maxStreak = Math.max(achievementStats.maxStreak, achievementStats.currentStreak);

            if (achievementStats.correctAnswers === 1) unlockAchievement('first_blood');
            if (achievementStats.currentStreak >= 5) unlockAchievement('hot_streak');
            if (achievementStats.currentStreak >= 10) unlockAchievement('unstoppable');

            // WARP SPEED check
            if (Game.multiplier >= 2) unlockAchievement('warp_speed');
        }

        function onWrongAnswer() {
            achievementStats.wrongAnswers++;
            achievementStats.currentStreak = 0;
        }

        function onFreezeUsed() {
            achievementStats.freezeUsed = true;
            unlockAchievement('time_lord');
            if (achievementStats.freezeUsed && achievementStats.rewindUsed) unlockAchievement('chrono_master');
        }

        function onRewindUsed() {
            achievementStats.rewindUsed = true;
            achievementStats.rewindCount++;
            unlockAchievement('temporal_paradox');
            if (achievementStats.freezeUsed && achievementStats.rewindUsed) unlockAchievement('chrono_master');
        }

        function onTimerUpdateAC(currentTime) {
            achievementStats.lowestTime = Math.min(achievementStats.lowestTime, currentTime);
            if (currentTime < 10) achievementStats.droppedBelow10 = true;
        }

        function onGameWinAC(finalTime) {
            unlockAchievement('neural_sync');
            if (finalTime <= 5) unlockAchievement('survivor');
            if (finalTime >= 30) unlockAchievement('speed_demon');
            if (achievementStats.wrongAnswers === 0) unlockAchievement('perfect_mind');
            if (achievementStats.rewindCount >= 3) unlockAchievement('risk_taker');
            if (achievementStats.droppedBelow10) unlockAchievement('comeback_king');

            // EXPANSION HOOKS
            if (!achievementStats.freezeUsed && !achievementStats.rewindUsed) unlockAchievement('timeline_purist');

            // NEW EXPANSION V2 HOOKS
            if (!achievementStats.freezeUsed) unlockAchievement('ice_breaker');
            if (!achievementStats.rewindUsed) unlockAchievement('no_looking_back');

            // Check Nocturnal (Check DuelMode or Game state)
            const nightTriggered = (typeof DuelMode !== 'undefined' && DuelMode.nightTriggered) || (typeof Game !== 'undefined' && Game.nightTriggered);
            if (nightTriggered) unlockAchievement('nocturnal');
        }

        // System Overload Click Handler
        function handleTitleClick() {
            achievementStats.titleClickCount = (achievementStats.titleClickCount || 0) + 1;
            if (achievementStats.titleClickCount >= 10) unlockAchievement('system_overload');
        }

    </script>

    <!-- Leaderboard modal -->
    <div id="leaderboard-modal" class="modal hidden">
        <div class="modal-content cyber-terminal">
            <div class="terminal-header">
                <span>/// SYSTEM_ARCHIVE</span>
                <span class="blink">LIVE</span>
            </div>
            <div class="leaderboard-container">
                <ol id="leaderboard-list"></ol>
            </div>
            <button id="close-leaderboard" class="mega-btn">CLOSE DATABASE</button>
        </div>
    </div>

    <!-- Dark mode toggle -->
    <button id="theme-toggle-btn" class="theme-toggle">Toggle Dark Mode</button>

    <!-- Blood drops container -->
    <div id="blood-drop-container"></div>

    <!-- Coin logo in header -->
    <header id="game-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="coin.png" alt="Coin Logo" id="coin-logo" class="coin-spin">
            <div style="display: flex; flex-direction: column;">
                <h1 class="black-glow" onclick="if(typeof handleTitleClick === 'function') handleTitleClick()"
                    style="font-family: var(--f-title); font-size: 2rem; color: var(--primary); margin: 0; line-height: 1; cursor: pointer;">
                    NEUROFRIED</h1>
                <span style="font-family: var(--f-mono); font-size: 0.8rem; color: #888;">dev: kaustav chowdhury</span>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <button onclick="showLeaderboard()"
                style="background:none; border:none; font-size:1.5rem; cursor:pointer;">🏆</button>
            <button id="theme-toggle-btn" class="theme-toggle" aria-label="Toggle Dark Mode">🌙</button>
        </div>
    </header>
    <!-- ACHIEVEMENT SYSTEM -->
    <style>
        /* =============================================
           ACHIEVEMENT SYSTEM - Horror Themed
           ============================================= */

        /* Achievement Notification Popup */
        .achievement-popup {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 100001;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 0 30px var(--primary), inset 0 0 20px rgba(255, 0, 0, 0.1);
        }

        .achievement-popup.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .achievement-popup .ach-icon {
            font-size: 2.5rem;
            animation: achievePulse 0.5s ease-out;
        }

        .achievement-popup .ach-info {
            display: flex;
            flex-direction: column;
        }

        .achievement-popup .ach-title {
            font-family: var(--f-title);
            font-size: 0.75rem;
            color: var(--primary);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .achievement-popup .ach-name {
            font-family: var(--f-title);
            font-size: 1.1rem;
            color: #fff;
            margin-top: 2px;
        }

        .achievement-popup .ach-desc {
            font-family: var(--f-mono);
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        @keyframes achievePulse {
            0% {
                transform: scale(0) rotate(-180deg);
            }

            50% {
                transform: scale(1.3) rotate(10deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        /* Achievement Gallery Button */
        .ach-gallery-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--primary);
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 9999;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ach-gallery-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--primary);
            background: var(--primary);
            color: #000;
        }

        .ach-gallery-btn .ach-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: #fff;
            font-size: 0.7rem;
            font-family: var(--f-title);
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Achievement Gallery Modal */
        .ach-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100002;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .ach-modal.show {
            display: flex;
        }

        .ach-modal-content {
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.3);
        }

        .ach-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 0, 0, 0.3);
        }

        .ach-modal-title {
            font-family: var(--f-title);
            font-size: 1.5rem;
            color: var(--primary);
            letter-spacing: 3px;
        }

        .ach-modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .ach-modal-close:hover {
            color: var(--danger);
        }

        .ach-progress-text {
            font-family: var(--f-mono);
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .ach-grid {
            /* Changed to flex column for sectioned layout */
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding-bottom: 20px;
        }

        .ach-tier-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .tier-header {
            font-family: var(--f-title);
            font-size: 1.2rem;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Tier Header Colors */
        .tier-header.tier-common {
            color: #cd7f32;
            border-color: #cd7f32;
            text-shadow: 0 0 10px rgba(205, 127, 50, 0.5);
        }

        .tier-header.tier-rare {
            color: #00f3ff;
            border-color: #00f3ff;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        .tier-header.tier-epic {
            color: #ff003c;
            border-color: #ff003c;
            text-shadow: 0 0 10px rgba(255, 0, 60, 0.5);
        }

        .tier-header.tier-legendary {
            color: #ffd700;
            border-color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }

        /* Mobile adjust */
        @media (max-width: 600px) {
            .ach-tier-group {
                grid-template-columns: 1fr;
            }
        }


        .ach-card {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(100, 100, 100, 0.3);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            opacity: 0.4;
            filter: grayscale(100%);
        }

        .ach-card.unlocked {
            opacity: 1;
            filter: grayscale(0%);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.2);
        }

        .ach-card .ach-card-icon {
            font-size: 2rem;
            min-width: 50px;
            text-align: center;
        }

        .ach-card .ach-card-info {
            flex: 1;
        }

        .ach-card .ach-card-name {
            font-family: var(--f-title);
            font-size: 0.9rem;
            color: #fff;
            margin-bottom: 4px;
        }

        .ach-card .ach-card-desc {
            font-family: var(--f-mono);
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .ach-card.locked .ach-card-icon {
            filter: blur(2px);
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            .ach-modal-content {
                padding: 20px;
            }

            .ach-grid {
                grid-template-columns: 1fr;
            }

            .achievement-popup {
                width: 90%;
                padding: 12px 15px;
            }

            .achievement-popup .ach-icon {
                font-size: 2rem;
            }
        }
    </style>

    <!-- Achievement Notification Popup -->
    <div class="achievement-popup" id="achievement-popup">
        <span class="ach-icon" id="ach-popup-icon">🏆</span>
        <div class="ach-info">
            <span class="ach-title">ACHIEVEMENT UNLOCKED</span>
            <span class="ach-name" id="ach-popup-name">First Blood</span>
            <span class="ach-desc" id="ach-popup-desc">Answer your first question correctly</span>
        </div>
    </div>

    <!-- Achievement Gallery Button -->
    <button class="ach-gallery-btn" id="ach-gallery-btn" onclick="openAchievements()">
        🏆
        <span class="ach-count" id="ach-count">0/12</span>
    </button>

    <!-- Achievement Gallery Modal -->
    <div class="ach-modal" id="ach-modal">
        <div class="ach-modal-content">
            <div class="ach-modal-header">
                <h2 class="ach-modal-title">⚡ NEURAL ACHIEVEMENTS ⚡</h2>
                <button class="ach-modal-close" onclick="closeAchievements()">×</button>
            </div>
            <p class="ach-progress-text" id="ach-progress">0 of 12 achievements unlocked</p>
            <div class="ach-grid" id="ach-grid">
                <!-- Achievements populated by JS -->
            </div>
        </div>
    </div>
</body>

</html>
```